"use strict";var O=Object.create;var E=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var R=Object.getPrototypeOf,I=Object.prototype.hasOwnProperty;var U=(e,o,n,r)=>{if(o&&typeof o=="object"||typeof o=="function")for(let a of K(o))!I.call(e,a)&&a!==n&&E(e,a,{get:()=>o[a],enumerable:!(r=A(o,a))||r.enumerable});return e};var F=(e,o,n)=>(n=e!=null?O(R(e)):{},U(o||!e||!e.__esModule?E(n,"default",{value:e,enumerable:!0}):n,e));const s=require("./utils/authRedirect.js");function y(){try{return console.log("[auth][immediate] Setting up immediate cross-subdomain authentication..."),s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE]),h().catch(e=>{console.log("[auth][immediate] Auth state listener setup deferred:",e.message)}),console.log("[auth][immediate] Immediate cross-subdomain authentication setup completed"),!0}catch(e){return console.error("[auth][immediate] Error during immediate cross-subdomain authentication setup:",e),!1}}async function D(){try{console.log("[auth][init] Starting cross-subdomain authentication initialization..."),s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE]),h();const e=await C(10,200);return e.success?(console.log("[auth][init] Cross-subdomain authentication initialized successfully"),{success:!0,session:e.session}):(console.log("[auth][init] Cross-subdomain authentication initialization completed (no active session)"),{success:!1,error:e.error})}catch(e){return console.error("[auth][init] Error during cross-subdomain authentication initialization:",e),{success:!1,error:e}}}async function T(){try{s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE]);const e=s.getCookie(s.ACCESS_COOKIE),o=s.getCookie(s.REFRESH_COOKIE);if(e&&o){const n=await d(),{data:{session:r}}=await n.auth.getSession();if(!r){const{data:a,error:u}=await n.auth.setSession({access_token:e,refresh_token:o});u?console.log("[auth][restore] error",u):console.log("[auth][restore] done",!!a.session)}}else console.log("[auth][restore] no cookies present");s.syncCookiesToLocalStorage()}catch(e){console.log("[auth][restore] exception",e)}}let b=!1;async function h(){if(b){console.log("[auth][listener] Auth state listener already set up, skipping...");return}console.log("[auth][listener] Setting up auth state listener...");try{(await d()).auth.onAuthStateChange(async(o,n)=>{switch(console.log("[auth][listener] Auth state changed:",o,!!n),o){case"TOKEN_REFRESHED":console.log("[auth][listener] Token refreshed successfully"),n&&(s.setSessionCookie(s.ACCESS_COOKIE,n.access_token,60*60*24*365),s.setSessionCookie(s.REFRESH_COOKIE,n.refresh_token,60*60*24*365),s.syncCookiesToLocalStorage());break;case"SIGNED_IN":console.log("[auth][listener] User signed in"),n&&(s.setSessionCookie(s.ACCESS_COOKIE,n.access_token,60*60*24*365),s.setSessionCookie(s.REFRESH_COOKIE,n.refresh_token,60*60*24*365),s.syncCookiesToLocalStorage());break;case"SIGNED_OUT":console.log("[auth][listener] User signed out"),typeof window<"u"&&window.dispatchEvent(new CustomEvent("session-logout-detected",{detail:{timestamp:new Date}}));break;case"USER_UPDATED":console.log("[auth][listener] User updated");break;default:console.log("[auth][listener] Unhandled auth event:",o)}}),b=!0,console.log("[auth][listener] Auth state listener set up successfully")}catch(e){console.warn("[auth][listener] Failed to setup auth state listener:",e),e.message&&e.message.includes("Missing configuration")&&(console.log("[auth][listener] Supabase not configured yet, will retry when configured"),b=!1)}}async function C(e=10,o=200){console.log("[auth][restore] Starting enhanced session restoration...");for(let n=1;n<=e;n++)try{try{const i=await d(),{data:{session:S},error:f}=await i.auth.getSession();if(S&&S.user)return console.log("[auth][restore] Active session found on attempt",n),{success:!0,session:S};if(f&&f.message&&f.message.includes("Missing configuration"))return console.log("[auth][restore] Supabase not configured yet, skipping restoration"),{success:!1,error:"Supabase not configured"}}catch(i){console.warn("[auth][restore] Error checking existing session:",i)}s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE]);const r=s.getCookie(s.ACCESS_COOKIE),a=s.getCookie(s.REFRESH_COOKIE);if(!r||!a)if(console.log(`[auth][restore] Attempt ${n}: Missing cookies (Access: ${!!r}, Refresh: ${!!a})`),n<e){await new Promise(i=>setTimeout(i,o*n));continue}else return{success:!1,error:"No cookies found after retries"};console.log(`[auth][restore] Attempt ${n}: Restoring from cookies...`);const u=await d(),{data:c,error:p}=await u.auth.setSession({access_token:r,refresh_token:a});if(c.session&&c.session.user)return console.log("[auth][restore] Session restored successfully!"),s.setSessionCookie(s.ACCESS_COOKIE,c.session.access_token),s.setSessionCookie(s.REFRESH_COOKIE,c.session.refresh_token),s.syncCookiesToLocalStorage(),{success:!0,session:c.session};if(p&&(console.warn(`[auth][restore] Attempt ${n} failed: ${p.message}`),n===e))return{success:!1,error:p};await new Promise(i=>setTimeout(i,o))}catch(r){if(console.error(`[auth][restore] Attempt ${n} unexpected error:`,r),n===e)return{success:!1,error:r};await new Promise(a=>setTimeout(a,o))}return{success:!1,error:"Max retries exceeded"}}function _(){try{return console.log("[auth][domain-change] Handling domain change authentication..."),s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE]),h().catch(e=>{console.log("[auth][domain-change] Auth state listener setup deferred:",e.message)}),C(7,25).then(e=>{e.success?console.log("[auth][domain-change] Domain change authentication successful"):console.log("[auth][domain-change] Domain change authentication failed:",e.error)}).catch(e=>{console.error("[auth][domain-change] Domain change authentication error:",e)}),console.log("[auth][domain-change] Domain change authentication setup completed"),!0}catch(e){return console.error("[auth][domain-change] Error during domain change authentication setup:",e),!1}}async function w(){var e;try{const{createClient:o}=await import("@supabase/supabase-js");return console.log("[Supabase] Successfully imported @supabase/supabase-js"),o}catch(o){console.warn("[Supabase] Failed to import @supabase/supabase-js:",o)}if(typeof window<"u"){if((e=window.supabase)!=null&&e.createClient)return console.log("[Supabase] Using global Supabase client"),window.supabase.createClient;if(window.createClient)return console.log("[Supabase] Using global createClient function"),window.createClient}try{if(typeof require<"u"){const{createClient:o}=require("@supabase/supabase-js");return console.log("[Supabase] Successfully required @supabase/supabase-js"),o}}catch(o){console.warn("[Supabase] Failed to require @supabase/supabase-js:",o)}return console.error("[Supabase] No Supabase client available, using mock with error handling"),(o,n,r)=>(console.warn("[Supabase] Using mock client - Supabase not properly configured"),{auth:{getSession:async()=>(console.warn("[Supabase] Mock getSession called - returning null session"),{data:{session:null},error:null}),setSession:async a=>(console.warn("[Supabase] Mock setSession called - returning null session"),{data:{session:null},error:null}),signOut:async()=>(console.warn("[Supabase] Mock signOut called"),{error:null}),signInWithPassword:async a=>(console.warn("[Supabase] Mock signInWithPassword called"),{data:{session:null,user:null},error:{message:"Supabase not configured"}}),signUp:async a=>(console.warn("[Supabase] Mock signUp called"),{data:{session:null,user:null},error:{message:"Supabase not configured"}}),signInWithOAuth:async a=>(console.warn("[Supabase] Mock signInWithOAuth called"),{data:{session:null,user:null},error:{message:"Supabase not configured"}}),resetPasswordForEmail:async(a,u)=>(console.warn("[Supabase] Mock resetPasswordForEmail called"),{data:{},error:{message:"Supabase not configured"}}),onAuthStateChange:a=>(console.warn("[Supabase] Mock onAuthStateChange called"),{data:{subscription:{unsubscribe:()=>{}}}})}})}let m=null;function P(e){m=e,console.log("[Supabase] Configuration set by consuming app"),l||k()}function g(){if(m)return m;if(typeof window<"u"){const e=window.__SUPABASE_URL__,o=window.__SUPABASE_ANON_KEY__;if(e&&o)return{url:e,anonKey:o}}return null}const M=g();M||console.warn("[Supabase] No configuration found. Please call configureSupabase() with your credentials.");exports.supabase=null;let l=null;async function k(){return l||(l=(async()=>{try{const e=await w(),o=g();if(o&&o.url&&o.anonKey){if(exports.supabase=e(o.url,o.anonKey,{db:{schema:"public"},auth:{storageKey:"sb-auth-token-shared",storage:typeof window<"u"?localStorage:void 0,autoRefreshToken:!0,persistSession:!0}}),console.log("[Supabase] Client initialized successfully"),typeof window<"u")try{await h(),_(),y(),s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE])}catch(n){console.warn("[Supabase] Error setting up auth components after init:",n)}}else console.warn("[Supabase] Missing configuration, using fallback client"),exports.supabase=e("https://placeholder.supabase.co","placeholder-key");return exports.supabase}catch(e){console.error("[Supabase] Failed to initialize client:",e);const o=await w();return exports.supabase=o("https://placeholder.supabase.co","placeholder-key"),exports.supabase}})(),l)}const d=async()=>{if(!exports.supabase){if(!g())throw new Error("[Supabase] Missing configuration. Call configureSupabase({ url, anonKey }) before using the header package.");await k()}return exports.supabase};typeof window<"u"&&(window.addEventListener("error",e=>{e.error&&e.error.message&&e.error.message.includes("ne is not a function")&&(console.warn("[Supabase] Caught TypeError: ne is not a function - this is handled gracefully"),e.preventDefault())}),window.addEventListener("unhandledrejection",e=>{e.reason&&e.reason.message&&e.reason.message.includes("ne is not a function")&&(console.warn("[Supabase] Caught unhandled promise rejection with TypeError: ne is not a function"),e.preventDefault())}));const t=g();console.log("Supabase Configuration:",{url:(t==null?void 0:t.url)||"Not configured",hasKey:!!(t!=null&&t.anonKey),autoRefreshToken:!0,persistSession:!0});t!=null&&t.url&&console.log("URL:",t.url.replace(/https:\/\/(.+)\.supabase\.co/,"https://*****.supabase.co"));console.log("Key configured:",!!(t!=null&&t.anonKey)&&!t.anonKey.includes("your-anon-key"));console.log("Environment mode:","production");exports.configureSupabase=P;exports.getSupabase=d;exports.handleDomainChangeAuth=_;exports.initializeCrossSubdomainAuth=D;exports.restoreCrossSubdomainSession=T;exports.restoreSessionWithRetry=C;exports.setupAuthStateListener=h;exports.setupImmediateCrossSubdomainAuth=y;
