"use strict";const g=require("@supabase/supabase-js"),e=require("./utils/authRedirect.js");async function E(){try{console.log("[auth][init] Starting cross-subdomain authentication initialization..."),e.ensureCrossSubdomainCookies([e.ACCESS_COOKIE,e.REFRESH_COOKIE]),l();const o=await S(2,100);return o.success?(console.log("[auth][init] Cross-subdomain authentication initialized successfully"),{success:!0,session:o.session}):(console.log("[auth][init] Cross-subdomain authentication initialization completed (no active session)"),{success:!1,error:o.error})}catch(o){return console.error("[auth][init] Error during cross-subdomain authentication initialization:",o),{success:!1,error:o}}}async function d(){try{e.ensureCrossSubdomainCookies([e.ACCESS_COOKIE,e.REFRESH_COOKIE]);const o=e.getCookie(e.ACCESS_COOKIE),t=e.getCookie(e.REFRESH_COOKIE);if(o&&t){const{data:{session:s}}=await a.auth.getSession();if(!s){const{data:n,error:r}=await a.auth.setSession({access_token:o,refresh_token:t});r?console.log("[auth][restore] error",r):console.log("[auth][restore] done",!!n.session)}}else console.log("[auth][restore] no cookies present");e.syncCookiesToLocalStorage()}catch(o){console.log("[auth][restore] exception",o)}}function l(){console.log("[auth][listener] Setting up auth state listener..."),a.auth.onAuthStateChange(async(o,t)=>{switch(console.log("[auth][listener] Auth state changed:",o,!!t),o){case"TOKEN_REFRESHED":console.log("[auth][listener] Token refreshed successfully"),t&&(e.setSessionCookie(e.ACCESS_COOKIE,t.access_token,60*60*24*365),e.setSessionCookie(e.REFRESH_COOKIE,t.refresh_token,60*60*24*365),e.syncCookiesToLocalStorage());break;case"SIGNED_IN":console.log("[auth][listener] User signed in"),t&&(e.setSessionCookie(e.ACCESS_COOKIE,t.access_token,60*60*24*365),e.setSessionCookie(e.REFRESH_COOKIE,t.refresh_token,60*60*24*365),e.syncCookiesToLocalStorage());break;case"SIGNED_OUT":console.log("[auth][listener] User signed out");break;case"USER_UPDATED":console.log("[auth][listener] User updated");break;default:console.log("[auth][listener] Unhandled auth event:",o)}})}async function S(o=3,t=200){for(let s=1;s<=o;s++)try{console.log(`[auth][restore] Attempt ${s}/${o}`);const{data:{session:n}}=await a.auth.getSession();if(n&&n.user)return console.log("[auth][restore] Active session found"),{success:!0,session:n};s>1&&(console.log("[auth][restore] Re-syncing cross-subdomain cookies..."),e.ensureCrossSubdomainCookies([e.ACCESS_COOKIE,e.REFRESH_COOKIE]),await new Promise(i=>setTimeout(i,t*s)));const r=e.getCookie(e.ACCESS_COOKIE),c=e.getCookie(e.REFRESH_COOKIE);if(console.log(`[auth][restore] Cookie check - Access: ${!!r}, Refresh: ${!!c}`),r&&c){console.log("[auth][restore] Attempting to restore session from cookies...");const{data:i,error:u}=await a.auth.setSession({access_token:r,refresh_token:c});if(u){if(console.log(`[auth][restore] Attempt ${s} failed:`,u.message),s===o)return{success:!1,error:u};continue}if(i.session)return console.log("[auth][restore] Session restored successfully"),e.setSessionCookie(e.ACCESS_COOKIE,i.session.access_token,60*60*24*365),e.setSessionCookie(e.REFRESH_COOKIE,i.session.refresh_token,60*60*24*365),e.syncCookiesToLocalStorage(),{success:!0,session:i.session}}else if(console.log(`[auth][restore] Attempt ${s} - No cookies found`),s===o)return{success:!1,error:"No valid session or cookies"};s<o&&await new Promise(i=>setTimeout(i,t*s))}catch(n){if(console.log(`[auth][restore] Attempt ${s} exception:`,n),s===o)return{success:!1,error:n}}return console.log("[auth][restore] All attempts failed"),{success:!1,error:"All restoration attempts failed"}}const h="https://oqdnbpmmgntqtigstaow.supabase.co",C="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xZG5icG1tZ250cXRpZ3N0YW93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ0NTk2NDYsImV4cCI6MjA1MDAzNTY0Nn0.rn0nRY9xLgLt-ajiSPeG0PcdS9V-549C1yeqhcxxG40",a=g.createClient(h,C,{db:{schema:"public"},auth:{storageKey:"sb-auth-token",storage:localStorage,autoRefreshToken:!0,persistSession:!0,cookieOptions:{domain:window.location.hostname==="localhost"?"localhost":".aiworkspace.pro",path:"/",sameSite:"Lax",secure:window.location.protocol==="https:",maxAge:365*24*60*60}}});typeof window<"u"&&(e.ensureCrossSubdomainCookies([e.ACCESS_COOKIE,e.REFRESH_COOKIE]),l());console.log("Supabase Configuration:",{url:h,hasKey:!!C,autoRefreshToken:!0,persistSession:!0});console.log("URL:",h.replace(/https:\/\/(.+)\.supabase\.co/,"https://*****.supabase.co"));console.log("Key configured:",!C.includes("your-anon-key"));console.log("Environment mode:","production");exports.initializeCrossSubdomainAuth=E;exports.restoreCrossSubdomainSession=d;exports.restoreSessionWithRetry=S;exports.setupAuthStateListener=l;exports.supabase=a;
