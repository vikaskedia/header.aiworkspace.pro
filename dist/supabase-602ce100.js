"use strict";var N=Object.create;var I=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var L=Object.getPrototypeOf,M=Object.prototype.hasOwnProperty;var v=(e,o,n,i)=>{if(o&&typeof o=="object"||typeof o=="function")for(let t of H(o))!M.call(e,t)&&t!==n&&I(e,t,{get:()=>o[t],enumerable:!(i=P(o,t))||i.enumerable});return e};var z=(e,o,n)=>(n=e!=null?N(L(e)):{},v(o||!e||!e.__esModule?I(n,"default",{value:e,enumerable:!0}):n,e));const s=require("./utils/authRedirect.js");let E=null,m=null,O=!1,h=null;function W(){return O&&h!==null?(console.log("[auth][ready] Auth already ready, returning cached result"),Promise.resolve(h)):m?(console.log("[auth][ready] Waiting for existing auth ready promise"),m):(console.log("[auth][ready] Creating new auth ready promise"),m=new Promise(e=>{E=e}),m)}function k(e,o){console.log("[auth][ready] Signaling auth ready:",{isAuthenticated:e,hasSession:!!o}),h={isAuthenticated:e,session:o},O=!0,E&&(E(h),E=null),typeof window<"u"&&window.dispatchEvent(new CustomEvent("auth-ready",{detail:h}))}function $(){return O}function j(){return h}function T(){try{return console.log("[auth][immediate] Setting up immediate cross-subdomain authentication..."),s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE]),b().catch(e=>{console.log("[auth][immediate] Auth state listener setup deferred:",e.message)}),console.log("[auth][immediate] Immediate cross-subdomain authentication setup completed"),!0}catch(e){return console.error("[auth][immediate] Error during immediate cross-subdomain authentication setup:",e),!1}}async function q(){try{console.log("[auth][init] Starting cross-subdomain authentication initialization..."),s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE]),b();const e=await R(10,200);return e.success?(console.log("[auth][init] Cross-subdomain authentication initialized successfully"),k(!0,e.session),{success:!0,session:e.session}):(console.log("[auth][init] Cross-subdomain authentication initialization completed (no active session)"),k(!1,null),{success:!1,error:e.error})}catch(e){return console.error("[auth][init] Error during cross-subdomain authentication initialization:",e),k(!1,null),{success:!1,error:e}}}async function B(){try{s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE]);const e=s.getCookie(s.ACCESS_COOKIE),o=s.getCookie(s.REFRESH_COOKIE);if(e&&o){const n=await S(),{data:{session:i}}=await n.auth.getSession();if(!i){const{data:t,error:l}=await n.auth.setSession({access_token:e,refresh_token:o});l?console.log("[auth][restore] error",l):console.log("[auth][restore] done",!!t.session)}}else console.log("[auth][restore] no cookies present");s.syncCookiesToLocalStorage()}catch(e){console.log("[auth][restore] exception",e)}}let _=!1;async function b(){if(_){console.log("[auth][listener] Auth state listener already set up, skipping...");return}console.log("[auth][listener] Setting up auth state listener...");try{(await S()).auth.onAuthStateChange(async(o,n)=>{var i,t;switch(console.log("[auth][listener] Auth state changed:",o,!!n),o){case"TOKEN_REFRESHED":console.log("[auth][listener] Token refreshed successfully"),n&&(s.setSessionCookie(s.ACCESS_COOKIE,n.access_token,60*60*24*365),s.setSessionCookie(s.REFRESH_COOKIE,n.refresh_token,60*60*24*365),s.syncCookiesToLocalStorage(),s.broadcastAuthState({type:"TOKEN_REFRESHED",timestamp:Date.now(),userId:(i=n.user)==null?void 0:i.id,accessToken:n.access_token,refreshToken:n.refresh_token}));break;case"SIGNED_IN":console.log("[auth][listener] User signed in"),n&&(s.setSessionCookie(s.ACCESS_COOKIE,n.access_token,60*60*24*365),s.setSessionCookie(s.REFRESH_COOKIE,n.refresh_token,60*60*24*365),s.syncCookiesToLocalStorage(),s.broadcastAuthState({type:"SIGNED_IN",timestamp:Date.now(),userId:(t=n.user)==null?void 0:t.id,accessToken:n.access_token,refreshToken:n.refresh_token}));break;case"SIGNED_OUT":console.log("[auth][listener] User signed out"),s.broadcastAuthState({type:"SIGNED_OUT",timestamp:Date.now()}),typeof window<"u"&&window.dispatchEvent(new CustomEvent("session-logout-detected",{detail:{timestamp:new Date}}));break;case"USER_UPDATED":console.log("[auth][listener] User updated");break;default:console.log("[auth][listener] Unhandled auth event:",o)}}),_=!0,console.log("[auth][listener] Auth state listener set up successfully")}catch(e){console.warn("[auth][listener] Failed to setup auth state listener:",e);const o=e instanceof Error?e.message:String(e);o&&o.includes("Missing configuration")&&(console.log("[auth][listener] Supabase not configured yet, will retry when configured"),_=!1)}}async function R(e=10,o=200){console.log("[auth][restore] Starting enhanced session restoration...");const n=s.getCookie(s.ACCESS_COOKIE),i=s.getCookie(s.REFRESH_COOKIE),t=localStorage.getItem("sb-access-token"),l=localStorage.getItem("sb-refresh-token");if(!(n||i)&&!(t||l))return console.log("[auth][restore] No cookies or localStorage tokens found - fast fail (user not logged in)"),{success:!1,error:"No auth tokens found"};for(let r=1;r<=e;r++)try{try{const c=await S(),{data:{session:y},error:w}=await c.auth.getSession();if(y&&y.user)return console.log("[auth][restore] Active session found on attempt",r),{success:!0,session:y};if(w&&w.message&&w.message.includes("Missing configuration"))return console.log("[auth][restore] Supabase not configured yet, skipping restoration"),{success:!1,error:"Supabase not configured"}}catch(c){console.warn("[auth][restore] Error checking existing session:",c)}s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE]);const d=s.getCookie(s.ACCESS_COOKIE)||t,g=s.getCookie(s.REFRESH_COOKIE)||l;if(!d||!g){if(console.log(`[auth][restore] Attempt ${r}: Missing tokens (Access: ${!!d}, Refresh: ${!!g})`),r>=3)return console.log("[auth][restore] Tokens disappeared after sync - giving up"),{success:!1,error:"Tokens not found after sync"};if(r<e){await new Promise(c=>setTimeout(c,o));continue}else return{success:!1,error:"No cookies found after retries"}}console.log(`[auth][restore] Attempt ${r}: Restoring from cookies...`);const U=await S(),{data:f,error:u}=await U.auth.setSession({access_token:d,refresh_token:g});if(f.session&&f.session.user)return console.log("[auth][restore] Session restored successfully!"),s.setSessionCookie(s.ACCESS_COOKIE,f.session.access_token),s.setSessionCookie(s.REFRESH_COOKIE,f.session.refresh_token),s.syncCookiesToLocalStorage(),{success:!0,session:f.session};if(u){if(console.warn(`[auth][restore] Attempt ${r} failed: ${u.message}`),u.message.includes("Invalid")||u.message.includes("expired")||u.message.includes("revoked"))return console.log("[auth][restore] Tokens are invalid - stopping retries"),{success:!1,error:u};if(r===e)return{success:!1,error:u}}await new Promise(c=>setTimeout(c,o))}catch(d){if(console.error(`[auth][restore] Attempt ${r} unexpected error:`,d),r===e)return{success:!1,error:d};await new Promise(g=>setTimeout(g,o))}return{success:!1,error:"Max retries exceeded"}}function D(){try{return console.log("[auth][domain-change] Handling domain change authentication..."),s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE]),b().catch(e=>{console.log("[auth][domain-change] Auth state listener setup deferred:",e.message)}),R(7,25).then(e=>{e.success?console.log("[auth][domain-change] Domain change authentication successful"):console.log("[auth][domain-change] Domain change authentication failed:",e.error)}).catch(e=>{console.error("[auth][domain-change] Domain change authentication error:",e)}),console.log("[auth][domain-change] Domain change authentication setup completed"),!0}catch(e){return console.error("[auth][domain-change] Error during domain change authentication setup:",e),!1}}async function K(){var e;try{const{createClient:o}=await import("@supabase/supabase-js");return console.log("[Supabase] Successfully imported @supabase/supabase-js"),o}catch(o){console.warn("[Supabase] Failed to import @supabase/supabase-js:",o)}if(typeof window<"u"){if((e=window.supabase)!=null&&e.createClient)return console.log("[Supabase] Using global Supabase client"),window.supabase.createClient;if(window.createClient)return console.log("[Supabase] Using global createClient function"),window.createClient}try{if(typeof require<"u"){const{createClient:o}=require("@supabase/supabase-js");return console.log("[Supabase] Successfully required @supabase/supabase-js"),o}}catch(o){console.warn("[Supabase] Failed to require @supabase/supabase-js:",o)}return console.error("[Supabase] No Supabase client available, using mock with error handling"),(o,n,i)=>(console.warn("[Supabase] Using mock client - Supabase not properly configured"),{auth:{getSession:async()=>(console.warn("[Supabase] Mock getSession called - returning null session"),{data:{session:null},error:null}),setSession:async t=>(console.warn("[Supabase] Mock setSession called - returning null session"),{data:{session:null},error:null}),signOut:async()=>(console.warn("[Supabase] Mock signOut called"),{error:null}),signInWithPassword:async t=>(console.warn("[Supabase] Mock signInWithPassword called"),{data:{session:null,user:null},error:{message:"Supabase not configured"}}),signUp:async t=>(console.warn("[Supabase] Mock signUp called"),{data:{session:null,user:null},error:{message:"Supabase not configured"}}),signInWithOAuth:async t=>(console.warn("[Supabase] Mock signInWithOAuth called"),{data:{session:null,user:null},error:{message:"Supabase not configured"}}),resetPasswordForEmail:async(t,l)=>(console.warn("[Supabase] Mock resetPasswordForEmail called"),{data:{},error:{message:"Supabase not configured"}}),onAuthStateChange:t=>(console.warn("[Supabase] Mock onAuthStateChange called"),{data:{subscription:{unsubscribe:()=>{}}}})}})}let A=null;function x(e){A=e,console.log("[Supabase] Configuration set by consuming app"),p||F()}function C(){if(A)return A;if(typeof window<"u"){const e=window.__SUPABASE_URL__,o=window.__SUPABASE_ANON_KEY__;if(e&&o)return{url:e,anonKey:o}}return null}const G=C();G||console.warn("[Supabase] No configuration found. Please call configureSupabase() with your credentials.");exports.supabase=null;let p=null;async function F(){return p||(p=(async()=>{try{const e=await K(),o=C();if(o&&o.url&&o.anonKey){if(exports.supabase=e(o.url,o.anonKey,{db:{schema:"public"},auth:{storageKey:"sb-auth-token-shared",storage:typeof window<"u"?localStorage:void 0,autoRefreshToken:!0,persistSession:!0}}),console.log("[Supabase] Client initialized successfully"),typeof window<"u")try{await b(),D(),T(),s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE])}catch(n){console.warn("[Supabase] Error setting up auth components after init:",n)}}else console.warn("[Supabase] Missing configuration, using fallback client"),exports.supabase=e("https://placeholder.supabase.co","placeholder-key");return exports.supabase}catch(e){console.error("[Supabase] Failed to initialize client:",e);const o=await K();return exports.supabase=o("https://placeholder.supabase.co","placeholder-key"),exports.supabase}})(),p)}const S=async()=>{if(!exports.supabase){if(!C())throw new Error("[Supabase] Missing configuration. Call configureSupabase({ url, anonKey }) before using the header package.");await F()}return exports.supabase};typeof window<"u"&&(window.addEventListener("error",e=>{e.error&&e.error.message&&e.error.message.includes("ne is not a function")&&(console.warn("[Supabase] Caught TypeError: ne is not a function - this is handled gracefully"),e.preventDefault())}),window.addEventListener("unhandledrejection",e=>{e.reason&&e.reason.message&&e.reason.message.includes("ne is not a function")&&(console.warn("[Supabase] Caught unhandled promise rejection with TypeError: ne is not a function"),e.preventDefault())}));const a=C();console.log("Supabase Configuration:",{url:(a==null?void 0:a.url)||"Not configured",hasKey:!!(a!=null&&a.anonKey),autoRefreshToken:!0,persistSession:!0});a!=null&&a.url&&console.log("URL:",a.url.replace(/https:\/\/(.+)\.supabase\.co/,"https://*****.supabase.co"));console.log("Key configured:",!!(a!=null&&a.anonKey)&&!a.anonKey.includes("your-anon-key"));console.log("Environment mode:","production");exports.configureSupabase=x;exports.getAuthReadyResult=j;exports.getSupabase=S;exports.handleDomainChangeAuth=D;exports.initializeCrossSubdomainAuth=q;exports.isAuthReadySync=$;exports.restoreCrossSubdomainSession=B;exports.restoreSessionWithRetry=R;exports.setupAuthStateListener=b;exports.setupImmediateCrossSubdomainAuth=T;exports.waitForAuthReady=W;
