"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const n=require("../supabase-602ce100.js"),r=require("./authRedirect.js");function g(){const i=()=>{const e=window.location.hash,a=window.location.pathname,l=window.location.search;return e.includes("access_token=")||e.includes("refresh_token=")||l.includes("access_token=")||l.includes("refresh_token=")||a.includes("/auth/callback")||e.includes("#/auth/callback")},t=async()=>{if(!i())return!1;console.log("[SimpleCallback] Processing OAuth callback..."),console.log("[SimpleCallback] Current URL:",window.location.href),console.log("[SimpleCallback] Current hash:",window.location.hash);try{await new Promise(c=>setTimeout(c,500));const{data:e,error:a}=await n.supabase.auth.getSession();if(!(e!=null&&e.session)&&(window.location.hash.includes("access_token=")||window.location.search.includes("access_token="))){console.log("[SimpleCallback] No session found, trying to process URL tokens...");const{data:c,error:d}=await n.supabase.auth.getUser();if(c!=null&&c.user&&!d){console.log("[SimpleCallback] Successfully processed URL tokens for user:",c.user.email);const{data:s,error:p}=await n.supabase.auth.getSession();if(s!=null&&s.session)return console.log("[SimpleCallback] Session established after URL processing"),u(s.session)}}const{data:l,error:o}={data:e,error:a};return o?(console.error("[SimpleCallback] Error processing callback:",o),!1):l!=null&&l.session?u(l.session):(console.log("[SimpleCallback] No session found"),!1)}catch(e){return console.error("[SimpleCallback] Error processing callback:",e),!1}},u=async e=>{const a=e.user;console.log("[SimpleCallback] OAuth login successful:",a.email),e.access_token&&r.setSessionCookie(r.ACCESS_COOKIE,e.access_token),e.refresh_token&&r.setSessionCookie(r.REFRESH_COOKIE,e.refresh_token),r.syncCookiesToLocalStorage();const l=r.getPostLoginBase();console.log("[SimpleCallback] Post-login redirect URL:",l),console.log("[SimpleCallback] Session storage redirect:",sessionStorage.getItem("post-login-redirect")),console.log("[SimpleCallback] Local storage redirect:",localStorage.getItem("post-login-redirect"));let o=l||"/";return(o==="/auth/callback"||o.includes("/auth/callback"))&&(console.log("[SimpleCallback] Avoiding redirect to /auth/callback, using /"),o="/"),console.log("[SimpleCallback] Final redirect URL:",o),sessionStorage.removeItem("post-login-redirect"),localStorage.removeItem("post-login-redirect"),setTimeout(()=>{if(o.startsWith("/")){const s=`${window.location.origin}${o}`;console.log("[SimpleCallback] redirecting to:",s),window.location.href=s,setTimeout(()=>{window.location.pathname==="/auth/callback"&&(console.log("[SimpleCallback] Redirect did not work, trying replace..."),window.location.replace(s))},500)}else console.log("[SimpleCallback] redirecting to absolute URL:",o),window.location.href=o,setTimeout(()=>{window.location.pathname==="/auth/callback"&&(console.log("[SimpleCallback] Redirect did not work, trying replace..."),window.location.replace(o))},500)},100),!0};return typeof window<"u"&&(i()&&t(),window.addEventListener("hashchange",()=>{i()&&t()})),{isOAuthCallback:i,processCallback:t}}typeof window<"u"&&g();exports.setupSimpleCallback=g;
