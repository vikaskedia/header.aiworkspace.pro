"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const l={VITE_SUPABASE_URL:void 0,VITE_SUPABASE_ANON_KEY:void 0,BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}.VITE_APEX_DOMAIN||"aiworkspace.pro",A="aiworkspace-auth-channel",k="aiworkspace-auth-broadcast";let C=null;function B(){if(typeof window>"u")return null;if(!C)try{"BroadcastChannel"in window&&(C=new BroadcastChannel(A),console.log("[auth][broadcast] BroadcastChannel created:",A))}catch{console.warn("[auth][broadcast] BroadcastChannel not supported, using localStorage fallback")}return C}function _(o){if(typeof window>"u")return;console.log("[auth][broadcast] Broadcasting auth event:",o.type);const e=B();if(e)try{e.postMessage(o),console.log("[auth][broadcast] Event sent via BroadcastChannel")}catch(a){console.warn("[auth][broadcast] BroadcastChannel postMessage failed:",a)}try{const a=JSON.stringify(o);localStorage.setItem(k,a),setTimeout(()=>{localStorage.removeItem(k)},100),console.log("[auth][broadcast] Event sent via localStorage")}catch(a){console.warn("[auth][broadcast] localStorage broadcast failed:",a)}}function I(o){if(typeof window>"u")return()=>{};const e=[],a=B();if(a){const c=r=>{var g;console.log("[auth][broadcast] Received BroadcastChannel event:",(g=r.data)==null?void 0:g.type),r.data&&r.data.type&&o(r.data)};a.addEventListener("message",c),e.push(()=>a.removeEventListener("message",c))}const s=c=>{if(c.key===k&&c.newValue)try{const r=JSON.parse(c.newValue);console.log("[auth][broadcast] Received localStorage event:",r.type),o(r)}catch(r){console.warn("[auth][broadcast] Failed to parse localStorage event:",r)}};return window.addEventListener("storage",s),e.push(()=>window.removeEventListener("storage",s)),console.log("[auth][broadcast] Auth broadcast listeners registered"),()=>{e.forEach(c=>c()),console.log("[auth][broadcast] Auth broadcast listeners cleaned up")}}function T(o,e,a){d(f,o),d(S,e),P(),_({type:"SESSION_RESTORED",timestamp:Date.now(),userId:a,accessToken:o,refreshToken:e})}function u(o){return o==="localhost"||/^\d+\.\d+\.\d+\.\d+$/.test(o)}function m(o){return o===l||o.endsWith(`.${l}`)}function p(o){return document.cookie.split(";").map(s=>s.trim()).filter(s=>o.some(c=>s.startsWith(c+"=")))}function d(o,e,a=60*60*24*365){const s=location.hostname;if(u(s)){document.cookie=`${o}=${encodeURIComponent(e)}; Path=/; Max-Age=${a}; SameSite=Lax`,console.log("[auth][cookie][set][local]",{host:s,name:o,valuePreview:e.slice(0,20)+"..."}),console.log("[auth][cookie][after]",p([o]));return}document.cookie=`${o}=${encodeURIComponent(e)}; Domain=.${l}; Path=/; Max-Age=${a}; SameSite=Lax; Secure`,document.cookie=`${o}=; Path=/; Max-Age=0; SameSite=Lax`,console.log("[auth][cookie][set][apex]",{host:s,apex:l,name:o,valuePreview:e.slice(0,20)+"..."}),console.log("[auth][cookie][after]",p([o]))}function h(o){const e=new RegExp("(?:^|; )"+o.replace(/[$()*+.[\]?^{}|\\/-]/g,"\\$&")+"=([^;]*)"),a=document.cookie.match(e);return a?decodeURIComponent(a[1]):null}function b(o){const e=location.hostname;if(u(e)){document.cookie=`${o}=; Path=/; Max-Age=0; SameSite=Lax`,console.log("[auth][cookie][clear][local]",{host:e,name:o});return}document.cookie=`${o}=; Domain=.${l}; Path=/; Max-Age=0; SameSite=Lax; Secure`,document.cookie=`${o}=; Path=/; Max-Age=0; SameSite=Lax`,console.log("[auth][cookie][clear][apex]",{host:e,apex:l,name:o}),console.log("[auth][cookie][after]",p([o]))}function R(o){const e=location.hostname;if(u(e)){console.log("[auth][cookie][promote] skip (local host)",e);return}if(!m(e)){console.log("[auth][cookie][promote] skip (not under apex)",{host:e,apex:l});return}console.log("[auth][cookie][promote] start",{host:e,apex:l,names:o});const a=new Map;o.forEach(s=>{const c=s===f?E:L,r=localStorage.getItem(c);r&&(a.set(s,r),console.log("[auth][cookie][promote] found in localStorage",s))}),o.forEach(s=>{let c=h(s);!c&&a.has(s)&&(c=a.get(s),console.log("[auth][cookie][promote] using localStorage backup for",s)),c?d(s,c,60*60*24*365):console.log("[auth][cookie][promote] missing",s)}),console.log("[auth][cookie][promote] done",p(o))}function y(){return`${window.location.origin}/auth/callback`}function O(){try{const o=new URLSearchParams(location.search),e=new URLSearchParams(location.hash.replace("#","")),a=location.hash.substring(1),s=new URLSearchParams(a),c=["redirect","redirect_to","returnTo","next","redirect_origin"],r=c.find(n=>o.get(n)),g=c.find(n=>e.get(n)),w=c.find(n=>s.get(n));let t=r?o.get(r):g?e.get(g):w?s.get(w):"";if(console.log("[getPostLoginBase] Search params:",Object.fromEntries(o)),console.log("[getPostLoginBase] Hash params:",Object.fromEntries(e)),console.log("[getPostLoginBase] Token params:",Object.fromEntries(s)),console.log("[getPostLoginBase] Found param key:",r||g||w),console.log("[getPostLoginBase] Candidate from params:",t),!t){const n=sessionStorage.getItem("post-login-redirect")||localStorage.getItem("post-login-redirect")||"";if(console.log("[getPostLoginBase] Stored URL from storage:",n),n.startsWith("http"))try{const i=new URL(n);i.origin===window.location.origin?(t=i.pathname+i.search+i.hash,console.log("[getPostLoginBase] Same origin, extracted path:",t)):m(i.hostname)||u(i.hostname)?(t=n,console.log("[getPostLoginBase] Cross-subdomain, using full URL:",t)):(t="/",console.log("[getPostLoginBase] Different domain, using root"))}catch(i){console.log("[getPostLoginBase] Error parsing stored URL:",i),t=n}else n&&(t=n);console.log("[getPostLoginBase] Final candidate from storage:",t)}if((!t||t==="/auth/callback")&&document.referrer&&document.referrer!==window.location.href)try{const n=new URL(document.referrer);(m(n.hostname)||u(n.hostname))&&(n.pathname.includes("/auth/callback")||(t=n.href,console.log("[getPostLoginBase] Using referrer:",t)))}catch(n){console.log("[getPostLoginBase] Error parsing referrer:",n)}if((!t||t==="/auth/callback")&&(t={VITE_SUPABASE_URL:void 0,VITE_SUPABASE_ANON_KEY:void 0,BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}.VITE_DEFAULT_POST_LOGIN_URL||"/",console.log("[getPostLoginBase] Using default:",t)),t.startsWith("http"))try{const n=new URL(t);return m(n.hostname)||u(n.hostname)?(console.log("[getPostLoginBase] Returning absolute URL:",t),t):(console.log("[getPostLoginBase] Invalid hostname, returning /"),"/")}catch{return console.log("[getPostLoginBase] Invalid URL, returning /"),"/"}return t.startsWith("/")||(t="/"+t),t==="/auth/callback"&&(t="/",console.log("[getPostLoginBase] Avoiding /auth/callback redirect, using /")),console.log("[getPostLoginBase] Final candidate:",t),t}catch(o){return console.log("[getPostLoginBase] Error:",o),"/"}}const f="sb-access-token",S="sb-refresh-token",E="sb-access-token",L="sb-refresh-token";function P(){try{const o=h(f),e=h(S);o?localStorage.setItem(E,o):console.log("[auth][cookie->ls] access token cookie missing"),e?localStorage.setItem(L,e):console.log("[auth][cookie->ls] refresh token cookie missing"),console.log("[auth][cookie->ls] sync complete",{hasAccess:!!o,hasRefresh:!!e})}catch(o){console.error("[auth][cookie->ls] error",o)}}function U(){try{localStorage.removeItem(E),localStorage.removeItem(L),console.log("[auth][cookie->ls] cleared localStorage")}catch(o){console.log("[auth][cookie->ls] clear error",o)}}if(typeof window<"u")try{const o={ensureCrossSubdomainCookies:R,ACCESS_COOKIE:f,REFRESH_COOKIE:S,setSessionCookie:d,getCookie:h,clearSessionCookie:b,syncCookiesToLocalStorage:P,clearLocalStorageTokens:U,buildOAuthRedirectUrl:y,getPostLoginBase:O};window.authRedirectGlobal=o,window.ensureCrossSubdomainCookies=R,window.ACCESS_COOKIE=f,window.REFRESH_COOKIE=S,window.setSessionCookie=d,window.getCookie=h,window.clearSessionCookie=b,console.log("[auth][authRedirect] Functions made available globally for fallback access")}catch(o){console.warn("[auth][authRedirect] Failed to assign functions globally:",o)}exports.ACCESS_COOKIE=f;exports.AUTH_BROADCAST_CHANNEL=A;exports.AUTH_BROADCAST_KEY=k;exports.LS_ACCESS_KEY=E;exports.LS_REFRESH_KEY=L;exports.REFRESH_COOKIE=S;exports.broadcastAuthState=_;exports.buildOAuthRedirectUrl=y;exports.clearLocalStorageTokens=U;exports.clearSessionCookie=b;exports.ensureCrossSubdomainCookies=R;exports.getCookie=h;exports.getPostLoginBase=O;exports.listenForAuthBroadcasts=I;exports.setSessionCookie=d;exports.syncCookiesAndBroadcast=T;exports.syncCookiesToLocalStorage=P;
