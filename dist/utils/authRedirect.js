"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const r={VITE_SUPABASE_URL:void 0,VITE_SUPABASE_ANON_KEY:void 0,BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}.VITE_APEX_DOMAIN||"aiworkspace.pro",E="aiworkspace-auth-channel",u="aiworkspace-auth-broadcast";let p=null;function C(){if(typeof window>"u")return null;if(!p)try{"BroadcastChannel"in window&&(p=new BroadcastChannel(E),console.log("[auth][broadcast] BroadcastChannel created:",E))}catch{console.warn("[auth][broadcast] BroadcastChannel not supported, using localStorage fallback")}return p}function w(o){if(typeof window>"u")return;console.log("[auth][broadcast] Broadcasting auth event:",o.type);const t=C();if(t)try{t.postMessage(o),console.log("[auth][broadcast] Event sent via BroadcastChannel")}catch(a){console.warn("[auth][broadcast] BroadcastChannel postMessage failed:",a)}try{const a=JSON.stringify(o);localStorage.setItem(u,a),setTimeout(()=>{localStorage.removeItem(u)},100),console.log("[auth][broadcast] Event sent via localStorage")}catch(a){console.warn("[auth][broadcast] localStorage broadcast failed:",a)}}function B(o){if(typeof window>"u")return()=>{};const t=[],a=C();if(a){const e=n=>{var c;console.log("[auth][broadcast] Received BroadcastChannel event:",(c=n.data)==null?void 0:c.type),n.data&&n.data.type&&o(n.data)};a.addEventListener("message",e),t.push(()=>a.removeEventListener("message",e))}const s=e=>{if(e.key===u&&e.newValue)try{const n=JSON.parse(e.newValue);console.log("[auth][broadcast] Received localStorage event:",n.type),o(n)}catch(n){console.warn("[auth][broadcast] Failed to parse localStorage event:",n)}};return window.addEventListener("storage",s),t.push(()=>window.removeEventListener("storage",s)),console.log("[auth][broadcast] Auth broadcast listeners registered"),()=>{t.forEach(e=>e()),console.log("[auth][broadcast] Auth broadcast listeners cleaned up")}}function y(o,t,a){i(d,o),i(g,t),A(),w({type:"SESSION_RESTORED",timestamp:Date.now(),userId:a,accessToken:o,refreshToken:t})}function S(o){return o==="localhost"||/^\d+\.\d+\.\d+\.\d+$/.test(o)}function R(o){return o===r||o.endsWith(`.${r}`)}function h(o){return document.cookie.split(";").map(s=>s.trim()).filter(s=>o.some(e=>s.startsWith(e+"=")))}function i(o,t,a=60*60*24*365){const s=location.hostname;if(S(s)){document.cookie=`${o}=${encodeURIComponent(t)}; Path=/; Max-Age=${a}; SameSite=Lax`,console.log("[auth][cookie][set][local]",{host:s,name:o,valuePreview:t.slice(0,20)+"..."}),console.log("[auth][cookie][after]",h([o]));return}document.cookie=`${o}=${encodeURIComponent(t)}; Domain=.${r}; Path=/; Max-Age=${a}; SameSite=Lax; Secure`,document.cookie=`${o}=; Path=/; Max-Age=0; SameSite=Lax`,console.log("[auth][cookie][set][apex]",{host:s,apex:r,name:o,valuePreview:t.slice(0,20)+"..."}),console.log("[auth][cookie][after]",h([o]))}function l(o){const t=new RegExp("(?:^|; )"+o.replace(/[$()*+.[\]?^{}|\\/-]/g,"\\$&")+"=([^;]*)"),a=document.cookie.match(t);return a?decodeURIComponent(a[1]):null}function k(o){const t=location.hostname;if(S(t)){document.cookie=`${o}=; Path=/; Max-Age=0; SameSite=Lax`,console.log("[auth][cookie][clear][local]",{host:t,name:o});return}document.cookie=`${o}=; Domain=.${r}; Path=/; Max-Age=0; SameSite=Lax; Secure`,document.cookie=`${o}=; Path=/; Max-Age=0; SameSite=Lax`,console.log("[auth][cookie][clear][apex]",{host:t,apex:r,name:o}),console.log("[auth][cookie][after]",h([o]))}function L(o){const t=location.hostname;if(S(t)){console.log("[auth][cookie][promote] skip (local host)",t);return}if(!R(t)){console.log("[auth][cookie][promote] skip (not under apex)",{host:t,apex:r});return}console.log("[auth][cookie][promote] start",{host:t,apex:r,names:o});const a=new Map;o.forEach(s=>{const e=s===d?f:m,n=localStorage.getItem(e);n&&(a.set(s,n),console.log("[auth][cookie][promote] found in localStorage",s))}),o.forEach(s=>{let e=l(s);!e&&a.has(s)&&(e=a.get(s),console.log("[auth][cookie][promote] using localStorage backup for",s)),e?i(s,e,60*60*24*365):console.log("[auth][cookie][promote] missing",s)}),console.log("[auth][cookie][promote] done",h(o))}function _(){return`${window.location.origin}/auth/callback`}function b(){try{const o=new URLSearchParams(location.search),t=new URLSearchParams(location.hash.replace("#","")),a=["redirect","redirect_to","returnTo","next","redirect_origin"].find(n=>o.get(n)),s=["redirect","redirect_to","returnTo","next","redirect_origin"].find(n=>t.get(n));let e=a?o.get(a):s?t.get(s):"";if(console.log("[getPostLoginBase] Search params:",Object.fromEntries(o)),console.log("[getPostLoginBase] Hash params:",Object.fromEntries(t)),console.log("[getPostLoginBase] Found search param key:",a),console.log("[getPostLoginBase] Found hash param key:",s),console.log("[getPostLoginBase] Candidate from params:",e),!e){const n=sessionStorage.getItem("post-login-redirect")||localStorage.getItem("post-login-redirect")||"";if(console.log("[getPostLoginBase] Stored URL from storage:",n),n.startsWith("http"))try{const c=new URL(n);e=c.pathname+c.search+c.hash,console.log("[getPostLoginBase] Extracted path from stored URL:",e)}catch(c){console.log("[getPostLoginBase] Error parsing stored URL:",c),e=n}else e=n;console.log("[getPostLoginBase] Final candidate from storage:",e)}if(e||(e={VITE_SUPABASE_URL:void 0,VITE_SUPABASE_ANON_KEY:void 0,BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}.VITE_DEFAULT_POST_LOGIN_URL||"/",console.log("[getPostLoginBase] Using default:",e)),e.startsWith("http"))try{const n=new URL(e);return R(n.hostname)||S(n.hostname)?(console.log("[getPostLoginBase] Returning absolute URL:",e),e):(console.log("[getPostLoginBase] Invalid hostname, returning /"),"/")}catch{return console.log("[getPostLoginBase] Invalid URL, returning /"),"/"}return e.startsWith("/")||(e="/"+e),console.log("[getPostLoginBase] Final candidate:",e),e}catch(o){return console.log("[getPostLoginBase] Error:",o),"/"}}const d="sb-access-token",g="sb-refresh-token",f="sb-access-token",m="sb-refresh-token";function A(){try{const o=l(d),t=l(g);o?localStorage.setItem(f,o):console.log("[auth][cookie->ls] access token cookie missing"),t?localStorage.setItem(m,t):console.log("[auth][cookie->ls] refresh token cookie missing"),console.log("[auth][cookie->ls] sync complete",{hasAccess:!!o,hasRefresh:!!t})}catch(o){console.error("[auth][cookie->ls] error",o)}}function P(){try{localStorage.removeItem(f),localStorage.removeItem(m),console.log("[auth][cookie->ls] cleared localStorage")}catch(o){console.log("[auth][cookie->ls] clear error",o)}}if(typeof window<"u")try{const o={ensureCrossSubdomainCookies:L,ACCESS_COOKIE:d,REFRESH_COOKIE:g,setSessionCookie:i,getCookie:l,clearSessionCookie:k,syncCookiesToLocalStorage:A,clearLocalStorageTokens:P,buildOAuthRedirectUrl:_,getPostLoginBase:b};window.authRedirectGlobal=o,window.ensureCrossSubdomainCookies=L,window.ACCESS_COOKIE=d,window.REFRESH_COOKIE=g,window.setSessionCookie=i,window.getCookie=l,window.clearSessionCookie=k,console.log("[auth][authRedirect] Functions made available globally for fallback access")}catch(o){console.warn("[auth][authRedirect] Failed to assign functions globally:",o)}exports.ACCESS_COOKIE=d;exports.AUTH_BROADCAST_CHANNEL=E;exports.AUTH_BROADCAST_KEY=u;exports.LS_ACCESS_KEY=f;exports.LS_REFRESH_KEY=m;exports.REFRESH_COOKIE=g;exports.broadcastAuthState=w;exports.buildOAuthRedirectUrl=_;exports.clearLocalStorageTokens=P;exports.clearSessionCookie=k;exports.ensureCrossSubdomainCookies=L;exports.getCookie=l;exports.getPostLoginBase=b;exports.listenForAuthBroadcasts=B;exports.setSessionCookie=i;exports.syncCookiesAndBroadcast=y;exports.syncCookiesToLocalStorage=A;
