"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const t=require("../supabase-84f4e0e0.js"),r=require("./authRedirect.js");function g(){const c=()=>{const e=window.location.hash,n=window.location.pathname,s=window.location.search;return e.includes("access_token=")||e.includes("refresh_token=")||s.includes("access_token=")||s.includes("refresh_token=")||n.includes("/auth/callback")||e.includes("#/auth/callback")},u=async e=>{const n=e.user;console.log("[UniversalCallback] OAuth login successful:",n.email),e.access_token&&r.setSessionCookie(r.ACCESS_COOKIE,e.access_token),e.refresh_token&&r.setSessionCookie(r.REFRESH_COOKIE,e.refresh_token),r.syncCookiesToLocalStorage();const s=r.getPostLoginBase();console.log("[UniversalCallback] Post-login redirect URL:",s),console.log("[UniversalCallback] Session storage redirect:",sessionStorage.getItem("post-login-redirect")),console.log("[UniversalCallback] Local storage redirect:",localStorage.getItem("post-login-redirect"));let o=s||"/";return(o==="/auth/callback"||o.includes("/auth/callback"))&&(console.log("[UniversalCallback] Avoiding redirect to /auth/callback, using /"),o="/"),console.log("[UniversalCallback] Final redirect URL:",o),sessionStorage.removeItem("post-login-redirect"),localStorage.removeItem("post-login-redirect"),setTimeout(()=>{if(o.startsWith("/")){const a=`${window.location.origin}${o}`;console.log("[UniversalCallback] redirecting to:",a),window.location.href=a,setTimeout(()=>{window.location.pathname==="/auth/callback"&&(console.log("[UniversalCallback] Redirect did not work, trying replace..."),window.location.replace(a))},500)}else console.log("[UniversalCallback] redirecting to absolute URL:",o),window.location.href=o,setTimeout(()=>{window.location.pathname==="/auth/callback"&&(console.log("[UniversalCallback] Redirect did not work, trying replace..."),window.location.replace(o))},500)},100),!0},i=async()=>{if(!c())return!1;console.log("[UniversalCallback] Processing OAuth callback..."),console.log("[UniversalCallback] Current URL:",window.location.href),console.log("[UniversalCallback] Current hash:",window.location.hash);try{await new Promise(l=>setTimeout(l,500));const{data:e,error:n}=await t.supabase.auth.getSession();if(!(e!=null&&e.session)&&(window.location.hash.includes("access_token=")||window.location.search.includes("access_token="))){console.log("[UniversalCallback] No session found, trying to process URL tokens...");const{data:l,error:d}=await t.supabase.auth.getUser();if(l!=null&&l.user&&!d){console.log("[UniversalCallback] Successfully processed URL tokens for user:",l.user.email);const{data:a,error:k}=await t.supabase.auth.getSession();if(a!=null&&a.session)return console.log("[UniversalCallback] Session established after URL processing"),u(a.session)}}const{data:s,error:o}={data:e,error:n};return o?(console.error("[UniversalCallback] Error processing callback:",o),!1):s!=null&&s.session?await u(s.session):(console.log("[UniversalCallback] No session found"),!1)}catch(e){return console.error("[UniversalCallback] Error processing callback:",e),!1}};return typeof window<"u"&&(c()&&i(),window.addEventListener("hashchange",()=>{c()&&i()})),{isOAuthCallback:c,processCallback:i}}typeof window<"u"&&g();exports.setupUniversalCallback=g;
