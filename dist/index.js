"use strict";var He=Object.defineProperty;var ze=(r,s,a)=>s in r?He(r,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[s]=a;var re=(r,s,a)=>(ze(r,typeof s!="symbol"?s+"":s,a),a);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("vue"),x=require("element-plus"),B=require("./supabase-3d35f6ac.js"),c=require("./utils/authRedirect.js"),Ke=require("pinia"),qe=require("./utils/universalCallback.js");/*! Element Plus Icons Vue v2.3.2 */var Ge=e.defineComponent({name:"ArrowDown",__name:"arrow-down",setup(r){return(s,a)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M831.872 340.864 512 652.672 192.128 340.864a30.59 30.59 0 0 0-42.752 0 29.12 29.12 0 0 0 0 41.6L489.664 714.24a32 32 0 0 0 44.672 0l340.288-331.712a29.12 29.12 0 0 0 0-41.728 30.59 30.59 0 0 0-42.752 0z"})]))}}),ve=Ge,Ye=e.defineComponent({name:"Check",__name:"check",setup(r){return(s,a)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M406.656 706.944 195.84 496.256a32 32 0 1 0-45.248 45.248l256 256 512-512a32 32 0 0 0-45.248-45.248L406.592 706.944z"})]))}}),Je=Ye,je=e.defineComponent({name:"Lock",__name:"lock",setup(r){return(s,a)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M224 448a32 32 0 0 0-32 32v384a32 32 0 0 0 32 32h576a32 32 0 0 0 32-32V480a32 32 0 0 0-32-32zm0-64h576a96 96 0 0 1 96 96v384a96 96 0 0 1-96 96H224a96 96 0 0 1-96-96V480a96 96 0 0 1 96-96"}),e.createElementVNode("path",{fill:"currentColor",d:"M512 544a32 32 0 0 1 32 32v192a32 32 0 1 1-64 0V576a32 32 0 0 1 32-32m192-160v-64a192 192 0 1 0-384 0v64zM512 64a256 256 0 0 1 256 256v128H256V320A256 256 0 0 1 512 64"})]))}}),_e=je,Xe=e.defineComponent({name:"Message",__name:"message",setup(r){return(s,a)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M128 224v512a64 64 0 0 0 64 64h640a64 64 0 0 0 64-64V224zm0-64h768a64 64 0 0 1 64 64v512a128 128 0 0 1-128 128H192A128 128 0 0 1 64 736V224a64 64 0 0 1 64-64"}),e.createElementVNode("path",{fill:"currentColor",d:"M904 224 656.512 506.88a192 192 0 0 1-289.024 0L120 224zm-698.944 0 210.56 240.704a128 128 0 0 0 192.704 0L818.944 224z"})]))}}),Ze=Xe,Qe=e.defineComponent({name:"Refresh",__name:"refresh",setup(r){return(s,a)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M771.776 794.88A384 384 0 0 1 128 512h64a320 320 0 0 0 555.712 216.448H654.72a32 32 0 1 1 0-64h149.056a32 32 0 0 1 32 32v148.928a32 32 0 1 1-64 0v-50.56zM276.288 295.616h92.992a32 32 0 0 1 0 64H220.16a32 32 0 0 1-32-32V178.56a32 32 0 0 1 64 0v50.56A384 384 0 0 1 896.128 512h-64a320 320 0 0 0-555.776-216.384z"})]))}}),Se=Qe,eo=e.defineComponent({name:"User",__name:"user",setup(r){return(s,a)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M512 512a192 192 0 1 0 0-384 192 192 0 0 0 0 384m0 64a256 256 0 1 1 0-512 256 256 0 0 1 0 512m320 320v-96a96 96 0 0 0-96-96H288a96 96 0 0 0-96 96v96a32 32 0 1 1-64 0v-96a160 160 0 0 1 160-160h448a160 160 0 0 1 160 160v96a32 32 0 1 1-64 0"})]))}}),pe=eo,oo=e.defineComponent({name:"Warning",__name:"warning",setup(r){return(s,a)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M512 64a448 448 0 1 1 0 896 448 448 0 0 1 0-896m0 832a384 384 0 0 0 0-768 384 384 0 0 0 0 768m48-176a48 48 0 1 1-96 0 48 48 0 0 1 96 0m-48-464a32 32 0 0 1 32 32v288a32 32 0 0 1-64 0V288a32 32 0 0 1 32-32"})]))}}),Ce=oo;function ye(){const r=e.ref({user:null,isAuthenticated:!1,isLoading:!0,error:null}),s=e.ref(null),a=e.computed(()=>r.value.isAuthenticated),v=e.computed(()=>r.value.user),_=e.computed(()=>r.value.isLoading),C=async()=>{var g,n,i,A,S,u,V,R,k,d,b,f,w,F,H,G,O,K,h,U,q,D;try{console.log("[auth][enhanced] Starting loadUserInfo..."),console.log("[auth][enhanced] Ensuring cross-subdomain cookie synchronization...");let M=null,P="sb-access-token",T="sb-refresh-token";const ee=y=>{try{const L=location.hostname;if(L==="localhost"||/^\d+\.\d+\.\d+\.\d+$/.test(L)){console.log("[auth][enhanced][fallback] Skipping cookie sync for localhost");return}const J="aiworkspace.pro";if(!L.endsWith(`.${J}`)&&L!==J){console.log("[auth][enhanced][fallback] Skipping cookie sync - not under apex domain");return}console.log("[auth][enhanced][fallback] Performing basic cookie synchronization"),y.forEach(te=>{document.cookie.split(";").find(ce=>ce.trim().startsWith(te+"="))&&console.log(`[auth][enhanced][fallback] Found cookie: ${te}`)})}catch(L){console.warn("[auth][enhanced][fallback] Error in fallback cookie sync:",L)}};try{const y=await Promise.resolve().then(()=>require("./utils/authRedirect.js"));M=y.ensureCrossSubdomainCookies,P=y.ACCESS_COOKIE||"sb-access-token",T=y.REFRESH_COOKIE||"sb-refresh-token",console.log("[auth][enhanced] Successfully imported authRedirect module")}catch(y){console.warn("[auth][enhanced] Failed to import authRedirect module:",y),typeof window<"u"&&((g=window.authRedirectGlobal)!=null&&g.ensureCrossSubdomainCookies?(M=window.authRedirectGlobal.ensureCrossSubdomainCookies,P=window.authRedirectGlobal.ACCESS_COOKIE||"sb-access-token",T=window.authRedirectGlobal.REFRESH_COOKIE||"sb-refresh-token",console.log("[auth][enhanced] Using global authRedirectGlobal object")):window.ensureCrossSubdomainCookies&&(M=window.ensureCrossSubdomainCookies,P=window.ACCESS_COOKIE||"sb-access-token",T=window.REFRESH_COOKIE||"sb-refresh-token",console.log("[auth][enhanced] Using individual global ensureCrossSubdomainCookies")))}if(M&&typeof M=="function")try{M([P,T]),console.log("[auth][enhanced] Cross-subdomain cookies synchronized")}catch(y){console.warn("[auth][enhanced] Error calling ensureCrossSubdomainCookies:",y),console.warn("[auth][enhanced] Continuing without cookie synchronization...")}else{console.warn("[auth][enhanced] ensureCrossSubdomainCookies not available, using fallback cookie sync"),console.warn("[auth][enhanced] This is expected in some bundling scenarios and will not affect core functionality");try{ee([P,T])}catch(y){console.warn("[auth][enhanced] Fallback cookie sync also failed:",y)}}await new Promise(y=>setTimeout(y,100));let Y=null;try{const L=await(await B.getSupabase()).auth.getSession();Y=(n=L==null?void 0:L.data)==null?void 0:n.session}catch(y){console.warn("[auth][enhanced] Error getting Supabase session:",y)}if(Y&&Y.user){console.log("[auth][enhanced] Active Supabase session found");const y=Y.user,L={id:y.id,name:((i=y.user_metadata)==null?void 0:i.name)||((A=y.user_metadata)==null?void 0:A.user_name)||((S=y.user_metadata)==null?void 0:S.full_name)||((u=y.email)==null?void 0:u.split("@")[0])||"User",email:y.email,avatar_url:((V=y.user_metadata)==null?void 0:V.avatar_url)||null,user_metadata:y.user_metadata};return r.value={user:L,isAuthenticated:!0,isLoading:!1,error:null},s.value={user:L,access_token:Y.access_token,refresh_token:Y.refresh_token},{user:L,session:s.value,error:null}}console.log("[auth][enhanced] No active session, attempting to restore from cookies...");const Z=await B.restoreSessionWithRetry();if(Z.success&&Z.session){console.log("[auth][enhanced] Session restored successfully from cookies");const y=Z.session.user,L={id:y.id,name:((R=y.user_metadata)==null?void 0:R.name)||((k=y.user_metadata)==null?void 0:k.user_name)||((d=y.user_metadata)==null?void 0:d.full_name)||((b=y.email)==null?void 0:b.split("@")[0])||"User",email:y.email,avatar_url:((f=y.user_metadata)==null?void 0:f.avatar_url)||null,user_metadata:y.user_metadata};return r.value={user:L,isAuthenticated:!0,isLoading:!1,error:null},s.value=Z.session,{user:L,session:s.value,error:null}}else{console.log("[auth][enhanced] Failed to restore session:",Z.error),console.log("[auth][enhanced] Retrying session restoration with extended delay..."),await new Promise(L=>setTimeout(L,500)),M([P,T]);const y=await B.restoreSessionWithRetry();if(y.success&&y.session){console.log("[auth][enhanced] Session restored on retry");const L=y.session.user,J={id:L.id,name:((w=L.user_metadata)==null?void 0:w.name)||((F=L.user_metadata)==null?void 0:F.user_name)||((H=L.user_metadata)==null?void 0:H.full_name)||((G=L.email)==null?void 0:G.split("@")[0])||"User",email:L.email,avatar_url:((O=L.user_metadata)==null?void 0:O.avatar_url)||null,user_metadata:L.user_metadata};return r.value={user:J,isAuthenticated:!0,isLoading:!1,error:null},s.value=y.session,{user:J,session:s.value,error:null}}}}catch(M){console.error("Error getting Supabase session:",M),M&&typeof M=="object"&&"message"in M&&typeof M.message=="string"&&M.message.includes("ne is not a function")&&(console.warn('[auth][enhanced] Caught "ne is not a function" error - this is handled gracefully'),console.warn("[auth][enhanced] The ensureCrossSubdomainCookies function import failed, but continuing..."));try{const P=await B.restoreSessionWithRetry();if(P.success&&P.session){console.log("[auth][enhanced] Session restored after error");const T=P.session.user,ee={id:T.id,name:((K=T.user_metadata)==null?void 0:K.name)||((h=T.user_metadata)==null?void 0:h.user_name)||((U=T.user_metadata)==null?void 0:U.full_name)||((q=T.email)==null?void 0:q.split("@")[0])||"User",email:T.email,avatar_url:((D=T.user_metadata)==null?void 0:D.avatar_url)||null,user_metadata:T.user_metadata};return r.value={user:ee,isAuthenticated:!0,isLoading:!1,error:null},s.value=P.session,{user:ee,session:s.value,error:null}}}catch(P){console.error("Error restoring session:",P)}}return console.log("[auth][enhanced] No valid authentication found"),r.value={user:null,isAuthenticated:!1,isLoading:!1,error:"No valid session found"},s.value=null,{user:null,session:null,error:"No valid session found"}},I=async()=>{try{await(await B.getSupabase()).auth.signOut(),c.clearSessionCookie(c.ACCESS_COOKIE),c.clearSessionCookie(c.REFRESH_COOKIE),c.clearLocalStorageTokens(),r.value={user:null,isAuthenticated:!1,isLoading:!1,error:null},s.value=null,console.log("[auth][enhanced] User logged out successfully")}catch(g){console.error("Error during logout:",g),r.value={user:null,isAuthenticated:!1,isLoading:!1,error:null},s.value=null}},N=async(g,n)=>{var i,A,S,u,V;try{r.value.isLoading=!0;const R=await B.getSupabase(),{data:k,error:d}=await R.auth.signInWithPassword({email:g,password:n});if(d)throw d;if(k.session){const b=k.session.user,f={id:b.id,name:((i=b.user_metadata)==null?void 0:i.name)||((A=b.user_metadata)==null?void 0:A.user_name)||((S=b.user_metadata)==null?void 0:S.full_name)||((u=b.email)==null?void 0:u.split("@")[0])||"User",email:b.email,avatar_url:((V=b.user_metadata)==null?void 0:V.avatar_url)||null,user_metadata:b.user_metadata};return r.value={user:f,isAuthenticated:!0,isLoading:!1,error:null},s.value={user:f,access_token:k.session.access_token,refresh_token:k.session.refresh_token},{user:f,session:s.value,error:null}}return{user:null,session:null,error:"No session returned"}}catch(R){return console.error("Sign in error:",R),r.value.isLoading=!1,{user:null,session:null,error:String(R)}}},W=async(g,n,i)=>{var A,S,u,V,R;try{r.value.isLoading=!0;const k=await B.getSupabase(),{data:d,error:b}=await k.auth.signUp({email:g,password:n,options:{data:i}});if(b)throw b;if(d.session){const f=d.session.user,w={id:f.id,name:((A=f.user_metadata)==null?void 0:A.name)||((S=f.user_metadata)==null?void 0:S.user_name)||((u=f.user_metadata)==null?void 0:u.full_name)||((V=f.email)==null?void 0:V.split("@")[0])||"User",email:f.email,avatar_url:((R=f.user_metadata)==null?void 0:R.avatar_url)||null,user_metadata:f.user_metadata};return r.value={user:w,isAuthenticated:!0,isLoading:!1,error:null},s.value={user:w,access_token:d.session.access_token,refresh_token:d.session.refresh_token},{user:w,session:s.value,error:null}}return{user:null,session:null,error:"No session returned"}}catch(k){return console.error("Sign up error:",k),r.value.isLoading=!1,{user:null,session:null,error:String(k)}}},m=async()=>{await C()};return e.onMounted(async()=>{await B.initializeCrossSubdomainAuth(),await m()}),{authState:r,currentSession:s,isAuthenticated:a,currentUser:v,isLoading:_,loadUserInfo:C,logout:I,signIn:N,signUp:W,checkAuth:m}}const X={normalCheckInterval:3e4,fastCheckInterval:5e3,fastMonitoringDuration:12e4,maxRetryAttempts:3,retryDelay:2e3,validationCacheDuration:5e3,enableImmediateDetection:!0,enableFastMonitoring:!0,enableNetworkAwareness:!0},Ee={...X,normalCheckInterval:1e4,fastCheckInterval:2e3,fastMonitoringDuration:6e4,maxRetryAttempts:2,retryDelay:1e3},be={...X,normalCheckInterval:6e4,fastCheckInterval:1e4,fastMonitoringDuration:3e5,maxRetryAttempts:5,retryDelay:3e3,enableFastMonitoring:!1},fe={...X,normalCheckInterval:1e4,fastCheckInterval:2e3,fastMonitoringDuration:3e4,validationCacheDuration:1e3},ge={...X,normalCheckInterval:45e3,fastCheckInterval:3e3,fastMonitoringDuration:9e4,validationCacheDuration:1e4};function he(){switch("production"){case"production":return ge;case"development":return fe;default:return X}}function so(r){return{...X,...r}}const Ve={default:X,fast:Ee,conservative:be,development:fe,production:ge};function to(r){return Ve[r]}const ao={immediate:"Immediate (0-2 seconds) - When logout is detected via auth events",fast:"Fast (2-5 seconds) - When fast monitoring is active",normal:"Normal (up to 30 seconds) - Regular monitoring interval",conservative:"Conservative (up to 60 seconds) - Less frequent monitoring"},ro={manualLogout:{timing:"Immediate (0-2 seconds)",description:"User clicks logout button",method:"Auth state change event + fast monitoring"},sessionExpiry:{timing:"Fast (2-5 seconds)",description:"Session token expires naturally",method:"Fast monitoring detects invalid session"},tokenInvalidation:{timing:"Normal (up to 30 seconds)",description:"Token is invalidated server-side",method:"Regular monitoring detects validation failure"},networkIssues:{timing:"Immediate (0-1 second)",description:"Network connection lost",method:"Network event listener"},crossTabLogout:{timing:"Fast (2-5 seconds)",description:"User logs out in another tab",method:"Storage event listener + fast monitoring"}};function Ne(r){const s=e.ref(!0),a=e.ref(null),v=e.ref(!1),_=e.ref(!1),C=e.ref(null),I=e.ref(null),N=e.ref(null),W={...he(),...r},m=W.normalCheckInterval,g=W.fastCheckInterval,n=W.fastMonitoringDuration,i=W.maxRetryAttempts,A=W.retryDelay,S=e.computed(()=>!s.value&&a.value!==null),u=e.computed(()=>{var h,U;return((h=a.value)==null?void 0:h.canRetry)&&((U=a.value)==null?void 0:U.type)!=="manual_check_failed"}),V=async()=>{try{console.log("[SessionMonitor] Validating session...");const h=c.getCookie(c.ACCESS_COOKIE),U=c.getCookie(c.REFRESH_COOKIE);if(!h||!U)return console.log("[SessionMonitor] No tokens found in cookies"),!1;const q=await B.getSupabase(),{data:{session:D},error:M}=await q.auth.getSession();if(M)return console.warn("[SessionMonitor] Error getting session:",M),!1;if(!D||!D.user)return console.log("[SessionMonitor] No valid session found"),!1;const P=new Date,T=new Date(D.expires_at*1e3);return P>=T?(console.log("[SessionMonitor] Session has expired"),!1):(console.log("[SessionMonitor] Session is valid"),C.value=new Date,!0)}catch(h){return console.error("[SessionMonitor] Error validating session:",h),!1}},R=async()=>{try{console.log("[SessionMonitor] Attempting to restore session...");const h=c.getCookie(c.ACCESS_COOKIE),U=c.getCookie(c.REFRESH_COOKIE);if(!h||!U)return console.log("[SessionMonitor] No tokens available for restoration"),!1;const q=await B.getSupabase(),{data:D,error:M}=await q.auth.setSession({access_token:h,refresh_token:U});return M?(console.warn("[SessionMonitor] Error restoring session:",M),!1):D.session&&D.session.user?(console.log("[SessionMonitor] Session restored successfully"),C.value=new Date,!0):!1}catch(h){return console.error("[SessionMonitor] Error restoring session:",h),!1}},k=(h,U,q=!0)=>{console.warn("[SessionMonitor] Session loss detected:",{type:h,message:U}),s.value=!1,a.value={type:h,message:U,timestamp:new Date,canRetry:q}},d=async()=>{console.log("[SessionMonitor] Retrying session validation...");for(let h=1;h<=i;h++){if(console.log(`[SessionMonitor] Retry attempt ${h}/${i}`),h>1&&await new Promise(D=>setTimeout(D,A)),await R()&&await V())return console.log("[SessionMonitor] Session restored and validated successfully"),s.value=!0,a.value=null,!0;if(await V())return console.log("[SessionMonitor] Session validated successfully on retry"),s.value=!0,a.value=null,!0}return console.log("[SessionMonitor] All retry attempts failed"),!1},b=()=>{console.log("[SessionMonitor] Clearing session loss state"),s.value=!0,a.value=null},f=()=>{if(v.value){console.log("[SessionMonitor] Already monitoring, skipping start");return}console.log("[SessionMonitor] Starting session monitoring..."),v.value=!0,V().then(h=>{h||k("session_expired","Your session has expired. Please log in again.",!0)}),I.value=setInterval(async()=>{console.log("[SessionMonitor] Periodic session check...");const h=await V();!h&&s.value?k("session_expired","Your session has expired. Please log in again.",!0):h&&!s.value&&(console.log("[SessionMonitor] Session recovered"),b())},m)},w=()=>{if(_.value){console.log("[SessionMonitor] Fast monitoring already active");return}console.log("[SessionMonitor] Starting fast monitoring (5s intervals)..."),_.value=!0,N.value&&clearInterval(N.value),N.value=setInterval(async()=>{console.log("[SessionMonitor] Fast session check...");const h=await V();!h&&s.value?(k("session_expired","Your session has expired. Please log in again.",!0),F()):h&&!s.value&&(console.log("[SessionMonitor] Session recovered"),b(),F())},g),setTimeout(()=>{_.value&&(console.log(`[SessionMonitor] Auto-stopping fast monitoring after ${n/1e3} seconds`),F())},n)},F=()=>{_.value&&(console.log("[SessionMonitor] Stopping fast monitoring..."),_.value=!1,N.value&&(clearInterval(N.value),N.value=null))},H=()=>{v.value&&(console.log("[SessionMonitor] Stopping session monitoring..."),v.value=!1,I.value&&(clearInterval(I.value),I.value=null),F())},G=async()=>{console.log("[SessionMonitor] Manual session check requested");const h=await V();return!h&&!await R()?(k("manual_check_failed","Session validation failed. Please log in again.",!1),!1):h},O=()=>{k("network_error","Network connection lost. Please check your internet connection and try again.",!0)},K=()=>{if(typeof window>"u")return;const h=()=>{var D;console.log("[SessionMonitor] Network connection restored"),S.value&&((D=a.value)==null?void 0:D.type)==="network_error"&&setTimeout(()=>d(),1e3)},U=()=>{console.log("[SessionMonitor] Network connection lost"),O()},q=D=>{console.log("[SessionMonitor] Logout detected, starting fast monitoring for immediate detection"),w()};return window.addEventListener("online",h),window.addEventListener("offline",U),window.addEventListener("session-logout-detected",q),()=>{window.removeEventListener("online",h),window.removeEventListener("offline",U),window.removeEventListener("session-logout-detected",q)}};return e.onMounted(()=>{console.log("[SessionMonitor] Mounted, setting up monitoring"),f(),K()}),e.onUnmounted(()=>{console.log("[SessionMonitor] Unmounted, cleaning up"),H()}),{isSessionValid:s,sessionLossEvent:a,isMonitoring:v,isFastMonitoring:_,lastValidSession:C,hasSessionLoss:S,canRetrySession:u,validateSession:V,restoreSession:R,retrySession:d,clearSessionLoss:b,startMonitoring:f,stopMonitoring:H,startFastMonitoring:w,stopFastMonitoring:F,checkSession:G,handleNetworkError:O}}const Ie=Ke.defineStore("workspace",()=>{const r=e.ref(null),s=e.ref([]),a=e.ref(null),v=m=>{r.value=m,localStorage.setItem("current_workspace",JSON.stringify(m))},_=m=>{s.value=m,localStorage.setItem("available_workspaces",JSON.stringify(m))};return{currentWorkspace:r,workspaces:s,user:a,setCurrentWorkspace:v,setWorkspaces:_,setUser:m=>{a.value=m,localStorage.setItem("user_info",JSON.stringify(m))},loadPersistedData:()=>{const m=localStorage.getItem("current_workspace");if(m)try{r.value=JSON.parse(m)}catch(i){console.error("Error loading persisted workspace:",i)}const g=localStorage.getItem("available_workspaces");if(g)try{s.value=JSON.parse(g)}catch(i){console.error("Error loading persisted workspaces:",i)}const n=localStorage.getItem("user_info");if(n)try{a.value=JSON.parse(n)}catch(i){console.error("Error loading persisted user:",i)}},clearData:()=>{r.value=null,s.value=[],a.value=null,localStorage.removeItem("current_workspace"),localStorage.removeItem("available_workspaces"),localStorage.removeItem("user_info")},loadWorkspaces:async(m=!1)=>{try{const{data:{user:g}}=await B.supabase.auth.getUser();if(!g)return[];let n=B.supabase.from("workspaces").select(`
          id, title, description, parent_workspace_id, created_by, archived, created_at, git_repo, 
          workspace_access!inner ( access_type, shared_with_user_id ),
          workspace_activities!left ( updated_at )
        `).eq("workspace_access.shared_with_user_id",g.id);m||(n=n.eq("archived",!1));const{data:i,error:A}=await n;if(A)throw A;const S=new Map;(i||[]).forEach(d=>{(d.workspace_access||[]).forEach(b=>{b.shared_with_user_id===g.id&&S.set(d.id,b)})});const u=[...new Set((i||[]).filter(d=>d.parent_workspace_id).map(d=>d.parent_workspace_id).filter(d=>!S.has(d)))];let V=[];if(u.length){let d=B.supabase.from("workspaces").select("id, title, description, parent_workspace_id, created_by, archived, created_at").in("id",u);m||(d=d.eq("archived",!1));const{data:b,error:f}=await d;if(f)throw f;V=b||[]}const k=[...i||[],...V].map(d=>{var b,f,w;return{id:d.id,title:d.title,description:d.description||"No description",parent_workspace_id:d.parent_workspace_id,created_by:d.created_by,archived:d.archived,created_at:d.created_at,latest_activity:((f=(b=d.workspace_activities)==null?void 0:b[0])==null?void 0:f.updated_at)||d.created_at,hasAccess:S.has(d.id),accessType:((w=S.get(d.id))==null?void 0:w.access_type)||null}});return k.sort((d,b)=>new Date(b.latest_activity)-new Date(d.latest_activity)),_(k),k}catch(g){return console.error("loadWorkspaces error",g),[]}}}});function Ae(){const r=e.ref({user:null,isAuthenticated:!1,isLoading:!0,error:null}),s=e.ref(window.location.href),a=async()=>{var m,g,n,i,A,S,u,V;try{r.value.isLoading=!0;const R=await B.getSupabase(),{data:{session:k},error:d}=await R.auth.getSession();if(d){console.error("Error checking auth status:",d),r.value={user:null,isAuthenticated:!1,isLoading:!1,error:d.message};return}k!=null&&k.user?(r.value={user:{id:k.user.id,email:k.user.email||"",name:((m=k.user.user_metadata)==null?void 0:m.full_name)||((g=k.user.user_metadata)==null?void 0:g.name)||((n=k.user.email)==null?void 0:n.split("@")[0])||"User",avatar_url:((i=k.user.user_metadata)==null?void 0:i.avatar_url)||((A=k.user.user_metadata)==null?void 0:A.picture)||null,initials:(((S=k.user.user_metadata)==null?void 0:S.full_name)||((u=k.user.user_metadata)==null?void 0:u.name)||((V=k.user.email)==null?void 0:V.split("@")[0])||"U").split(" ").map(b=>b[0]).join("").toUpperCase().substring(0,2)},isAuthenticated:!0,isLoading:!1,error:null},k.access_token&&c.setSessionCookie(c.ACCESS_COOKIE,k.access_token),k.refresh_token&&c.setSessionCookie(c.REFRESH_COOKIE,k.refresh_token),c.syncCookiesToLocalStorage()):r.value={user:null,isAuthenticated:!1,isLoading:!1,error:null}}catch(R){console.error("Auth check failed:",R),r.value={user:null,isAuthenticated:!1,isLoading:!1,error:R.message||"Authentication check failed"}}},v=async(m,g)=>{try{const n=await B.getSupabase(),{error:i}=await n.auth.signInWithPassword({email:m,password:g});return i?{success:!1,error:i.message}:(await a(),sessionStorage.setItem("post-login-redirect",s.value),{success:!0})}catch(n){return console.error("Login error:",n),{success:!1,error:n.message||"Login failed"}}},_=async(m,g)=>{var n;try{const i=await B.getSupabase(),{data:A,error:S}=await i.auth.signUp({email:m,password:g});return S?{success:!1,error:S.message}:A.user&&!A.user.email_confirmed_at?{success:!0,needsConfirmation:!0}:(n=A.session)!=null&&n.user?(await a(),sessionStorage.setItem("post-login-redirect",s.value),{success:!0}):{success:!1,error:"No session created"}}catch(i){return console.error("Signup error:",i),{success:!1,error:i.message||"Signup failed"}}},C=async m=>{try{const g=`${window.location.origin}/auth/callback`;console.log("[OAuth] Starting login with provider:",m),console.log("[OAuth] Redirect URL:",g),console.log("[OAuth] Current URL:",s.value),console.log("[OAuth] Current origin:",window.location.origin);const n=await B.getSupabase(),{error:i}=await n.auth.signInWithOAuth({provider:m,options:{redirectTo:g,queryParams:{redirect_origin:s.value}}});if(i)return console.error("[OAuth] Error:",i),{success:!1,error:i.message};const A=s.value||window.location.href;return sessionStorage.setItem("post-login-redirect",A),localStorage.setItem("post-login-redirect",A),console.log("[OAuth] Stored redirect URL:",A),console.log("[OAuth] Current URL value:",s.value),console.log("[OAuth] Window location href:",window.location.href),{success:!0}}catch(g){return console.error("OAuth login error:",g),{success:!1,error:g.message||"OAuth login failed"}}},I=async()=>{try{const m=await B.getSupabase(),{error:g}=await m.auth.signOut();g&&console.error("Logout error:",g),r.value={user:null,isAuthenticated:!1,isLoading:!1,error:null},c.clearSessionCookie(c.ACCESS_COOKIE),c.clearSessionCookie(c.REFRESH_COOKIE),c.clearLocalStorageTokens()}catch(m){console.error("Logout error:",m)}},N=async m=>{try{const g=await B.getSupabase(),{error:n}=await g.auth.resetPasswordForEmail(m,{redirectTo:`${window.location.origin}/auth/reset-password`});return n?{success:!1,error:n.message}:{success:!0}}catch(g){return console.error("Password reset error:",g),{success:!1,error:g.message||"Password reset failed"}}},W=async()=>{try{(await B.getSupabase()).auth.onAuthStateChange((g,n)=>{var i;switch(console.log("Auth state changed:",g,(i=n==null?void 0:n.user)==null?void 0:i.email),g){case"SIGNED_IN":n!=null&&n.user&&a();break;case"SIGNED_OUT":r.value={user:null,isAuthenticated:!1,isLoading:!1,error:null},c.clearSessionCookie(c.ACCESS_COOKIE),c.clearSessionCookie(c.REFRESH_COOKIE),c.clearLocalStorageTokens();break;case"TOKEN_REFRESHED":n!=null&&n.access_token&&c.setSessionCookie(c.ACCESS_COOKIE,n.access_token),n!=null&&n.refresh_token&&c.setSessionCookie(c.REFRESH_COOKIE,n.refresh_token),c.syncCookiesToLocalStorage();break;case"USER_UPDATED":n!=null&&n.user&&a();break}})}catch(m){console.warn("Failed to setup auth listener:",m)}};return e.onMounted(async()=>{W(),await a()}),e.watch(()=>window.location.href,m=>{s.value=m}),{authState:e.computed(()=>r.value),isAuthenticated:e.computed(()=>r.value.isAuthenticated),user:e.computed(()=>r.value.user),isLoading:e.computed(()=>r.value.isLoading),checkAuthStatus:a,loginWithEmail:v,signupWithEmail:_,loginWithProvider:C,logout:I,resetPassword:N,currentUrl:e.computed(()=>s.value)}}const no={class:"login-container"},lo={class:"logo-section"},io={class:"login-buttons"},co={key:0,class:"forgot-password"},uo={class:"signup-link"},po=e.defineComponent({__name:"LoginModal",props:{modelValue:{type:Boolean}},emits:["update:modelValue","login-success"],setup(r,{emit:s}){const a=r,v=s,_=e.computed({get:()=>a.modelValue,set:f=>v("update:modelValue",f)}),C=e.ref(!1),I=e.ref(!1),N=e.ref(),{loginWithEmail:W,signupWithEmail:m,loginWithProvider:g,resetPassword:n}=Ae(),i=e.reactive({email:"",password:"",confirmPassword:""}),A=e.computed(()=>({email:[{required:!0,message:"Please enter your email",trigger:"blur"},{type:"email",message:"Please enter a valid email",trigger:"blur"}],password:[{required:!0,message:"Please enter your password",trigger:"blur"},{min:6,message:"Password must be at least 6 characters",trigger:"blur"}],...C.value?{confirmPassword:[{required:!0,message:"Please confirm your password",trigger:"blur"},{validator:(f,w,F)=>{w!==i.password?F(new Error("Passwords do not match")):F()},trigger:"blur"}]}:{}})),S=()=>{var f;C.value=!C.value,i.email="",i.password="",i.confirmPassword="",(f=N.value)==null||f.clearValidate()},u=()=>{var f;_.value=!1,i.email="",i.password="",i.confirmPassword="",C.value=!1,(f=N.value)==null||f.clearValidate()},V=async()=>{if(N.value)try{await N.value.validate(),I.value=!0,C.value?await k():await R()}catch(f){console.error("Form validation failed:",f)}finally{I.value=!1}},R=async()=>{const f=await W(i.email,i.password);f.success?(x.ElMessage.success("Login successful"),v("login-success",{email:i.email}),u()):x.ElMessage.error("Login failed: "+f.error)},k=async()=>{const f=await m(i.email,i.password);f.success?f.needsConfirmation?x.ElMessage.success("Please check your email to confirm your account"):(x.ElMessage.success("Account created successfully"),v("login-success",{email:i.email}),u()):x.ElMessage.error("Signup failed: "+f.error)},d=async f=>{const w=await g(f);w.success?x.ElMessage.success("Redirecting to login provider..."):x.ElMessage.error("Login failed: "+w.error)},b=async()=>{if(!i.email){x.ElMessage.warning("Please enter your email address first");return}const f=await n(i.email);f.success?x.ElMessage.success("Password reset email sent! Please check your inbox."):x.ElMessage.error("Failed to send reset email: "+f.error)};return(f,w)=>{const F=e.resolveComponent("el-icon"),H=e.resolveComponent("el-input"),G=e.resolveComponent("el-form-item"),O=e.resolveComponent("el-button"),K=e.resolveComponent("el-dialog");return e.openBlock(),e.createBlock(K,{modelValue:_.value,"onUpdate:modelValue":w[6]||(w[6]=h=>_.value=h),title:"",width:"500px","close-on-click-modal":!1,"close-on-press-escape":!0,"show-close":!0,class:"login-modal",onClose:u},{default:e.withCtx(()=>[e.createElementVNode("div",no,[e.createElementVNode("div",lo,[e.createElementVNode("h2",null,e.toDisplayString(C.value?"Create Account":"Welcome Back"),1),e.createElementVNode("p",null,e.toDisplayString(C.value?"Sign up to get started with your account":"Sign in to continue to your account"),1)]),e.createVNode(e.unref(x.ElForm),{model:i,rules:A.value,ref_key:"formRef",ref:N,class:"login-form",onSubmit:e.withModifiers(V,["prevent"])},{default:e.withCtx(()=>[e.createVNode(G,{prop:"email"},{default:e.withCtx(()=>[e.createVNode(H,{modelValue:i.email,"onUpdate:modelValue":w[0]||(w[0]=h=>i.email=h),placeholder:"Email",type:"email",size:"large",class:"form-input"},{prefix:e.withCtx(()=>[e.createVNode(F,null,{default:e.withCtx(()=>[e.createVNode(e.unref(Ze))]),_:1})]),_:1},8,["modelValue"])]),_:1}),e.createVNode(G,{prop:"password"},{default:e.withCtx(()=>[e.createVNode(H,{modelValue:i.password,"onUpdate:modelValue":w[1]||(w[1]=h=>i.password=h),placeholder:"Password",type:"password",size:"large","show-password":"",class:"form-input"},{prefix:e.withCtx(()=>[e.createVNode(F,null,{default:e.withCtx(()=>[e.createVNode(e.unref(_e))]),_:1})]),_:1},8,["modelValue"])]),_:1}),C.value?(e.openBlock(),e.createBlock(G,{key:0,prop:"confirmPassword"},{default:e.withCtx(()=>[e.createVNode(H,{modelValue:i.confirmPassword,"onUpdate:modelValue":w[2]||(w[2]=h=>i.confirmPassword=h),placeholder:"Confirm Password",type:"password",size:"large","show-password":"",class:"form-input"},{prefix:e.withCtx(()=>[e.createVNode(F,null,{default:e.withCtx(()=>[e.createVNode(e.unref(_e))]),_:1})]),_:1},8,["modelValue"])]),_:1})):e.createCommentVNode("",!0),e.createVNode(G,null,{default:e.withCtx(()=>[e.createVNode(O,{type:"primary",class:"submit-button",loading:I.value,onClick:V,size:"large"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(C.value?"Sign Up":"Sign In"),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model","rules"]),w[10]||(w[10]=e.createElementVNode("div",{class:"divider"},[e.createElementVNode("span",null,"Or continue with")],-1)),e.createElementVNode("div",io,[e.createVNode(O,{class:"login-button google",onClick:w[3]||(w[3]=h=>d("google")),size:"large"},{default:e.withCtx(()=>[...w[7]||(w[7]=[e.createElementVNode("span",{class:"social-icon"},"G",-1),e.createTextVNode(" Google ",-1)])]),_:1}),e.createVNode(O,{class:"login-button github",onClick:w[4]||(w[4]=h=>d("github")),size:"large"},{default:e.withCtx(()=>[...w[8]||(w[8]=[e.createElementVNode("span",{class:"social-icon"},"âš¡",-1),e.createTextVNode(" GitHub ",-1)])]),_:1}),e.createVNode(O,{class:"login-button twitter",onClick:w[5]||(w[5]=h=>d("twitter")),size:"large"},{default:e.withCtx(()=>[...w[9]||(w[9]=[e.createElementVNode("span",{class:"social-icon"},"X",-1),e.createTextVNode(" X (Twitter) ",-1)])]),_:1})]),w[11]||(w[11]=e.createElementVNode("div",{class:"terms"}," By continuing, you agree to AI Workspace's Terms of Service and Privacy Policy ",-1)),C.value?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("div",co,[e.createElementVNode("a",{href:"#",onClick:e.withModifiers(b,["prevent"])},"Forgot Password?")])),e.createElementVNode("div",uo,[e.createTextVNode(e.toDisplayString(C.value?"Already have an account?":"Don't have an account?")+" ",1),e.createElementVNode("a",{href:"#",onClick:e.withModifiers(S,["prevent"])},e.toDisplayString(C.value?"Sign in":"Sign up"),1)])])]),_:1},8,["modelValue"])}}});const le=(r,s)=>{const a=r.__vccOpts||r;for(const[v,_]of s)a[v]=_;return a},Le=le(po,[["__scopeId","data-v-684a3f28"]]),fo={class:"session-loss-content"},go={class:"session-loss-icon"},ho={class:"session-loss-message"},mo={key:0,class:"session-loss-details"},ko={class:"detail-item"},wo={class:"detail-value"},vo={class:"detail-item"},_o={class:"detail-value"},So={class:"session-loss-actions"},Co={key:0,class:"retry-status"},yo={class:"retry-message"},Eo=e.defineComponent({__name:"SessionLossModal",props:{modelValue:{type:Boolean},sessionLossEvent:{},canRetrySession:{type:Boolean}},emits:["update:modelValue","retry","login","refresh"],setup(r,{emit:s}){const a=r,v=s,_=e.ref(!1),C=e.ref(0),I=e.ref(void 0),N=e.ref(""),W=e.computed({get:()=>a.modelValue,set:S=>v("update:modelValue",S)}),m=S=>{switch(S){case"session_expired":return"Authentication session has expired";case"token_invalid":return"Authentication token is invalid or corrupted";case"network_error":return"Network connection issue detected";case"manual_check_failed":return"Session validation failed";default:return"Unknown authentication issue"}},g=S=>S.toLocaleString(),n=async()=>{if(_.value)return;_.value=!0,C.value=0,I.value=void 0,N.value="Attempting to restore session...";const S=setInterval(()=>{C.value<90&&(C.value+=Math.random()*20)},200);try{v("retry"),await new Promise(u=>setTimeout(u,2e3)),C.value=100,I.value="success",N.value="Session restored successfully!",setTimeout(()=>{W.value=!1},1e3)}catch{C.value=100,I.value="exception",N.value="Failed to restore session. Please log in again.",x.ElMessage.error("Session restoration failed")}finally{clearInterval(S),setTimeout(()=>{_.value=!1,C.value=0,I.value=void 0,N.value=""},3e3)}},i=()=>{v("login"),W.value=!1},A=()=>{v("refresh"),window.location.reload()};return e.watch(()=>a.sessionLossEvent,S=>{S&&(_.value=!1,C.value=0,I.value=void 0,N.value="")}),(S,u)=>(e.openBlock(),e.createBlock(e.unref(x.ElDialog),{modelValue:W.value,"onUpdate:modelValue":u[0]||(u[0]=V=>W.value=V),title:"Session Expired",width:"500px","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1,class:"session-loss-modal",center:""},{default:e.withCtx(()=>{var V;return[e.createElementVNode("div",fo,[e.createElementVNode("div",go,[e.createVNode(e.unref(x.ElIcon),{size:"48",color:"#f56c6c"},{default:e.withCtx(()=>[e.createVNode(e.unref(Ce))]),_:1})]),e.createElementVNode("div",ho,[u[3]||(u[3]=e.createElementVNode("h3",null,"Your session has expired",-1)),e.createElementVNode("p",null,e.toDisplayString(((V=S.sessionLossEvent)==null?void 0:V.message)||"Please log in again to continue using the application."),1),S.sessionLossEvent?(e.openBlock(),e.createElementBlock("div",mo,[e.createElementVNode("div",ko,[u[1]||(u[1]=e.createElementVNode("span",{class:"detail-label"},"Issue:",-1)),e.createElementVNode("span",wo,e.toDisplayString(m(S.sessionLossEvent.type)),1)]),e.createElementVNode("div",vo,[u[2]||(u[2]=e.createElementVNode("span",{class:"detail-label"},"Time:",-1)),e.createElementVNode("span",_o,e.toDisplayString(g(S.sessionLossEvent.timestamp)),1)])])):e.createCommentVNode("",!0)]),e.createElementVNode("div",So,[S.canRetrySession&&!_.value?(e.openBlock(),e.createBlock(e.unref(x.ElButton),{key:0,type:"primary",onClick:n,loading:_.value},{default:e.withCtx(()=>[e.createVNode(e.unref(x.ElIcon),null,{default:e.withCtx(()=>[e.createVNode(e.unref(Se))]),_:1}),u[4]||(u[4]=e.createTextVNode(" Try Again ",-1))]),_:1},8,["loading"])):e.createCommentVNode("",!0),e.createVNode(e.unref(x.ElButton),{type:"primary",onClick:i,disabled:_.value},{default:e.withCtx(()=>[e.createVNode(e.unref(x.ElIcon),null,{default:e.withCtx(()=>[e.createVNode(e.unref(pe))]),_:1}),u[5]||(u[5]=e.createTextVNode(" Log In ",-1))]),_:1},8,["disabled"]),S.canRetrySession?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(e.unref(x.ElButton),{key:1,type:"info",onClick:A,disabled:_.value},{default:e.withCtx(()=>[e.createVNode(e.unref(x.ElIcon),null,{default:e.withCtx(()=>[e.createVNode(e.unref(Se))]),_:1}),u[6]||(u[6]=e.createTextVNode(" Refresh Page ",-1))]),_:1},8,["disabled"]))]),_.value?(e.openBlock(),e.createElementBlock("div",Co,[e.createVNode(e.unref(x.ElProgress),{percentage:C.value,status:I.value,"stroke-width":6},null,8,["percentage","status"]),e.createElementVNode("p",yo,e.toDisplayString(N.value),1)])):e.createCommentVNode("",!0)])]}),_:1},8,["modelValue"]))}});const xe=le(Eo,[["__scopeId","data-v-0dd27f7f"]]),bo={class:"aiworkspace-header"},Vo={key:0,class:"header-content header-loading"},No={class:"header-center"},Io={class:"loading-text"},Ao={key:0},Lo={key:1},xo={key:1,class:"header-content header-fallback"},Ro={key:2,class:"header-content header-restricted"},Mo={class:"header-center"},Bo={class:"restricted-text"},Oo={class:"header-right"},Wo={key:3,class:"header-content"},$o={class:"header-left"},Po={class:"logo-section"},Uo={href:"/",class:"logo"},Do=["src"],To={key:1,class:"text-logo"},Fo={key:0,class:"header-center"},Ho={class:"main-navigation"},zo={class:"nav-item"},Ko={href:"https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard",class:"nav-link"},qo={class:"workspace-dropdown-item"},Go=["href"],Yo={class:"workspace-icon"},Jo={key:1,class:"nav-divider"},jo={class:"nav-item"},Xo=["href","onClick"],Zo={class:"header-right"},Qo={class:"user-profile"},es={class:"user-info"},os={class:"user-name"},ss={class:"user-avatar"},ts=["src","alt"],as={key:1,class:"avatar-placeholder"},rs={key:4,class:"header-content header-unauthenticated"},ns={class:"header-left"},ls={class:"logo-section"},is={href:"/",class:"logo"},cs=["src"],us={key:1,class:"text-logo"},ds={class:"header-right"},ps={class:"workspace-list"},fs=["onClick"],gs={class:"workspace-icon"},hs={class:"workspace-details"},ms={class:"workspace-members"},ks={key:0,class:"current-indicator"},se=50,ws=e.defineComponent({__name:"AIWorkspaceHeader",props:{customLogo:{default:""},customLinks:{default:()=>[]},showUserMenu:{type:Boolean,default:!0},showWorkspaceSelector:{type:Boolean,default:!0},showSecondaryNavigation:{type:Boolean,default:!0},currentWorkspaceId:{},onProfileClick:{},onSettingsClick:{},onWorkspaceChange:{},onLogout:{},onLogin:{}},emits:["workspaceChange","logout","login","profileClick","settingsClick"],setup(r,{emit:s}){const a=r,v=s,{authState:_,logout:C,isLoading:I}=ye(),{isSessionValid:N,sessionLossEvent:W,hasSessionLoss:m,canRetrySession:g,retrySession:n,clearSessionLoss:i}=Ne(),A=()=>{try{return Ie()}catch{return console.warn("[AIWorkspaceHeader] Pinia not initialized yet, using fallback state"),null}},S=()=>{try{return typeof window<"u"?!!window.__PINIA__||!!window.Pinia:!1}catch{return!1}},u=e.ref(A()),V=e.computed(()=>!!u.value),R=e.ref(0),k=()=>{if(!u.value&&R.value<se){if(S()){const t=A();if(t){u.value=t,console.log("[AIWorkspaceHeader] Pinia store initialized successfully");return}}R.value++,setTimeout(k,100)}else R.value>=se&&console.warn("[AIWorkspaceHeader] Pinia initialization failed after maximum retries, using fallback mode")};e.onMounted(()=>{u.value||k()});const d=e.ref(!1),b=e.ref(!1),f=e.ref(!1),w=e.ref([]),F=e.ref([]),H=e.ref({name:"",email:"",avatar_url:null,initials:""}),G=e.ref([]),O=e.ref([]),K=e.ref(!1);e.watch(O,async t=>{t.length>0&&V.value&&M.value&&await D()},{immediate:!1}),e.watch(()=>window.location.pathname+window.location.search+window.location.hash,async()=>{V.value&&M.value&&await D()},{immediate:!1});const h=e.ref(window.location.pathname);e.watch(()=>window.location.pathname,t=>{h.value=t},{immediate:!0}),e.watch(V,t=>{!t&&R.value<se&&k()});const U=()=>{try{const t=window.location.pathname.match(/\/single-workspace\/(\d+)/);if(t)return t[1];const l=new URLSearchParams(window.location.search).get("workspace_id");if(l)return l;const p=window.location.hash.match(/workspace_id=(\d+)/);return p?p[1]:null}catch(t){return console.warn("[AIWorkspaceHeader] Error parsing URL for workspace_id:",t),null}},q=()=>{try{return window.location.pathname.includes("/all-workspace/")}catch(t){return console.warn("[AIWorkspaceHeader] Error checking all-workspace mode:",t),!1}},D=async()=>{if(!u.value||!V.value)return;const t=q();if(K.value=t,t){u.value.currentWorkspace=null,localStorage.removeItem("current_workspace"),console.log("[AIWorkspaceHeader] Auto-selected all-workspace mode from URL");return}const o=U();if(o)try{O.value.length===0&&await J();const l=O.value.find(p=>p.id.toString()===o);l?(u.value.setCurrentWorkspace(l),console.log(`[AIWorkspaceHeader] Auto-selected workspace from URL: ${l.title} (ID: ${l.id})`),v("workspaceChange",l)):console.warn(`[AIWorkspaceHeader] Workspace with ID ${o} not found in available workspaces`)}catch(l){console.error("[AIWorkspaceHeader] Error auto-selecting workspace from URL:",l)}},M=e.computed(()=>_.value.isAuthenticated),P=e.computed(()=>u.value?u.value.currentWorkspace:null),T=e.ref([{label:"Dashboard",key:"dashboard",url:"/dashboard"},{label:"Goals",key:"goals",url:"/goals"},{label:"Tasks",key:"tasks",url:"/tasks"},{label:"Events",key:"events",url:"/events"},{label:"Drive",key:"files",url:"/files"},{label:"Outlines",key:"outlines",url:"/outlines"},{label:"Communications",key:"communications",url:"/communications"},{label:"Canvas",key:"canvas",url:"/canvas"},{label:"AI Phone",key:"ai_phone",url:"/ai_phone"},{label:"AI Intake",key:"ai_intake",url:"/ai_intake"},{label:"AI Fax",key:"ai_fax",url:"/ai_fax"},{label:"AI Portfolios",key:"ai-portfolios",url:"/ai-portfolios"},{label:"AI Fund Analyst",key:"ai_fund_analyst",url:"/ai_fund_analyst"},{label:"Contacts",key:"contacts",url:"/contacts"},{label:"Settings",key:"settings",url:"/settings"}]),ee=e.ref([{label:"Dashboard",key:"dashboard",url:"/dashboard"},{label:"All Tasks",key:"tasks",url:"/tasks"},{label:"All Goals",key:"goals",url:"/goals"},{label:"All Events",key:"events",url:"/events"},{label:"All Drive",key:"files",url:"/files"},{label:"All Contacts",key:"contacts",url:"/contacts"},{label:"All Settings",key:"settings",url:"/settings"}]),Y=e.computed(()=>K.value?ee.value:T.value),Z=e.computed(()=>{try{const t=h.value;let o="";const l=t.match(/\/all-workspace\/([^\/]+)/);if(l)o=l[1];else{const p=t.match(/\/single-workspace\/\d+\/([^\/]+)/);if(p)o=p[1];else{const $=t.match(/\/([^\/]+)$/);$&&(o=$[1])}}if(o){const p=Y.value.find($=>$.key===o||$.url.includes(`/${o}`)||$.url===`/${o}`);if(p)return p.label}return"Dashboard"}catch(t){return console.warn("[AIWorkspaceHeader] Error determining current section:",t),"Dashboard"}}),y=t=>{const o=new Map;t.forEach($=>{o.set($.id,{...$,children:[]})});const l=[];o.forEach($=>{$.parent_workspace_id&&o.has($.parent_workspace_id)?o.get($.parent_workspace_id).children.push($):l.push($)});const p=$=>{$.sort((z,j)=>z.title.localeCompare(j.title)),$.forEach(z=>{z.children&&p(z.children)})};return p(l),l},L=(t,o=0,l=[])=>(t.forEach(p=>{l.push({...p,level:o}),p.children&&p.children.length&&L(p.children,o+1,l)}),l),J=async()=>{var t,o,l;try{const p=await((t=u.value)==null?void 0:t.loadWorkspaces());if(G.value=y(p||[]),O.value=L(G.value),F.value=O.value,w.value=O.value,a.currentWorkspaceId){const $=O.value.find(z=>{var j;return z.id.toString()===((j=a.currentWorkspaceId)==null?void 0:j.toString())});$&&((o=u.value)==null||o.setCurrentWorkspace($))}else!P.value&&O.value.length&&((l=u.value)==null||l.setCurrentWorkspace(O.value[0]))}catch(p){console.error("loadWorkspaces (header) error",p)}},te=t=>{if(console.log("Navigation command:",t),t==="all-workspace"){window.location.href="https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard";return}else{const o=parseInt(t.replace("workspace-",""));window.location.href=`https://single-ws-dashboard.aiworkspace.pro/single-workspace/${o}/dashboard`;return}},me=t=>{const o=P.value,l=K.value;switch(t.key){case"dashboard":l?window.location.href="https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard":o?window.location.href=`https://single-ws-dashboard.aiworkspace.pro/single-workspace/${o.id}/dashboard`:window.location.href="https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard";break;case"outlines":if(l)window.location.href="https://outline.aiworkspace.pro/all-workspace/outlines";else if(o){const p=`https://outline.aiworkspace.pro/single-workspace/${o.id}/outlines`;window.location.href=p}else window.location.href="https://outline.aiworkspace.pro";break;case"canvas":if(l)window.location.href="https://canvas.aiworkspace.pro/all-workspace/canvas";else if(o){const p=`https://canvas.aiworkspace.pro/single-workspace/${o.id}/canvas`;window.location.href=p}else window.location.href="https://canvas.aiworkspace.pro";break;case"files":if(l)window.location.href="https://drive.aiworkspace.pro/all-workspace/files";else if(o){const p=`https://drive.aiworkspace.pro/single-workspace/${o.id}/files`;window.location.href=p}else window.location.href="https://drive.aiworkspace.pro";break;case"tasks":if(l)window.location.href="https://tasks.aiworkspace.pro/all-workspace/tasks";else if(o){const p=`https://tasks.aiworkspace.pro/single-workspace/${o.id}/tasks`;window.location.href=p}else window.location.href="https://tasks.aiworkspace.pro";break;case"goals":if(l)window.location.href="https://app.aiworkspace.pro/all-workspace/goals";else if(o){const p=`https://app.aiworkspace.pro/single-workspace/${o.id}/goals`;window.location.href=p}else window.location.href="https://app.aiworkspace.pro/all-workspace/goals";break;case"events":if(l)window.location.href="https://app.aiworkspace.pro/all-workspace/events";else if(o){const p=`https://app.aiworkspace.pro/single-workspace/${o.id}/events`;window.location.href=p}else window.location.href="https://app.aiworkspace.pro/all-workspace/events";break;case"contacts":if(l)window.location.href="https://app.aiworkspace.pro/all-workspace/contacts";else if(o){const p=`https://app.aiworkspace.pro/single-workspace/${o.id}/contacts`;window.location.href=p}else window.location.href="https://app.aiworkspace.pro/all-workspace/contacts";break;case"ai-portfolios":if(l)window.location.href="https://spreadsheet.aiworkspace.pro/all-workspace/ai-portfolios";else if(o){const p=`https://spreadsheet.aiworkspace.pro/single-workspace/${o.id}/ai-portfolios`;window.location.href=p}else window.location.href="https://spreadsheet.aiworkspace.pro";break;case"settings":if(l)window.location.href="https://settings.aiworkspace.pro/all-workspace/settings";else if(o){const p=`https://settings.aiworkspace.pro/single-workspace/${o.id}/settings`;window.location.href=p}else window.location.href="https://settings.aiworkspace.pro";break;default:if(l){const p=`https://app.aiworkspace.pro/all-workspace/${t.key}`;window.location.href=p}else if(o){const p=`https://app.aiworkspace.pro/single-workspace/${o.id}/${t.key}`;window.location.href=p}else{const p=`https://app.aiworkspace.pro/${t.key}`;window.location.href=p}break}},ce=t=>{const o=P.value,l=K.value;switch(t.key){case"dashboard":return l?"https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard":o?`https://single-ws-dashboard.aiworkspace.pro/single-workspace/${o.id}/dashboard`:"https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard";case"ai-portfolios":return l?"https://spreadsheet.aiworkspace.pro/all-workspace/ai-portfolios":o?`https://spreadsheet.aiworkspace.pro/single-workspace/${o.id}/ai-portfolios`:"https://spreadsheet.aiworkspace.pro";case"outlines":return l?"https://outline.aiworkspace.pro/all-workspace/outlines":o?`https://outline.aiworkspace.pro/single-workspace/${o.id}/outlines`:"https://outline.aiworkspace.pro";case"canvas":return l?"https://canvas.aiworkspace.pro/all-workspace/canvas":o?`https://canvas.aiworkspace.pro/single-workspace/${o.id}/canvas`:"https://canvas.aiworkspace.pro";case"files":return l?"https://drive.aiworkspace.pro/all-workspace/files":o?`https://drive.aiworkspace.pro/single-workspace/${o.id}/files`:"https://drive.aiworkspace.pro";case"tasks":return l?"https://tasks.aiworkspace.pro/all-workspace/tasks":o?`https://tasks.aiworkspace.pro/single-workspace/${o.id}/tasks`:"https://tasks.aiworkspace.pro";case"goals":return l?"https://app.aiworkspace.pro/all-workspace/goals":o?`https://app.aiworkspace.pro/single-workspace/${o.id}/goals`:"https://app.aiworkspace.pro/all-workspace/goals";case"events":return l?"https://app.aiworkspace.pro/all-workspace/events":o?`https://app.aiworkspace.pro/single-workspace/${o.id}/events`:"https://app.aiworkspace.pro/all-workspace/events";case"contacts":return l?"https://app.aiworkspace.pro/all-workspace/contacts":o?`https://app.aiworkspace.pro/single-workspace/${o.id}/contacts`:"https://app.aiworkspace.pro/all-workspace/contacts";case"settings":return l?"https://settings.aiworkspace.pro/all-workspace/settings":o?`https://settings.aiworkspace.pro/single-workspace/${o.id}/settings`:"https://settings.aiworkspace.pro";default:return l?`https://app.aiworkspace.pro/all-workspace/${t.key}`:o?`https://app.aiworkspace.pro/single-workspace/${o.id}/${t.key}`:`https://app.aiworkspace.pro/${t.key}`}},ae=t=>{switch(t){case"profile":a.onProfileClick?a.onProfileClick():x.ElMessage.info("Profile settings coming soon");break;case"workspaces":d.value=!0;break;case"logout":We();break}},ke=t=>{var o;(o=u.value)==null||o.setCurrentWorkspace(t),d.value=!1,v("workspaceChange",t),x.ElMessage.success(`Switched to ${t.title}`)},Oe=()=>{x.ElMessageBox.prompt("Enter workspace name:","Create New Workspace",{confirmButtonText:"Create",cancelButtonText:"Cancel",inputPattern:/\S/,inputErrorMessage:"Workspace name cannot be empty"}).then(({value:t})=>{var l;const o={id:Date.now(),title:t,description:"New workspace",archived:!1,created_by:"",created_at:new Date().toISOString(),latest_activity:new Date().toISOString(),hasAccess:!0,accessType:"edit"};w.value.push(o),(l=u.value)==null||l.setWorkspaces(w.value),ke(o),x.ElMessage.success(`Created workspace: ${t}`)}).catch(()=>{})},We=()=>{x.ElMessageBox.confirm("Are you sure you want to sign out?","Sign Out",{confirmButtonText:"Sign Out",cancelButtonText:"Cancel",type:"warning"}).then(async()=>{var t;(t=u.value)==null||t.clearData(),await C(),typeof window<"u"&&window.dispatchEvent(new CustomEvent("session-logout-detected",{detail:{timestamp:new Date,source:"manual-logout"}})),v("logout"),x.ElMessage.success("Signed out successfully")}).catch(()=>{})},ue=async()=>{var t,o;if(_.value.user){const l=_.value.user;H.value={name:l.name||((t=l.email)==null?void 0:t.split("@")[0])||"User",email:l.email||"",avatar_url:l.avatar_url||null,initials:(l.name||((o=l.email)==null?void 0:o.split("@")[0])||"U").split(" ").map(p=>p[0]).join("").toUpperCase().substring(0,2)},a.showWorkspaceSelector&&await J()}};e.watch(()=>_.value.user,t=>{var o;t?ue():(H.value={name:"",email:"",avatar_url:null,initials:""},(o=u.value)==null||o.clearData())}),e.watch(m,t=>{t&&M.value&&(console.log("[AIWorkspaceHeader] Session loss detected, showing modal"),f.value=!0)}),e.watch(()=>a.currentWorkspaceId,t=>{var o;if(t&&O.value.length){const l=O.value.find(p=>p.id.toString()===t.toString());l&&((o=u.value)==null||o.setCurrentWorkspace(l))}}),e.onMounted(async()=>{M.value&&(await ue(),await D())});const $e=async t=>{console.log("Login successful:",t),b.value=!1,await ue(),v("login"),x.ElMessage.success("Welcome back!")},Pe=async()=>{console.log("[AIWorkspaceHeader] Retrying session..."),await n()?(f.value=!1,i(),x.ElMessage.success("Session restored successfully!")):x.ElMessage.error("Failed to restore session. Please log in again.")},Ue=()=>{console.log("[AIWorkspaceHeader] Opening login modal from session loss"),f.value=!1,b.value=!0},De=()=>{console.log("[AIWorkspaceHeader] Refreshing page due to session loss"),window.location.reload()},Te=()=>{R.value=0,k(),x.ElMessage.success("Manual Pinia retry initiated.")};return(t,o)=>{const l=e.resolveComponent("el-icon"),p=e.resolveComponent("el-button"),$=e.resolveComponent("el-tag"),z=e.resolveComponent("el-dropdown-item"),j=e.resolveComponent("el-dropdown-menu"),de=e.resolveComponent("el-dropdown"),Fe=e.resolveComponent("el-dialog");return e.openBlock(),e.createElementBlock("header",bo,[!V.value&&R.value<se||e.unref(I)?(e.openBlock(),e.createElementBlock("div",Vo,[o[10]||(o[10]=e.createStaticVNode('<div class="header-left" data-v-2d5d4116><div class="logo-section" data-v-2d5d4116><a href="/" class="logo" data-v-2d5d4116><div class="text-logo" data-v-2d5d4116><span class="logo-text" data-v-2d5d4116>AI Workspace</span></div></a></div></div>',1)),e.createElementVNode("div",No,[e.createElementVNode("span",Io,[e.unref(I)?(e.openBlock(),e.createElementBlock("span",Ao,"Syncing authentication...")):(e.openBlock(),e.createElementBlock("span",Lo,"Initializing..."))])])])):!V.value&&R.value>=se?(e.openBlock(),e.createElementBlock("div",xo,[o[12]||(o[12]=e.createStaticVNode('<div class="header-left" data-v-2d5d4116><div class="logo-section" data-v-2d5d4116><a href="/" class="logo" data-v-2d5d4116><div class="text-logo" data-v-2d5d4116><span class="logo-text" data-v-2d5d4116>AI Workspace</span></div></a></div></div>',1)),e.createElementVNode("div",{class:"header-center"},[o[11]||(o[11]=e.createElementVNode("span",{class:"fallback-text"},"Header Ready (Fallback Mode)",-1)),e.createElementVNode("button",{onClick:Te,class:"retry-button"},"Retry Pinia")]),o[13]||(o[13]=e.createStaticVNode('<div class="header-right" data-v-2d5d4116><div class="user-profile" data-v-2d5d4116><div class="user-info" data-v-2d5d4116><span class="user-name" data-v-2d5d4116>User</span></div><div class="user-avatar" data-v-2d5d4116><span class="avatar-placeholder" data-v-2d5d4116>U</span></div></div></div>',1))])):M.value&&!e.unref(N)?(e.openBlock(),e.createElementBlock("div",Ro,[o[16]||(o[16]=e.createStaticVNode('<div class="header-left" data-v-2d5d4116><div class="logo-section" data-v-2d5d4116><a href="/" class="logo" data-v-2d5d4116><div class="text-logo" data-v-2d5d4116><span class="logo-text" data-v-2d5d4116>AI Workspace</span></div></a></div></div>',1)),e.createElementVNode("div",Mo,[e.createElementVNode("span",Bo,[e.createVNode(l,null,{default:e.withCtx(()=>[e.createVNode(e.unref(Ce))]),_:1}),o[14]||(o[14]=e.createTextVNode(" Session expired - Please log in again ",-1))])]),e.createElementVNode("div",Oo,[e.createVNode(p,{type:"primary",onClick:o[0]||(o[0]=E=>b.value=!0)},{default:e.withCtx(()=>[e.createVNode(l,null,{default:e.withCtx(()=>[e.createVNode(e.unref(pe))]),_:1}),o[15]||(o[15]=e.createTextVNode(" Log In ",-1))]),_:1})])])):M.value&&e.unref(N)?(e.openBlock(),e.createElementBlock("div",Wo,[e.createElementVNode("div",$o,[e.createElementVNode("div",Po,[e.createElementVNode("a",Uo,[t.customLogo?(e.openBlock(),e.createElementBlock("img",{key:0,src:t.customLogo,alt:"AIWorkspace",class:"logo-image"},null,8,Do)):(e.openBlock(),e.createElementBlock("div",To,[...o[17]||(o[17]=[e.createElementVNode("span",{class:"logo-text"},"AI Workspace",-1)])]))])])]),t.showSecondaryNavigation?(e.openBlock(),e.createElementBlock("div",Fo,[e.createElementVNode("nav",Ho,[t.showWorkspaceSelector?(e.openBlock(),e.createBlock(de,{key:0,onCommand:te,trigger:"hover"},{dropdown:e.withCtx(()=>[e.createVNode(j,{class:"workspace-tree-dropdown"},{default:e.withCtx(()=>[e.createVNode(z,{command:"all-workspace",class:e.normalizeClass({active:K.value})},{default:e.withCtx(()=>[e.createElementVNode("a",Ko,[e.createElementVNode("div",qo,[o[19]||(o[19]=e.createElementVNode("span",{class:"workspace-icon"},"ðŸŒ",-1)),o[20]||(o[20]=e.createElementVNode("span",null,"All workspace",-1)),K.value?(e.openBlock(),e.createBlock($,{key:0,size:"small",type:"success"},{default:e.withCtx(()=>[...o[18]||(o[18]=[e.createTextVNode("Current",-1)])]),_:1})):e.createCommentVNode("",!0)])])]),_:1},8,["class"]),O.value.length>0?(e.openBlock(),e.createBlock(z,{key:0,divided:"",disabled:""})):e.createCommentVNode("",!0),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(O.value,E=>(e.openBlock(),e.createBlock(z,{key:E.id,command:`workspace-${E.id}`},{default:e.withCtx(()=>{var oe;return[e.createElementVNode("a",{href:`https://single-ws-dashboard.aiworkspace.pro/single-workspace/${E.id}/dashboard`,class:"nav-link"},[e.createElementVNode("div",{class:"workspace-dropdown-item",style:e.normalizeStyle({paddingLeft:(E.level||0)*16+"px"})},[e.createElementVNode("span",Yo,e.toDisplayString(E.children&&E.children.length?"ðŸ“":"ðŸ“„"),1),e.createElementVNode("span",null,e.toDisplayString(E.title),1),E.id===((oe=P.value)==null?void 0:oe.id)?(e.openBlock(),e.createBlock($,{key:0,size:"small",type:"success"},{default:e.withCtx(()=>[...o[21]||(o[21]=[e.createTextVNode("Current",-1)])]),_:1})):e.createCommentVNode("",!0)],4)],8,Go)]}),_:2},1032,["command"]))),128)),O.value.length===0?(e.openBlock(),e.createBlock(z,{key:1,disabled:""},{default:e.withCtx(()=>[...o[22]||(o[22]=[e.createTextVNode(" No workspaces ",-1)])]),_:1})):e.createCommentVNode("",!0)]),_:1})]),default:e.withCtx(()=>{var E;return[e.createElementVNode("span",zo,[e.createTextVNode(e.toDisplayString(K.value?"All workspace":((E=P.value)==null?void 0:E.title)||"Select Workspace")+" ",1),e.createVNode(l,{class:"nav-arrow"},{default:e.withCtx(()=>[e.createVNode(e.unref(ve))]),_:1})])]}),_:1})):e.createCommentVNode("",!0),t.showWorkspaceSelector?(e.openBlock(),e.createElementBlock("span",Jo,"/")):e.createCommentVNode("",!0),t.showSecondaryNavigation?(e.openBlock(),e.createBlock(de,{key:2,trigger:"hover"},{dropdown:e.withCtx(()=>[e.createVNode(j,null,{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(Y.value,E=>(e.openBlock(),e.createBlock(z,{key:E.label,class:e.normalizeClass({active:E.active})},{default:e.withCtx(()=>[e.createElementVNode("a",{href:ce(E),class:"nav-link",onClick:e.withModifiers(oe=>me(E),["prevent"])},e.toDisplayString(E.label),9,Xo)]),_:2},1032,["class"]))),128))]),_:1})]),default:e.withCtx(()=>[e.createElementVNode("span",jo,[e.createTextVNode(e.toDisplayString(Z.value)+" ",1),e.createVNode(l,{class:"nav-arrow"},{default:e.withCtx(()=>[e.createVNode(e.unref(ve))]),_:1})])]),_:1})):e.createCommentVNode("",!0)])])):e.createCommentVNode("",!0),e.createElementVNode("div",Zo,[e.createVNode(de,{onCommand:ae,trigger:"click",placement:"bottom-end"},{dropdown:e.withCtx(()=>[e.createVNode(j,null,{default:e.withCtx(()=>[e.createVNode(z,null,{default:e.withCtx(()=>[e.createElementVNode("a",{href:"/profile",class:"nav-link",onClick:o[1]||(o[1]=e.withModifiers(E=>ae("profile"),["prevent"]))},"Profile Settings")]),_:1}),t.showWorkspaceSelector?(e.openBlock(),e.createBlock(z,{key:0},{default:e.withCtx(()=>[e.createElementVNode("a",{href:"#switch-workspace",class:"nav-link",onClick:o[2]||(o[2]=e.withModifiers(E=>ae("workspaces"),["prevent"]))},"Switch Workspace")]),_:1})):e.createCommentVNode("",!0),e.createVNode(z,{divided:""},{default:e.withCtx(()=>[e.createElementVNode("a",{href:"#signout",class:"nav-link",onClick:o[3]||(o[3]=e.withModifiers(E=>ae("logout"),["prevent"]))},"Sign Out")]),_:1})]),_:1})]),default:e.withCtx(()=>[e.createElementVNode("div",Qo,[e.createElementVNode("div",es,[e.createElementVNode("span",os,e.toDisplayString(H.value.name),1)]),e.createElementVNode("div",ss,[H.value.avatar_url?(e.openBlock(),e.createElementBlock("img",{key:0,src:H.value.avatar_url,alt:H.value.name},null,8,ts)):(e.openBlock(),e.createElementBlock("span",as,e.toDisplayString(H.value.initials),1))])])]),_:1})])])):(e.openBlock(),e.createElementBlock("div",rs,[e.createElementVNode("div",ns,[e.createElementVNode("div",ls,[e.createElementVNode("a",is,[t.customLogo?(e.openBlock(),e.createElementBlock("img",{key:0,src:t.customLogo,alt:"AIWorkspace",class:"logo-image"},null,8,cs)):(e.openBlock(),e.createElementBlock("div",us,[...o[23]||(o[23]=[e.createElementVNode("span",{class:"logo-text"},"AI Workspace",-1)])]))])])]),o[25]||(o[25]=e.createElementVNode("div",{class:"header-center"},[e.createElementVNode("span",{class:"welcome-text"},"Welcome to AI Workspace")],-1)),e.createElementVNode("div",ds,[e.createVNode(p,{type:"primary",size:"large",class:"login-button",onClick:o[4]||(o[4]=E=>b.value=!0)},{default:e.withCtx(()=>[e.createVNode(l,null,{default:e.withCtx(()=>[e.createVNode(e.unref(pe))]),_:1}),o[24]||(o[24]=e.createTextVNode(" Login / Signup ",-1))]),_:1})])])),M.value&&t.showWorkspaceSelector?(e.openBlock(),e.createBlock(Fe,{key:5,modelValue:d.value,"onUpdate:modelValue":o[6]||(o[6]=E=>d.value=E),title:"Switch Workspace",width:"500px",onClose:o[7]||(o[7]=E=>d.value=!1)},{footer:e.withCtx(()=>[e.createVNode(p,{onClick:o[5]||(o[5]=E=>d.value=!1)},{default:e.withCtx(()=>[...o[26]||(o[26]=[e.createTextVNode("Cancel",-1)])]),_:1}),e.createVNode(p,{type:"primary",onClick:Oe},{default:e.withCtx(()=>[...o[27]||(o[27]=[e.createTextVNode("Create New Workspace",-1)])]),_:1})]),default:e.withCtx(()=>[e.createElementVNode("div",ps,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(w.value,E=>{var oe,we;return e.openBlock(),e.createElementBlock("div",{key:E.id,class:e.normalizeClass(["workspace-item",{active:E.id===((oe=P.value)==null?void 0:oe.id)}]),onClick:bs=>ke(E)},[e.createElementVNode("div",gs,e.toDisplayString(E.children&&E.children.length?"ðŸ“":"ðŸ“„"),1),e.createElementVNode("div",hs,[e.createElementVNode("h3",null,e.toDisplayString(E.title),1),e.createElementVNode("p",null,e.toDisplayString(E.description),1),e.createElementVNode("span",ms,e.toDisplayString(E.hasAccess?"Active":"Inactive"),1)]),E.id===((we=P.value)==null?void 0:we.id)?(e.openBlock(),e.createElementBlock("div",ks,[e.createVNode(l,null,{default:e.withCtx(()=>[e.createVNode(e.unref(Je))]),_:1})])):e.createCommentVNode("",!0)],10,fs)}),128))])]),_:1},8,["modelValue"])):e.createCommentVNode("",!0),e.createVNode(Le,{modelValue:b.value,"onUpdate:modelValue":o[8]||(o[8]=E=>b.value=E),onLoginSuccess:$e},null,8,["modelValue"]),e.createVNode(xe,{modelValue:f.value,"onUpdate:modelValue":o[9]||(o[9]=E=>f.value=E),"session-loss-event":e.unref(W),"can-retry-session":e.unref(g)||!1,onRetry:Pe,onLogin:Ue,onRefresh:De},null,8,["modelValue","session-loss-event","can-retry-session"])])}}});const vs=le(ws,[["__scopeId","data-v-2d5d4116"]]),_s={class:"auth-callback"},Ss=e.defineComponent({__name:"AuthCallback",setup(r){e.onMounted(async()=>{console.log("[AuthCallback] Component mounted, starting callback processing..."),console.log("[AuthCallback] Current URL:",window.location.href),console.log("[AuthCallback] Current hash:",window.location.hash);try{await new Promise(_=>setTimeout(_,500));const{data:a,error:v}=await B.supabase.auth.getSession();if(v){console.error("Error processing callback:",v),s();return}if(a!=null&&a.session){const _=a.session.user;console.log("OAuth login successful:",_.email),a.session.access_token&&c.setSessionCookie(c.ACCESS_COOKIE,a.session.access_token),a.session.refresh_token&&c.setSessionCookie(c.REFRESH_COOKIE,a.session.refresh_token),c.syncCookiesToLocalStorage();const C=c.getPostLoginBase();console.log("[callback] Post-login redirect URL:",C),console.log("[callback] Session storage redirect:",sessionStorage.getItem("post-login-redirect")),console.log("[callback] Local storage redirect:",localStorage.getItem("post-login-redirect"));const I=C||"/";if(console.log("[callback] Final redirect URL:",I),I.startsWith("/")){const N=window.location.origin,W=`${N}${I}`;console.log("[callback] redirecting to:",W,{hostname:window.location.hostname,origin:N}),sessionStorage.removeItem("post-login-redirect"),localStorage.removeItem("post-login-redirect"),setTimeout(()=>{window.location.href=W},100)}else console.log("[callback] redirecting to absolute URL:",I),sessionStorage.removeItem("post-login-redirect"),localStorage.removeItem("post-login-redirect"),setTimeout(()=>{window.location.href=I},100)}else s()}catch(a){console.error("Error processing callback:",a),s()}});const s=()=>{const v=window.location.href.replace("/auth/callback","");window.location.href=v};return(a,v)=>(e.openBlock(),e.createElementBlock("div",_s,[...v[0]||(v[0]=[e.createElementVNode("div",{class:"callback-container"},[e.createElementVNode("div",{class:"loading-spinner"},[e.createElementVNode("div",{class:"spinner"})]),e.createElementVNode("h2",null,"Processing login..."),e.createElementVNode("p",null,"Please wait while we complete your authentication.")],-1)])]))}});const Cs=le(Ss,[["__scopeId","data-v-acdf6325"]]),Q=class Q{constructor(){re(this,"validationCache",new Map);re(this,"CACHE_DURATION",he().validationCacheDuration)}static getInstance(){return Q.instance||(Q.instance=new Q),Q.instance}async validateSession(s=!1){const a="session_validation";if(!s){const v=this.validationCache.get(a);if(v&&Date.now()-v.timestamp<this.CACHE_DURATION)return console.log("[SessionValidator] Using cached validation result"),v.result}console.log("[SessionValidator] Validating session...");try{const v=c.getCookie(c.ACCESS_COOKIE),_=c.getCookie(c.REFRESH_COOKIE);if(!v||!_){const n={isValid:!1,needsLogin:!0,error:"No authentication tokens found",canRetry:!1};return this.cacheResult(a,n),n}const C=await B.getSupabase(),{data:{session:I},error:N}=await C.auth.getSession();if(N){console.warn("[SessionValidator] Error getting session:",N);const n={isValid:!1,needsLogin:!0,error:`Session error: ${N.message}`,canRetry:!0};return this.cacheResult(a,n),n}if(!I||!I.user){const n={isValid:!1,needsLogin:!0,error:"No valid session found",canRetry:!0};return this.cacheResult(a,n),n}const W=new Date,m=new Date(I.expires_at*1e3);if(W>=m){const n={isValid:!1,needsLogin:!0,error:"Session has expired",canRetry:!0};return this.cacheResult(a,n),n}const g={isValid:!0,needsLogin:!1,canRetry:!1};return this.cacheResult(a,g),g}catch(v){console.error("[SessionValidator] Error validating session:",v);const _={isValid:!1,needsLogin:!0,error:`Validation error: ${v}`,canRetry:!0};return this.cacheResult(a,_),_}}async restoreSession(){console.log("[SessionValidator] Attempting to restore session...");try{const s=c.getCookie(c.ACCESS_COOKIE),a=c.getCookie(c.REFRESH_COOKIE);if(!s||!a)return{isValid:!1,needsLogin:!0,error:"No tokens available for restoration",canRetry:!1};const v=await B.getSupabase(),{data:_,error:C}=await v.auth.setSession({access_token:s,refresh_token:a});return C?(console.warn("[SessionValidator] Error restoring session:",C),{isValid:!1,needsLogin:!0,error:`Restoration error: ${C.message}`,canRetry:!0}):_.session&&_.session.user?(console.log("[SessionValidator] Session restored successfully"),this.clearCache(),{isValid:!0,needsLogin:!1,canRetry:!1}):{isValid:!1,needsLogin:!0,error:"Session restoration failed",canRetry:!0}}catch(s){return console.error("[SessionValidator] Error restoring session:",s),{isValid:!1,needsLogin:!0,error:`Restoration error: ${s}`,canRetry:!0}}}clearCache(){this.validationCache.clear(),console.log("[SessionValidator] Cache cleared")}cacheResult(s,a){this.validationCache.set(s,{result:a,timestamp:Date.now()})}getCachedResult(){const s=this.validationCache.get("session_validation");return s&&Date.now()-s.timestamp<this.CACHE_DURATION?s.result:null}};re(Q,"instance");let ne=Q;const ie=ne.getInstance(),Re=(r=!1)=>ie.validateSession(r),Me=()=>ie.restoreSession(),Be=()=>ie.clearCache();async function ys(){console.log("[SessionValidator] Initializing session validation...");let r=await Re();return!r.isValid&&r.canRetry&&(console.log("[SessionValidator] Attempting session restoration..."),r=await Me()),r}function Es(){if(typeof window>"u")return()=>{};const r=()=>{console.log("[SessionValidator] Network restored, clearing cache for revalidation"),Be()},s=()=>{console.log("[SessionValidator] Network lost, session validation may fail")};return window.addEventListener("online",r),window.addEventListener("offline",s),()=>{window.removeEventListener("online",r),window.removeEventListener("offline",s)}}exports.initializeCrossSubdomainAuth=B.initializeCrossSubdomainAuth;exports.restoreCrossSubdomainSession=B.restoreCrossSubdomainSession;exports.restoreSessionWithRetry=B.restoreSessionWithRetry;exports.setupAuthStateListener=B.setupAuthStateListener;Object.defineProperty(exports,"supabase",{enumerable:!0,get:()=>B.supabase});exports.ACCESS_COOKIE=c.ACCESS_COOKIE;exports.LS_ACCESS_KEY=c.LS_ACCESS_KEY;exports.LS_REFRESH_KEY=c.LS_REFRESH_KEY;exports.REFRESH_COOKIE=c.REFRESH_COOKIE;exports.buildOAuthRedirectUrl=c.buildOAuthRedirectUrl;exports.clearLocalStorageTokens=c.clearLocalStorageTokens;exports.clearSessionCookie=c.clearSessionCookie;exports.ensureCrossSubdomainCookies=c.ensureCrossSubdomainCookies;exports.getCookie=c.getCookie;exports.getPostLoginBase=c.getPostLoginBase;exports.setSessionCookie=c.setSessionCookie;exports.syncCookiesToLocalStorage=c.syncCookiesToLocalStorage;exports.setupUniversalCallback=qe.setupUniversalCallback;exports.AIWorkspaceHeader=vs;exports.AuthCallback=Cs;exports.LoginModal=Le;exports.SessionLossModal=xe;exports.SessionValidator=ne;exports.clearSessionCache=Be;exports.conservativeConfig=be;exports.createSessionConfig=so;exports.defaultSessionConfig=X;exports.detectionScenarios=ro;exports.developmentConfig=fe;exports.fastDetectionConfig=Ee;exports.getConfigByPreset=to;exports.getSessionConfig=he;exports.initializeSessionValidation=ys;exports.productionConfig=ge;exports.restoreSession=Me;exports.sessionConfigPresets=Ve;exports.sessionValidator=ie;exports.setupNetworkAwareValidation=Es;exports.timingInfo=ao;exports.useAuth=Ae;exports.useEnhancedAuth=ye;exports.useSessionMonitor=Ne;exports.useWorkspaceStore=Ie;exports.validateSession=Re;
