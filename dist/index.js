"use strict";var Ge=Object.defineProperty;var Ye=(a,t,s)=>t in a?Ge(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s;var se=(a,t,s)=>(Ye(a,typeof t!="symbol"?t+"":t,s),s);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),M=require("element-plus"),R=require("./supabase-d792c7ea.js"),_=require("./utils/authRedirect.js"),je=require("pinia"),Je=require("./utils/universalCallback.js");/*! Element Plus Icons Vue v2.3.2 */var Xe=e.defineComponent({name:"ArrowDown",__name:"arrow-down",setup(a){return(t,s)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M831.872 340.864 512 652.672 192.128 340.864a30.59 30.59 0 0 0-42.752 0 29.12 29.12 0 0 0 0 41.6L489.664 714.24a32 32 0 0 0 44.672 0l340.288-331.712a29.12 29.12 0 0 0 0-41.728 30.59 30.59 0 0 0-42.752 0z"})]))}}),ve=Xe,Qe=e.defineComponent({name:"Check",__name:"check",setup(a){return(t,s)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M406.656 706.944 195.84 496.256a32 32 0 1 0-45.248 45.248l256 256 512-512a32 32 0 0 0-45.248-45.248L406.592 706.944z"})]))}}),Ze=Qe,eo=e.defineComponent({name:"Lock",__name:"lock",setup(a){return(t,s)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M224 448a32 32 0 0 0-32 32v384a32 32 0 0 0 32 32h576a32 32 0 0 0 32-32V480a32 32 0 0 0-32-32zm0-64h576a96 96 0 0 1 96 96v384a96 96 0 0 1-96 96H224a96 96 0 0 1-96-96V480a96 96 0 0 1 96-96"}),e.createElementVNode("path",{fill:"currentColor",d:"M512 544a32 32 0 0 1 32 32v192a32 32 0 1 1-64 0V576a32 32 0 0 1 32-32m192-160v-64a192 192 0 1 0-384 0v64zM512 64a256 256 0 0 1 256 256v128H256V320A256 256 0 0 1 512 64"})]))}}),ke=eo,oo=e.defineComponent({name:"Message",__name:"message",setup(a){return(t,s)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M128 224v512a64 64 0 0 0 64 64h640a64 64 0 0 0 64-64V224zm0-64h768a64 64 0 0 1 64 64v512a128 128 0 0 1-128 128H192A128 128 0 0 1 64 736V224a64 64 0 0 1 64-64"}),e.createElementVNode("path",{fill:"currentColor",d:"M904 224 656.512 506.88a192 192 0 0 1-289.024 0L120 224zm-698.944 0 210.56 240.704a128 128 0 0 0 192.704 0L818.944 224z"})]))}}),so=oo,to=e.defineComponent({name:"Refresh",__name:"refresh",setup(a){return(t,s)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M771.776 794.88A384 384 0 0 1 128 512h64a320 320 0 0 0 555.712 216.448H654.72a32 32 0 1 1 0-64h149.056a32 32 0 0 1 32 32v148.928a32 32 0 1 1-64 0v-50.56zM276.288 295.616h92.992a32 32 0 0 1 0 64H220.16a32 32 0 0 1-32-32V178.56a32 32 0 0 1 64 0v50.56A384 384 0 0 1 896.128 512h-64a320 320 0 0 0-555.776-216.384z"})]))}}),_e=to,ao=e.defineComponent({name:"User",__name:"user",setup(a){return(t,s)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M512 512a192 192 0 1 0 0-384 192 192 0 0 0 0 384m0 64a256 256 0 1 1 0-512 256 256 0 0 1 0 512m320 320v-96a96 96 0 0 0-96-96H288a96 96 0 0 0-96 96v96a32 32 0 1 1-64 0v-96a160 160 0 0 1 160-160h448a160 160 0 0 1 160 160v96a32 32 0 1 1-64 0"})]))}}),pe=ao,ro=e.defineComponent({name:"Warning",__name:"warning",setup(a){return(t,s)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M512 64a448 448 0 1 1 0 896 448 448 0 0 1 0-896m0 832a384 384 0 0 0 0-768 384 384 0 0 0 0 768m48-176a48 48 0 1 1-96 0 48 48 0 0 1 96 0m-48-464a32 32 0 0 1 32 32v288a32 32 0 0 1-64 0V288a32 32 0 0 1 32-32"})]))}}),Se=ro;class re extends Error{constructor(s,r={},d){super(s);se(this,"context");se(this,"originalError");this.name="PackageError",this.context=r,this.originalError=d}}function no(a,t={},s){try{const r=a();return r instanceof Promise?r.catch(d=>{if(console.warn("[ErrorHandler] Async operation failed:",{context:t,error:d.message,stack:d.stack}),s!==void 0)return s;throw new re(`Async operation failed: ${d.message}`,t,d)}):r}catch(r){if(console.warn("[ErrorHandler] Operation failed:",{context:t,error:r instanceof Error?r.message:String(r),stack:r instanceof Error?r.stack:void 0}),s!==void 0)return s;throw new re(`Operation failed: ${r instanceof Error?r.message:String(r)}`,t,r instanceof Error?r:void 0)}}async function io(a,t={},s){try{return await a()}catch(r){if(console.warn("[ErrorHandler] Async operation failed:",{context:t,error:r instanceof Error?r.message:String(r),stack:r instanceof Error?r.stack:void 0}),s!==void 0)return s;throw new re(`Async operation failed: ${r instanceof Error?r.message:String(r)}`,t,r instanceof Error?r:void 0)}}function ye(a,t={}){const s=a.message.toLowerCase();if(s.includes("is not a function")||s.includes("cannot read property")||s.includes("undefined is not a function")){console.warn("[ErrorHandler] Bundling error detected:",{context:t,error:a.message,suggestion:"This may be due to minification or import issues. The package will continue with fallback behavior."});return}throw new re(`Unexpected error: ${a.message}`,t,a)}async function lo(a,t={},s){try{return await a()}catch(r){return console.warn("[ErrorHandler] Import failed:",{context:t,error:r instanceof Error?r.message:String(r)}),s!==void 0?s:void 0}}function co(a){var t;try{if(typeof document>"u")return null;const r=`; ${document.cookie}`.split(`; ${a}=`);return r.length===2&&((t=r.pop())==null?void 0:t.split(";").shift())||null}catch(s){return console.warn("[ErrorHandler] Cookie access failed:",{cookieName:a,error:s instanceof Error?s.message:String(s)}),null}}function uo(a,t,s={}){try{if(typeof document>"u")return!1;let r=`${a}=${t}`;return s.domain&&(r+=`; domain=${s.domain}`),s.path&&(r+=`; path=${s.path}`),s.secure&&(r+="; secure"),s.sameSite&&(r+=`; samesite=${s.sameSite}`),s.maxAge&&(r+=`; max-age=${s.maxAge}`),document.cookie=r,!0}catch(r){return console.warn("[ErrorHandler] Cookie setting failed:",{cookieName:a,error:r instanceof Error?r.message:String(r)}),!1}}function po(a){try{return typeof localStorage>"u"?null:localStorage.getItem(a)}catch(t){return console.warn("[ErrorHandler] localStorage get failed:",{key:a,error:t instanceof Error?t.message:String(t)}),null}}function fo(a,t){try{return typeof localStorage>"u"?!1:(localStorage.setItem(a,t),!0)}catch(s){return console.warn("[ErrorHandler] localStorage set failed:",{key:a,error:s instanceof Error?s.message:String(s)}),!1}}function go(a,t){try{return typeof window>"u"?t:a(window)}catch(s){return console.warn("[ErrorHandler] Window operation failed:",{error:s instanceof Error?s.message:String(s)}),t}}function Ee(){typeof window>"u"||(window.addEventListener("unhandledrejection",a=>{const t=a.reason;if(t instanceof Error){const s=t.message.toLowerCase();if(s.includes("is not a function")||s.includes("cannot read property")||s.includes("undefined is not a function")){console.warn("[ErrorHandler] Unhandled promise rejection (bundling error):",{error:t.message,stack:t.stack}),a.preventDefault();return}}console.error("[ErrorHandler] Unhandled promise rejection:",a.reason)}),window.addEventListener("error",a=>{const t=a.error;if(t instanceof Error){const s=t.message.toLowerCase();if(s.includes("is not a function")||s.includes("cannot read property")||s.includes("undefined is not a function")){console.warn("[ErrorHandler] Uncaught error (bundling error):",{error:t.message,stack:t.stack}),a.preventDefault();return}}console.error("[ErrorHandler] Uncaught error:",a.error)}))}typeof window<"u"&&Ee();function Ce(){const a=e.ref({user:null,isAuthenticated:!1,isLoading:!0,error:null}),t=e.ref(null),s=e.computed(()=>a.value.isAuthenticated),r=e.computed(()=>a.value.user),d=e.computed(()=>a.value.isLoading),S=async()=>{var m,i,c,x,k,p,N,b,v,u,C,f,w,K,T,q,U,F,H,y,O;try{console.log("[auth][enhanced] Starting loadUserInfo..."),console.log("[auth][enhanced] Ensuring cross-subdomain cookie synchronization...");const D="sb-access-token",A="sb-refresh-token",$=L=>{try{const B=location.hostname;if(B==="localhost"||/^\d+\.\d+\.\d+\.\d+$/.test(B)){console.log("[auth][enhanced] Skipping cookie sync for localhost");return}const j="aiworkspace.pro";if(!B.endsWith(`.${j}`)&&B!==j){console.log("[auth][enhanced] Skipping cookie sync - not under apex domain");return}console.log("[auth][enhanced] Performing cookie synchronization"),L.forEach(Z=>{const te=document.cookie.split(";").find(ee=>ee.trim().startsWith(Z+"="));if(te){console.log(`[auth][enhanced] Found cookie: ${Z}`);const ee=te.split("=")[1];ee&&(document.cookie=`${Z}=${ee}; domain=.${j}; path=/; secure; samesite=lax`)}})}catch(B){console.warn("[auth][enhanced] Error in cookie sync:",B)}};$([D,A]),await new Promise(L=>setTimeout(L,100));let G=null;try{const B=await(await R.getSupabase()).auth.getSession();G=(m=B==null?void 0:B.data)==null?void 0:m.session}catch(L){console.warn("[auth][enhanced] Error getting Supabase session:",L)}if(G&&G.user){console.log("[auth][enhanced] Active Supabase session found");const L=G.user,B={id:L.id,name:((i=L.user_metadata)==null?void 0:i.name)||((c=L.user_metadata)==null?void 0:c.user_name)||((x=L.user_metadata)==null?void 0:x.full_name)||((k=L.email)==null?void 0:k.split("@")[0])||"User",email:L.email,avatar_url:((p=L.user_metadata)==null?void 0:p.avatar_url)||null,user_metadata:L.user_metadata};return a.value={user:B,isAuthenticated:!0,isLoading:!1,error:null},t.value={user:B,access_token:G.access_token,refresh_token:G.refresh_token},{user:B,session:t.value,error:null}}console.log("[auth][enhanced] No active session, attempting to restore from cookies...");const Y=await R.restoreSessionWithRetry();if(Y.success&&Y.session){console.log("[auth][enhanced] Session restored successfully from cookies");const L=Y.session.user,B={id:L.id,name:((N=L.user_metadata)==null?void 0:N.name)||((b=L.user_metadata)==null?void 0:b.user_name)||((v=L.user_metadata)==null?void 0:v.full_name)||((u=L.email)==null?void 0:u.split("@")[0])||"User",email:L.email,avatar_url:((C=L.user_metadata)==null?void 0:C.avatar_url)||null,user_metadata:L.user_metadata};return a.value={user:B,isAuthenticated:!0,isLoading:!1,error:null},t.value=Y.session,{user:B,session:t.value,error:null}}else{console.log("[auth][enhanced] Failed to restore session:",Y.error),console.log("[auth][enhanced] Retrying session restoration with extended delay..."),await new Promise(B=>setTimeout(B,500)),$([D,A]);const L=await R.restoreSessionWithRetry();if(L.success&&L.session){console.log("[auth][enhanced] Session restored on retry");const B=L.session.user,j={id:B.id,name:((f=B.user_metadata)==null?void 0:f.name)||((w=B.user_metadata)==null?void 0:w.user_name)||((K=B.user_metadata)==null?void 0:K.full_name)||((T=B.email)==null?void 0:T.split("@")[0])||"User",email:B.email,avatar_url:((q=B.user_metadata)==null?void 0:q.avatar_url)||null,user_metadata:B.user_metadata};return a.value={user:j,isAuthenticated:!0,isLoading:!1,error:null},t.value=L.session,{user:j,session:t.value,error:null}}}}catch(D){console.error("Error getting Supabase session:",D),D instanceof Error&&ye(D,{component:"useEnhancedAuth",function:"loadUserInfo",operation:"session_validation"});try{const A=await R.restoreSessionWithRetry();if(A.success&&A.session){console.log("[auth][enhanced] Session restored after error");const $=A.session.user,G={id:$.id,name:((U=$.user_metadata)==null?void 0:U.name)||((F=$.user_metadata)==null?void 0:F.user_name)||((H=$.user_metadata)==null?void 0:H.full_name)||((y=$.email)==null?void 0:y.split("@")[0])||"User",email:$.email,avatar_url:((O=$.user_metadata)==null?void 0:O.avatar_url)||null,user_metadata:$.user_metadata};return a.value={user:G,isAuthenticated:!0,isLoading:!1,error:null},t.value=A.session,{user:G,session:t.value,error:null}}}catch(A){console.error("Error restoring session:",A)}}return console.log("[auth][enhanced] No valid authentication found"),a.value={user:null,isAuthenticated:!1,isLoading:!1,error:"No valid session found"},t.value=null,{user:null,session:null,error:"No valid session found"}},I=async()=>{try{await(await R.getSupabase()).auth.signOut(),_.clearSessionCookie(_.ACCESS_COOKIE),_.clearSessionCookie(_.REFRESH_COOKIE),_.clearLocalStorageTokens(),a.value={user:null,isAuthenticated:!1,isLoading:!1,error:null},t.value=null,console.log("[auth][enhanced] User logged out successfully")}catch(m){console.error("Error during logout:",m),a.value={user:null,isAuthenticated:!1,isLoading:!1,error:null},t.value=null}},V=async(m,i)=>{var c,x,k,p,N;try{a.value.isLoading=!0;const b=await R.getSupabase(),{data:v,error:u}=await b.auth.signInWithPassword({email:m,password:i});if(u)throw u;if(v.session){const C=v.session.user,f={id:C.id,name:((c=C.user_metadata)==null?void 0:c.name)||((x=C.user_metadata)==null?void 0:x.user_name)||((k=C.user_metadata)==null?void 0:k.full_name)||((p=C.email)==null?void 0:p.split("@")[0])||"User",email:C.email,avatar_url:((N=C.user_metadata)==null?void 0:N.avatar_url)||null,user_metadata:C.user_metadata};return a.value={user:f,isAuthenticated:!0,isLoading:!1,error:null},t.value={user:f,access_token:v.session.access_token,refresh_token:v.session.refresh_token},{user:f,session:t.value,error:null}}return{user:null,session:null,error:"No session returned"}}catch(b){return console.error("Sign in error:",b),a.value.isLoading=!1,{user:null,session:null,error:String(b)}}},W=async(m,i,c)=>{var x,k,p,N,b;try{a.value.isLoading=!0;const v=await R.getSupabase(),{data:u,error:C}=await v.auth.signUp({email:m,password:i,options:{data:c}});if(C)throw C;if(u.session){const f=u.session.user,w={id:f.id,name:((x=f.user_metadata)==null?void 0:x.name)||((k=f.user_metadata)==null?void 0:k.user_name)||((p=f.user_metadata)==null?void 0:p.full_name)||((N=f.email)==null?void 0:N.split("@")[0])||"User",email:f.email,avatar_url:((b=f.user_metadata)==null?void 0:b.avatar_url)||null,user_metadata:f.user_metadata};return a.value={user:w,isAuthenticated:!0,isLoading:!1,error:null},t.value={user:w,access_token:u.session.access_token,refresh_token:u.session.refresh_token},{user:w,session:t.value,error:null}}return{user:null,session:null,error:"No session returned"}}catch(v){return console.error("Sign up error:",v),a.value.isLoading=!1,{user:null,session:null,error:String(v)}}},h=async()=>{await S()};return e.onMounted(async()=>{await R.initializeCrossSubdomainAuth(),await h()}),{authState:a,currentSession:t,isAuthenticated:s,currentUser:r,isLoading:d,loadUserInfo:S,logout:I,signIn:V,signUp:W,checkAuth:h}}const X={normalCheckInterval:3e4,fastCheckInterval:5e3,fastMonitoringDuration:12e4,maxRetryAttempts:3,retryDelay:2e3,validationCacheDuration:5e3,enableImmediateDetection:!0,enableFastMonitoring:!0,enableNetworkAwareness:!0},Ve={...X,normalCheckInterval:1e4,fastCheckInterval:2e3,fastMonitoringDuration:6e4,maxRetryAttempts:2,retryDelay:1e3},Ne={...X,normalCheckInterval:6e4,fastCheckInterval:1e4,fastMonitoringDuration:3e5,maxRetryAttempts:5,retryDelay:3e3,enableFastMonitoring:!1},fe={...X,normalCheckInterval:1e4,fastCheckInterval:2e3,fastMonitoringDuration:3e4,validationCacheDuration:1e3},ge={...X,normalCheckInterval:45e3,fastCheckInterval:3e3,fastMonitoringDuration:9e4,validationCacheDuration:1e4};function me(){switch("production"){case"production":return ge;case"development":return fe;default:return X}}function mo(a){return{...X,...a}}const be={default:X,fast:Ve,conservative:Ne,development:fe,production:ge};function ho(a){return be[a]}const wo={immediate:"Immediate (0-2 seconds) - When logout is detected via auth events",fast:"Fast (2-5 seconds) - When fast monitoring is active",normal:"Normal (up to 30 seconds) - Regular monitoring interval",conservative:"Conservative (up to 60 seconds) - Less frequent monitoring"},vo={manualLogout:{timing:"Immediate (0-2 seconds)",description:"User clicks logout button",method:"Auth state change event + fast monitoring"},sessionExpiry:{timing:"Fast (2-5 seconds)",description:"Session token expires naturally",method:"Fast monitoring detects invalid session"},tokenInvalidation:{timing:"Normal (up to 30 seconds)",description:"Token is invalidated server-side",method:"Regular monitoring detects validation failure"},networkIssues:{timing:"Immediate (0-1 second)",description:"Network connection lost",method:"Network event listener"},crossTabLogout:{timing:"Fast (2-5 seconds)",description:"User logs out in another tab",method:"Storage event listener + fast monitoring"}};function Ae(a){const t=e.ref(!0),s=e.ref(null),r=e.ref(!1),d=e.ref(!1),S=e.ref(null),I=e.ref(null),V=e.ref(null),W={...me(),...a},h=W.normalCheckInterval,m=W.fastCheckInterval,i=W.fastMonitoringDuration,c=W.maxRetryAttempts,x=W.retryDelay,k=e.computed(()=>!t.value&&s.value!==null),p=e.computed(()=>{var y,O;return((y=s.value)==null?void 0:y.canRetry)&&((O=s.value)==null?void 0:O.type)!=="manual_check_failed"}),N=y=>{var A;if(typeof document>"u")return null;const D=`; ${document.cookie}`.split(`; ${y}=`);return D.length===2&&((A=D.pop())==null?void 0:A.split(";").shift())||null},b=async()=>{try{console.log("[SessionMonitor] Validating session...");const y=N("sb-access-token"),O=N("sb-refresh-token");if(!y||!O)return console.log("[SessionMonitor] No tokens found in cookies"),!1;const D=await R.getSupabase(),{data:{session:A},error:$}=await D.auth.getSession();if($)return console.warn("[SessionMonitor] Error getting session:",$),!1;if(!A||!A.user)return console.log("[SessionMonitor] No valid session found"),!1;const G=new Date,Y=new Date(A.expires_at*1e3);return G>=Y?(console.log("[SessionMonitor] Session has expired"),!1):(console.log("[SessionMonitor] Session is valid"),S.value=new Date,!0)}catch(y){return console.error("[SessionMonitor] Error validating session:",y),!1}},v=async()=>{try{console.log("[SessionMonitor] Attempting to restore session...");const y=N("sb-access-token"),O=N("sb-refresh-token");if(!y||!O)return console.log("[SessionMonitor] No tokens available for restoration"),!1;const D=await R.getSupabase(),{data:A,error:$}=await D.auth.setSession({access_token:y,refresh_token:O});return $?(console.warn("[SessionMonitor] Error restoring session:",$),!1):A.session&&A.session.user?(console.log("[SessionMonitor] Session restored successfully"),S.value=new Date,!0):!1}catch(y){return console.error("[SessionMonitor] Error restoring session:",y),!1}},u=(y,O,D=!0)=>{console.warn("[SessionMonitor] Session loss detected:",{type:y,message:O}),t.value=!1,s.value={type:y,message:O,timestamp:new Date,canRetry:D}},C=async()=>{console.log("[SessionMonitor] Retrying session validation...");for(let y=1;y<=c;y++){if(console.log(`[SessionMonitor] Retry attempt ${y}/${c}`),y>1&&await new Promise(A=>setTimeout(A,x)),await v()&&await b())return console.log("[SessionMonitor] Session restored and validated successfully"),t.value=!0,s.value=null,!0;if(await b())return console.log("[SessionMonitor] Session validated successfully on retry"),t.value=!0,s.value=null,!0}return console.log("[SessionMonitor] All retry attempts failed"),!1},f=()=>{console.log("[SessionMonitor] Clearing session loss state"),t.value=!0,s.value=null},w=()=>{if(r.value){console.log("[SessionMonitor] Already monitoring, skipping start");return}console.log("[SessionMonitor] Starting session monitoring..."),r.value=!0,b().then(y=>{y||u("session_expired","Your session has expired. Please log in again.",!0)}),I.value=setInterval(async()=>{console.log("[SessionMonitor] Periodic session check...");const y=await b();!y&&t.value?u("session_expired","Your session has expired. Please log in again.",!0):y&&!t.value&&(console.log("[SessionMonitor] Session recovered"),f())},h)},K=()=>{if(d.value){console.log("[SessionMonitor] Fast monitoring already active");return}console.log("[SessionMonitor] Starting fast monitoring (5s intervals)..."),d.value=!0,V.value&&clearInterval(V.value),V.value=setInterval(async()=>{console.log("[SessionMonitor] Fast session check...");const y=await b();!y&&t.value?(u("session_expired","Your session has expired. Please log in again.",!0),T()):y&&!t.value&&(console.log("[SessionMonitor] Session recovered"),f(),T())},m),setTimeout(()=>{d.value&&(console.log(`[SessionMonitor] Auto-stopping fast monitoring after ${i/1e3} seconds`),T())},i)},T=()=>{d.value&&(console.log("[SessionMonitor] Stopping fast monitoring..."),d.value=!1,V.value&&(clearInterval(V.value),V.value=null))},q=()=>{r.value&&(console.log("[SessionMonitor] Stopping session monitoring..."),r.value=!1,I.value&&(clearInterval(I.value),I.value=null),T())},U=async()=>{console.log("[SessionMonitor] Manual session check requested");const y=await b();return!y&&!await v()?(u("manual_check_failed","Session validation failed. Please log in again.",!1),!1):y},F=()=>{u("network_error","Network connection lost. Please check your internet connection and try again.",!0)},H=()=>{if(typeof window>"u")return;const y=()=>{var A;console.log("[SessionMonitor] Network connection restored"),k.value&&((A=s.value)==null?void 0:A.type)==="network_error"&&setTimeout(()=>C(),1e3)},O=()=>{console.log("[SessionMonitor] Network connection lost"),F()},D=A=>{console.log("[SessionMonitor] Logout detected, starting fast monitoring for immediate detection"),K()};return window.addEventListener("online",y),window.addEventListener("offline",O),window.addEventListener("session-logout-detected",D),()=>{window.removeEventListener("online",y),window.removeEventListener("offline",O),window.removeEventListener("session-logout-detected",D)}};return e.onMounted(()=>{console.log("[SessionMonitor] Mounted, setting up monitoring"),w(),H()}),e.onUnmounted(()=>{console.log("[SessionMonitor] Unmounted, cleaning up"),q()}),{isSessionValid:t,sessionLossEvent:s,isMonitoring:r,isFastMonitoring:d,lastValidSession:S,hasSessionLoss:k,canRetrySession:p,validateSession:b,restoreSession:v,retrySession:C,clearSessionLoss:f,startMonitoring:w,stopMonitoring:q,startFastMonitoring:K,stopFastMonitoring:T,checkSession:U,handleNetworkError:F}}const Ie=je.defineStore("workspace",()=>{const a=e.ref(null),t=e.ref([]),s=e.ref(null),r=h=>{a.value=h,localStorage.setItem("current_workspace",JSON.stringify(h))},d=h=>{t.value=h,localStorage.setItem("available_workspaces",JSON.stringify(h))};return{currentWorkspace:a,workspaces:t,user:s,setCurrentWorkspace:r,setWorkspaces:d,setUser:h=>{s.value=h,localStorage.setItem("user_info",JSON.stringify(h))},loadPersistedData:()=>{const h=localStorage.getItem("current_workspace");if(h)try{a.value=JSON.parse(h)}catch(c){console.error("Error loading persisted workspace:",c)}const m=localStorage.getItem("available_workspaces");if(m)try{t.value=JSON.parse(m)}catch(c){console.error("Error loading persisted workspaces:",c)}const i=localStorage.getItem("user_info");if(i)try{s.value=JSON.parse(i)}catch(c){console.error("Error loading persisted user:",c)}},clearData:()=>{a.value=null,t.value=[],s.value=null,localStorage.removeItem("current_workspace"),localStorage.removeItem("available_workspaces"),localStorage.removeItem("user_info")},loadWorkspaces:async(h=!1)=>{try{const{data:{user:m}}=await R.supabase.auth.getUser();if(!m)return[];let i=R.supabase.from("workspaces").select(`
          id, title, description, parent_workspace_id, created_by, archived, created_at, git_repo, 
          workspace_access!inner ( access_type, shared_with_user_id ),
          workspace_activities!left ( updated_at )
        `).eq("workspace_access.shared_with_user_id",m.id);h||(i=i.eq("archived",!1));const{data:c,error:x}=await i;if(x)throw x;const k=new Map;(c||[]).forEach(u=>{(u.workspace_access||[]).forEach(C=>{C.shared_with_user_id===m.id&&k.set(u.id,C)})});const p=[...new Set((c||[]).filter(u=>u.parent_workspace_id).map(u=>u.parent_workspace_id).filter(u=>!k.has(u)))];let N=[];if(p.length){let u=R.supabase.from("workspaces").select("id, title, description, parent_workspace_id, created_by, archived, created_at").in("id",p);h||(u=u.eq("archived",!1));const{data:C,error:f}=await u;if(f)throw f;N=C||[]}const v=[...c||[],...N].map(u=>{var C,f,w;return{id:u.id,title:u.title,description:u.description||"No description",parent_workspace_id:u.parent_workspace_id,created_by:u.created_by,archived:u.archived,created_at:u.created_at,latest_activity:((f=(C=u.workspace_activities)==null?void 0:C[0])==null?void 0:f.updated_at)||u.created_at,hasAccess:k.has(u.id),accessType:((w=k.get(u.id))==null?void 0:w.access_type)||null}});return v.sort((u,C)=>new Date(C.latest_activity)-new Date(u.latest_activity)),d(v),v}catch(m){return console.error("loadWorkspaces error",m),[]}}}});function Le(){const a=e.ref({user:null,isAuthenticated:!1,isLoading:!0,error:null}),t=e.ref(window.location.href),s=async()=>{var h,m,i,c,x,k,p,N;try{a.value.isLoading=!0;const b=await R.getSupabase(),{data:{session:v},error:u}=await b.auth.getSession();if(u){console.error("Error checking auth status:",u),a.value={user:null,isAuthenticated:!1,isLoading:!1,error:u.message};return}v!=null&&v.user?(a.value={user:{id:v.user.id,email:v.user.email||"",name:((h=v.user.user_metadata)==null?void 0:h.full_name)||((m=v.user.user_metadata)==null?void 0:m.name)||((i=v.user.email)==null?void 0:i.split("@")[0])||"User",avatar_url:((c=v.user.user_metadata)==null?void 0:c.avatar_url)||((x=v.user.user_metadata)==null?void 0:x.picture)||null,initials:(((k=v.user.user_metadata)==null?void 0:k.full_name)||((p=v.user.user_metadata)==null?void 0:p.name)||((N=v.user.email)==null?void 0:N.split("@")[0])||"U").split(" ").map(C=>C[0]).join("").toUpperCase().substring(0,2)},isAuthenticated:!0,isLoading:!1,error:null},v.access_token&&_.setSessionCookie(_.ACCESS_COOKIE,v.access_token),v.refresh_token&&_.setSessionCookie(_.REFRESH_COOKIE,v.refresh_token),_.syncCookiesToLocalStorage()):a.value={user:null,isAuthenticated:!1,isLoading:!1,error:null}}catch(b){console.error("Auth check failed:",b),a.value={user:null,isAuthenticated:!1,isLoading:!1,error:b.message||"Authentication check failed"}}},r=async(h,m)=>{try{const i=await R.getSupabase(),{error:c}=await i.auth.signInWithPassword({email:h,password:m});return c?{success:!1,error:c.message}:(await s(),sessionStorage.setItem("post-login-redirect",t.value),{success:!0})}catch(i){return console.error("Login error:",i),{success:!1,error:i.message||"Login failed"}}},d=async(h,m)=>{var i;try{const c=await R.getSupabase(),{data:x,error:k}=await c.auth.signUp({email:h,password:m});return k?{success:!1,error:k.message}:x.user&&!x.user.email_confirmed_at?{success:!0,needsConfirmation:!0}:(i=x.session)!=null&&i.user?(await s(),sessionStorage.setItem("post-login-redirect",t.value),{success:!0}):{success:!1,error:"No session created"}}catch(c){return console.error("Signup error:",c),{success:!1,error:c.message||"Signup failed"}}},S=async h=>{try{const m=`${window.location.origin}/auth/callback`;console.log("[OAuth] Starting login with provider:",h),console.log("[OAuth] Redirect URL:",m),console.log("[OAuth] Current URL:",t.value),console.log("[OAuth] Current origin:",window.location.origin);const i=await R.getSupabase(),{error:c}=await i.auth.signInWithOAuth({provider:h,options:{redirectTo:m,queryParams:{redirect_origin:t.value}}});if(c)return console.error("[OAuth] Error:",c),{success:!1,error:c.message};const x=t.value||window.location.href;return sessionStorage.setItem("post-login-redirect",x),localStorage.setItem("post-login-redirect",x),console.log("[OAuth] Stored redirect URL:",x),console.log("[OAuth] Current URL value:",t.value),console.log("[OAuth] Window location href:",window.location.href),{success:!0}}catch(m){return console.error("OAuth login error:",m),{success:!1,error:m.message||"OAuth login failed"}}},I=async()=>{try{const h=await R.getSupabase(),{error:m}=await h.auth.signOut();m&&console.error("Logout error:",m),a.value={user:null,isAuthenticated:!1,isLoading:!1,error:null},_.clearSessionCookie(_.ACCESS_COOKIE),_.clearSessionCookie(_.REFRESH_COOKIE),_.clearLocalStorageTokens()}catch(h){console.error("Logout error:",h)}},V=async h=>{try{const m=await R.getSupabase(),{error:i}=await m.auth.resetPasswordForEmail(h,{redirectTo:`${window.location.origin}/auth/reset-password`});return i?{success:!1,error:i.message}:{success:!0}}catch(m){return console.error("Password reset error:",m),{success:!1,error:m.message||"Password reset failed"}}},W=async()=>{try{(await R.getSupabase()).auth.onAuthStateChange((m,i)=>{var c;switch(console.log("Auth state changed:",m,(c=i==null?void 0:i.user)==null?void 0:c.email),m){case"SIGNED_IN":i!=null&&i.user&&s();break;case"SIGNED_OUT":a.value={user:null,isAuthenticated:!1,isLoading:!1,error:null},_.clearSessionCookie(_.ACCESS_COOKIE),_.clearSessionCookie(_.REFRESH_COOKIE),_.clearLocalStorageTokens();break;case"TOKEN_REFRESHED":i!=null&&i.access_token&&_.setSessionCookie(_.ACCESS_COOKIE,i.access_token),i!=null&&i.refresh_token&&_.setSessionCookie(_.REFRESH_COOKIE,i.refresh_token),_.syncCookiesToLocalStorage();break;case"USER_UPDATED":i!=null&&i.user&&s();break}})}catch(h){console.warn("Failed to setup auth listener:",h)}};return e.onMounted(async()=>{W(),await s()}),e.watch(()=>window.location.href,h=>{t.value=h}),{authState:e.computed(()=>a.value),isAuthenticated:e.computed(()=>a.value.isAuthenticated),user:e.computed(()=>a.value.user),isLoading:e.computed(()=>a.value.isLoading),checkAuthStatus:s,loginWithEmail:r,signupWithEmail:d,loginWithProvider:S,logout:I,resetPassword:V,currentUrl:e.computed(()=>t.value)}}const ko={class:"login-container"},_o={class:"logo-section"},So={class:"login-buttons"},yo={key:0,class:"forgot-password"},Eo={class:"signup-link"},Co=e.defineComponent({__name:"LoginModal",props:{modelValue:{type:Boolean}},emits:["update:modelValue","login-success"],setup(a,{emit:t}){const s=a,r=t,d=e.computed({get:()=>s.modelValue,set:f=>r("update:modelValue",f)}),S=e.ref(!1),I=e.ref(!1),V=e.ref(),{loginWithEmail:W,signupWithEmail:h,loginWithProvider:m,resetPassword:i}=Le(),c=e.reactive({email:"",password:"",confirmPassword:""}),x=e.computed(()=>({email:[{required:!0,message:"Please enter your email",trigger:"blur"},{type:"email",message:"Please enter a valid email",trigger:"blur"}],password:[{required:!0,message:"Please enter your password",trigger:"blur"},{min:6,message:"Password must be at least 6 characters",trigger:"blur"}],...S.value?{confirmPassword:[{required:!0,message:"Please confirm your password",trigger:"blur"},{validator:(f,w,K)=>{w!==c.password?K(new Error("Passwords do not match")):K()},trigger:"blur"}]}:{}})),k=()=>{var f;S.value=!S.value,c.email="",c.password="",c.confirmPassword="",(f=V.value)==null||f.clearValidate()},p=()=>{var f;d.value=!1,c.email="",c.password="",c.confirmPassword="",S.value=!1,(f=V.value)==null||f.clearValidate()},N=async()=>{if(V.value)try{await V.value.validate(),I.value=!0,S.value?await v():await b()}catch(f){console.error("Form validation failed:",f)}finally{I.value=!1}},b=async()=>{const f=await W(c.email,c.password);f.success?(M.ElMessage.success("Login successful"),r("login-success",{email:c.email}),p()):M.ElMessage.error("Login failed: "+f.error)},v=async()=>{const f=await h(c.email,c.password);f.success?f.needsConfirmation?M.ElMessage.success("Please check your email to confirm your account"):(M.ElMessage.success("Account created successfully"),r("login-success",{email:c.email}),p()):M.ElMessage.error("Signup failed: "+f.error)},u=async f=>{const w=await m(f);w.success?M.ElMessage.success("Redirecting to login provider..."):M.ElMessage.error("Login failed: "+w.error)},C=async()=>{if(!c.email){M.ElMessage.warning("Please enter your email address first");return}const f=await i(c.email);f.success?M.ElMessage.success("Password reset email sent! Please check your inbox."):M.ElMessage.error("Failed to send reset email: "+f.error)};return(f,w)=>{const K=e.resolveComponent("el-icon"),T=e.resolveComponent("el-input"),q=e.resolveComponent("el-form-item"),U=e.resolveComponent("el-button"),F=e.resolveComponent("el-dialog");return e.openBlock(),e.createBlock(F,{modelValue:d.value,"onUpdate:modelValue":w[6]||(w[6]=H=>d.value=H),title:"",width:"500px","close-on-click-modal":!1,"close-on-press-escape":!0,"show-close":!0,class:"login-modal",onClose:p},{default:e.withCtx(()=>[e.createElementVNode("div",ko,[e.createElementVNode("div",_o,[e.createElementVNode("h2",null,e.toDisplayString(S.value?"Create Account":"Welcome Back"),1),e.createElementVNode("p",null,e.toDisplayString(S.value?"Sign up to get started with your account":"Sign in to continue to your account"),1)]),e.createVNode(e.unref(M.ElForm),{model:c,rules:x.value,ref_key:"formRef",ref:V,class:"login-form",onSubmit:e.withModifiers(N,["prevent"])},{default:e.withCtx(()=>[e.createVNode(q,{prop:"email"},{default:e.withCtx(()=>[e.createVNode(T,{modelValue:c.email,"onUpdate:modelValue":w[0]||(w[0]=H=>c.email=H),placeholder:"Email",type:"email",size:"large",class:"form-input"},{prefix:e.withCtx(()=>[e.createVNode(K,null,{default:e.withCtx(()=>[e.createVNode(e.unref(so))]),_:1})]),_:1},8,["modelValue"])]),_:1}),e.createVNode(q,{prop:"password"},{default:e.withCtx(()=>[e.createVNode(T,{modelValue:c.password,"onUpdate:modelValue":w[1]||(w[1]=H=>c.password=H),placeholder:"Password",type:"password",size:"large","show-password":"",class:"form-input"},{prefix:e.withCtx(()=>[e.createVNode(K,null,{default:e.withCtx(()=>[e.createVNode(e.unref(ke))]),_:1})]),_:1},8,["modelValue"])]),_:1}),S.value?(e.openBlock(),e.createBlock(q,{key:0,prop:"confirmPassword"},{default:e.withCtx(()=>[e.createVNode(T,{modelValue:c.confirmPassword,"onUpdate:modelValue":w[2]||(w[2]=H=>c.confirmPassword=H),placeholder:"Confirm Password",type:"password",size:"large","show-password":"",class:"form-input"},{prefix:e.withCtx(()=>[e.createVNode(K,null,{default:e.withCtx(()=>[e.createVNode(e.unref(ke))]),_:1})]),_:1},8,["modelValue"])]),_:1})):e.createCommentVNode("",!0),e.createVNode(q,null,{default:e.withCtx(()=>[e.createVNode(U,{type:"primary",class:"submit-button",loading:I.value,onClick:N,size:"large"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(S.value?"Sign Up":"Sign In"),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model","rules"]),w[10]||(w[10]=e.createElementVNode("div",{class:"divider"},[e.createElementVNode("span",null,"Or continue with")],-1)),e.createElementVNode("div",So,[e.createVNode(U,{class:"login-button google",onClick:w[3]||(w[3]=H=>u("google")),size:"large"},{default:e.withCtx(()=>[...w[7]||(w[7]=[e.createElementVNode("span",{class:"social-icon"},"G",-1),e.createTextVNode(" Google ",-1)])]),_:1}),e.createVNode(U,{class:"login-button github",onClick:w[4]||(w[4]=H=>u("github")),size:"large"},{default:e.withCtx(()=>[...w[8]||(w[8]=[e.createElementVNode("span",{class:"social-icon"},"âš¡",-1),e.createTextVNode(" GitHub ",-1)])]),_:1}),e.createVNode(U,{class:"login-button twitter",onClick:w[5]||(w[5]=H=>u("twitter")),size:"large"},{default:e.withCtx(()=>[...w[9]||(w[9]=[e.createElementVNode("span",{class:"social-icon"},"X",-1),e.createTextVNode(" X (Twitter) ",-1)])]),_:1})]),w[11]||(w[11]=e.createElementVNode("div",{class:"terms"}," By continuing, you agree to AI Workspace's Terms of Service and Privacy Policy ",-1)),S.value?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("div",yo,[e.createElementVNode("a",{href:"#",onClick:e.withModifiers(C,["prevent"])},"Forgot Password?")])),e.createElementVNode("div",Eo,[e.createTextVNode(e.toDisplayString(S.value?"Already have an account?":"Don't have an account?")+" ",1),e.createElementVNode("a",{href:"#",onClick:e.withModifiers(k,["prevent"])},e.toDisplayString(S.value?"Sign in":"Sign up"),1)])])]),_:1},8,["modelValue"])}}});const le=(a,t)=>{const s=a.__vccOpts||a;for(const[r,d]of t)s[r]=d;return s},xe=le(Co,[["__scopeId","data-v-684a3f28"]]),Vo={class:"session-loss-content"},No={class:"session-loss-icon"},bo={class:"session-loss-message"},Ao={key:0,class:"session-loss-details"},Io={class:"detail-item"},Lo={class:"detail-value"},xo={class:"detail-item"},Mo={class:"detail-value"},Bo={class:"session-loss-actions"},Ro={key:0,class:"retry-status"},$o={class:"retry-message"},Wo=e.defineComponent({__name:"SessionLossModal",props:{modelValue:{type:Boolean},sessionLossEvent:{},canRetrySession:{type:Boolean}},emits:["update:modelValue","retry","login","refresh"],setup(a,{emit:t}){const s=a,r=t,d=e.ref(!1),S=e.ref(0),I=e.ref(void 0),V=e.ref(""),W=e.computed({get:()=>s.modelValue,set:k=>r("update:modelValue",k)}),h=k=>{switch(k){case"session_expired":return"Authentication session has expired";case"token_invalid":return"Authentication token is invalid or corrupted";case"network_error":return"Network connection issue detected";case"manual_check_failed":return"Session validation failed";default:return"Unknown authentication issue"}},m=k=>k.toLocaleString(),i=async()=>{if(d.value)return;d.value=!0,S.value=0,I.value=void 0,V.value="Attempting to restore session...";const k=setInterval(()=>{S.value<90&&(S.value+=Math.random()*20)},200);try{r("retry"),await new Promise(p=>setTimeout(p,2e3)),S.value=100,I.value="success",V.value="Session restored successfully!",setTimeout(()=>{W.value=!1},1e3)}catch{S.value=100,I.value="exception",V.value="Failed to restore session. Please log in again.",M.ElMessage.error("Session restoration failed")}finally{clearInterval(k),setTimeout(()=>{d.value=!1,S.value=0,I.value=void 0,V.value=""},3e3)}},c=()=>{r("login"),W.value=!1},x=()=>{r("refresh"),window.location.reload()};return e.watch(()=>s.sessionLossEvent,k=>{k&&(d.value=!1,S.value=0,I.value=void 0,V.value="")}),(k,p)=>(e.openBlock(),e.createBlock(e.unref(M.ElDialog),{modelValue:W.value,"onUpdate:modelValue":p[0]||(p[0]=N=>W.value=N),title:"Session Expired",width:"500px","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1,class:"session-loss-modal",center:""},{default:e.withCtx(()=>{var N;return[e.createElementVNode("div",Vo,[e.createElementVNode("div",No,[e.createVNode(e.unref(M.ElIcon),{size:"48",color:"#f56c6c"},{default:e.withCtx(()=>[e.createVNode(e.unref(Se))]),_:1})]),e.createElementVNode("div",bo,[p[3]||(p[3]=e.createElementVNode("h3",null,"Your session has expired",-1)),e.createElementVNode("p",null,e.toDisplayString(((N=k.sessionLossEvent)==null?void 0:N.message)||"Please log in again to continue using the application."),1),k.sessionLossEvent?(e.openBlock(),e.createElementBlock("div",Ao,[e.createElementVNode("div",Io,[p[1]||(p[1]=e.createElementVNode("span",{class:"detail-label"},"Issue:",-1)),e.createElementVNode("span",Lo,e.toDisplayString(h(k.sessionLossEvent.type)),1)]),e.createElementVNode("div",xo,[p[2]||(p[2]=e.createElementVNode("span",{class:"detail-label"},"Time:",-1)),e.createElementVNode("span",Mo,e.toDisplayString(m(k.sessionLossEvent.timestamp)),1)])])):e.createCommentVNode("",!0)]),e.createElementVNode("div",Bo,[k.canRetrySession&&!d.value?(e.openBlock(),e.createBlock(e.unref(M.ElButton),{key:0,type:"primary",onClick:i,loading:d.value},{default:e.withCtx(()=>[e.createVNode(e.unref(M.ElIcon),null,{default:e.withCtx(()=>[e.createVNode(e.unref(_e))]),_:1}),p[4]||(p[4]=e.createTextVNode(" Try Again ",-1))]),_:1},8,["loading"])):e.createCommentVNode("",!0),e.createVNode(e.unref(M.ElButton),{type:"primary",onClick:c,disabled:d.value},{default:e.withCtx(()=>[e.createVNode(e.unref(M.ElIcon),null,{default:e.withCtx(()=>[e.createVNode(e.unref(pe))]),_:1}),p[5]||(p[5]=e.createTextVNode(" Log In ",-1))]),_:1},8,["disabled"]),k.canRetrySession?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(e.unref(M.ElButton),{key:1,type:"info",onClick:x,disabled:d.value},{default:e.withCtx(()=>[e.createVNode(e.unref(M.ElIcon),null,{default:e.withCtx(()=>[e.createVNode(e.unref(_e))]),_:1}),p[6]||(p[6]=e.createTextVNode(" Refresh Page ",-1))]),_:1},8,["disabled"]))]),d.value?(e.openBlock(),e.createElementBlock("div",Ro,[e.createVNode(e.unref(M.ElProgress),{percentage:S.value,status:I.value,"stroke-width":6},null,8,["percentage","status"]),e.createElementVNode("p",$o,e.toDisplayString(V.value),1)])):e.createCommentVNode("",!0)])]}),_:1},8,["modelValue"]))}});const Me=le(Wo,[["__scopeId","data-v-0dd27f7f"]]),Uo={class:"aiworkspace-header"},Po={key:0,class:"header-content header-loading"},Do={class:"header-center"},Oo={class:"loading-text"},To={key:0},Ho={key:1},Fo={key:1,class:"header-content header-fallback"},zo={key:2,class:"header-content header-restricted"},Ko={class:"header-center"},qo={class:"restricted-text"},Go={class:"header-right"},Yo={key:3,class:"header-content"},jo={class:"header-left"},Jo={class:"logo-section"},Xo={href:"/",class:"logo"},Qo=["src"],Zo={key:1,class:"text-logo"},es={key:0,class:"header-center"},os={class:"main-navigation"},ss={class:"nav-item"},ts={href:"https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard",class:"nav-link"},as={class:"workspace-dropdown-item"},rs=["href"],ns={class:"workspace-icon"},is={key:1,class:"nav-divider"},ls={class:"nav-item"},cs=["href","onClick"],us={class:"header-right"},ds={class:"user-profile"},ps={class:"user-info"},fs={class:"user-name"},gs={class:"user-avatar"},ms=["src","alt"],hs={key:1,class:"avatar-placeholder"},ws={key:4,class:"header-content header-unauthenticated"},vs={class:"header-left"},ks={class:"logo-section"},_s={href:"/",class:"logo"},Ss=["src"],ys={key:1,class:"text-logo"},Es={class:"header-right"},Cs={class:"workspace-list"},Vs=["onClick"],Ns={class:"workspace-icon"},bs={class:"workspace-details"},As={class:"workspace-members"},Is={key:0,class:"current-indicator"},ae=50,Ls=e.defineComponent({__name:"AIWorkspaceHeader",props:{customLogo:{default:""},customLinks:{default:()=>[]},showUserMenu:{type:Boolean,default:!0},showWorkspaceSelector:{type:Boolean,default:!0},showSecondaryNavigation:{type:Boolean,default:!0},currentWorkspaceId:{},onProfileClick:{},onSettingsClick:{},onWorkspaceChange:{},onLogout:{},onLogin:{}},emits:["workspaceChange","logout","login","profileClick","settingsClick"],setup(a,{emit:t}){const s=a,r=t,{authState:d,logout:S,isLoading:I}=Ce(),{isSessionValid:V,sessionLossEvent:W,hasSessionLoss:h,canRetrySession:m,retrySession:i,clearSessionLoss:c}=Ae(),x=()=>{try{return Ie()}catch{return console.warn("[AIWorkspaceHeader] Pinia not initialized yet, using fallback state"),null}},k=()=>{try{return typeof window<"u"?!!window.__PINIA__||!!window.Pinia:!1}catch{return!1}},p=e.ref(x()),N=e.computed(()=>!!p.value),b=e.ref(0),v=()=>{if(!p.value&&b.value<ae){if(k()){const n=x();if(n){p.value=n,console.log("[AIWorkspaceHeader] Pinia store initialized successfully");return}}b.value++,setTimeout(v,100)}else b.value>=ae&&console.warn("[AIWorkspaceHeader] Pinia initialization failed after maximum retries, using fallback mode")};e.onMounted(()=>{p.value||v()});const u=e.ref(!1),C=e.ref(!1),f=e.ref(!1),w=e.ref([]),K=e.ref([]),T=e.ref({name:"",email:"",avatar_url:null,initials:""}),q=e.ref([]),U=e.ref([]),F=e.ref(!1);e.watch(U,async n=>{n.length>0&&N.value&&A.value&&await D()},{immediate:!1}),e.watch(()=>window.location.pathname+window.location.search+window.location.hash,async()=>{N.value&&A.value&&await D()},{immediate:!1});const H=e.ref(window.location.pathname);e.watch(()=>window.location.pathname,n=>{H.value=n},{immediate:!0}),e.watch(N,n=>{!n&&b.value<ae&&v()});const y=()=>{try{const n=window.location.pathname.match(/\/single-workspace\/(\d+)/);if(n)return n[1];const l=new URLSearchParams(window.location.search).get("workspace_id");if(l)return l;const g=window.location.hash.match(/workspace_id=(\d+)/);return g?g[1]:null}catch(n){return console.warn("[AIWorkspaceHeader] Error parsing URL for workspace_id:",n),null}},O=()=>{try{return window.location.pathname.includes("/all-workspace/")}catch(n){return console.warn("[AIWorkspaceHeader] Error checking all-workspace mode:",n),!1}},D=async()=>{if(!p.value||!N.value)return;const n=O();if(F.value=n,n){p.value.currentWorkspace=null,localStorage.removeItem("current_workspace"),console.log("[AIWorkspaceHeader] Auto-selected all-workspace mode from URL");return}const o=y();if(o)try{U.value.length===0&&await te();const l=U.value.find(g=>g.id.toString()===o);l?(p.value.setCurrentWorkspace(l),console.log(`[AIWorkspaceHeader] Auto-selected workspace from URL: ${l.title} (ID: ${l.id})`),r("workspaceChange",l)):console.warn(`[AIWorkspaceHeader] Workspace with ID ${o} not found in available workspaces`)}catch(l){console.error("[AIWorkspaceHeader] Error auto-selecting workspace from URL:",l)}},A=e.computed(()=>d.value.isAuthenticated),$=e.computed(()=>p.value?p.value.currentWorkspace:null),G=e.ref([{label:"Dashboard",key:"dashboard",url:"/dashboard"},{label:"Goals",key:"goals",url:"/goals"},{label:"Tasks",key:"tasks",url:"/tasks"},{label:"Events",key:"events",url:"/events"},{label:"Drive",key:"files",url:"/files"},{label:"Outlines",key:"outlines",url:"/outlines"},{label:"Communications",key:"communications",url:"/communications"},{label:"Canvas",key:"canvas",url:"/canvas"},{label:"AI Phone",key:"ai_phone",url:"/ai_phone"},{label:"AI Intake",key:"ai_intake",url:"/ai_intake"},{label:"AI Fax",key:"ai_fax",url:"/ai_fax"},{label:"AI Portfolios",key:"ai-portfolios",url:"/ai-portfolios"},{label:"AI Fund Analyst",key:"ai_fund_analyst",url:"/ai_fund_analyst"},{label:"Contacts",key:"contacts",url:"/contacts"},{label:"Settings",key:"settings",url:"/settings"}]),Y=e.ref([{label:"Dashboard",key:"dashboard",url:"/dashboard"},{label:"All Tasks",key:"tasks",url:"/tasks"},{label:"All Goals",key:"goals",url:"/goals"},{label:"All Events",key:"events",url:"/events"},{label:"All Drive",key:"files",url:"/files"},{label:"All Contacts",key:"contacts",url:"/contacts"},{label:"All Settings",key:"settings",url:"/settings"}]),L=e.computed(()=>F.value?Y.value:G.value),B=e.computed(()=>{try{const n=H.value;let o="";const l=n.match(/\/all-workspace\/([^\/]+)/);if(l)o=l[1];else{const g=n.match(/\/single-workspace\/\d+\/([^\/]+)/);if(g)o=g[1];else{const P=n.match(/\/([^\/]+)$/);P&&(o=P[1])}}if(o){const g=L.value.find(P=>P.key===o||P.url.includes(`/${o}`)||P.url===`/${o}`);if(g)return g.label}return"Dashboard"}catch(n){return console.warn("[AIWorkspaceHeader] Error determining current section:",n),"Dashboard"}}),j=n=>{const o=new Map;n.forEach(P=>{o.set(P.id,{...P,children:[]})});const l=[];o.forEach(P=>{P.parent_workspace_id&&o.has(P.parent_workspace_id)?o.get(P.parent_workspace_id).children.push(P):l.push(P)});const g=P=>{P.sort((z,J)=>z.title.localeCompare(J.title)),P.forEach(z=>{z.children&&g(z.children)})};return g(l),l},Z=(n,o=0,l=[])=>(n.forEach(g=>{l.push({...g,level:o}),g.children&&g.children.length&&Z(g.children,o+1,l)}),l),te=async()=>{var n,o,l;try{const g=await((n=p.value)==null?void 0:n.loadWorkspaces());if(q.value=j(g||[]),U.value=Z(q.value),K.value=U.value,w.value=U.value,s.currentWorkspaceId){const P=U.value.find(z=>{var J;return z.id.toString()===((J=s.currentWorkspaceId)==null?void 0:J.toString())});P&&((o=p.value)==null||o.setCurrentWorkspace(P))}else!$.value&&U.value.length&&((l=p.value)==null||l.setCurrentWorkspace(U.value[0]))}catch(g){console.error("loadWorkspaces (header) error",g)}},ee=n=>{if(console.log("Navigation command:",n),n==="all-workspace"){window.location.href="https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard";return}else{const o=parseInt(n.replace("workspace-",""));window.location.href=`https://single-ws-dashboard.aiworkspace.pro/single-workspace/${o}/dashboard`;return}},Ue=n=>{const o=$.value,l=F.value;switch(n.key){case"dashboard":l?window.location.href="https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard":o?window.location.href=`https://single-ws-dashboard.aiworkspace.pro/single-workspace/${o.id}/dashboard`:window.location.href="https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard";break;case"outlines":if(l)window.location.href="https://outline.aiworkspace.pro/all-workspace/outlines";else if(o){const g=`https://outline.aiworkspace.pro/single-workspace/${o.id}/outlines`;window.location.href=g}else window.location.href="https://outline.aiworkspace.pro";break;case"canvas":if(l)window.location.href="https://canvas.aiworkspace.pro/all-workspace/canvas";else if(o){const g=`https://canvas.aiworkspace.pro/single-workspace/${o.id}/canvas`;window.location.href=g}else window.location.href="https://canvas.aiworkspace.pro";break;case"files":if(l)window.location.href="https://drive.aiworkspace.pro/all-workspace/files";else if(o){const g=`https://drive.aiworkspace.pro/single-workspace/${o.id}/files`;window.location.href=g}else window.location.href="https://drive.aiworkspace.pro";break;case"tasks":if(l)window.location.href="https://tasks.aiworkspace.pro/all-workspace/tasks";else if(o){const g=`https://tasks.aiworkspace.pro/single-workspace/${o.id}/tasks`;window.location.href=g}else window.location.href="https://tasks.aiworkspace.pro";break;case"goals":if(l)window.location.href="https://app.aiworkspace.pro/all-workspace/goals";else if(o){const g=`https://app.aiworkspace.pro/single-workspace/${o.id}/goals`;window.location.href=g}else window.location.href="https://app.aiworkspace.pro/all-workspace/goals";break;case"events":if(l)window.location.href="https://app.aiworkspace.pro/all-workspace/events";else if(o){const g=`https://app.aiworkspace.pro/single-workspace/${o.id}/events`;window.location.href=g}else window.location.href="https://app.aiworkspace.pro/all-workspace/events";break;case"contacts":if(l)window.location.href="https://app.aiworkspace.pro/all-workspace/contacts";else if(o){const g=`https://app.aiworkspace.pro/single-workspace/${o.id}/contacts`;window.location.href=g}else window.location.href="https://app.aiworkspace.pro/all-workspace/contacts";break;case"ai-portfolios":if(l)window.location.href="https://spreadsheet.aiworkspace.pro/all-workspace/ai-portfolios";else if(o){const g=`https://spreadsheet.aiworkspace.pro/single-workspace/${o.id}/ai-portfolios`;window.location.href=g}else window.location.href="https://spreadsheet.aiworkspace.pro";break;case"settings":if(l)window.location.href="https://settings.aiworkspace.pro/all-workspace/settings";else if(o){const g=`https://settings.aiworkspace.pro/single-workspace/${o.id}/settings`;window.location.href=g}else window.location.href="https://settings.aiworkspace.pro";break;default:if(l){const g=`https://app.aiworkspace.pro/all-workspace/${n.key}`;window.location.href=g}else if(o){const g=`https://app.aiworkspace.pro/single-workspace/${o.id}/${n.key}`;window.location.href=g}else{const g=`https://app.aiworkspace.pro/${n.key}`;window.location.href=g}break}},Pe=n=>{const o=$.value,l=F.value;switch(n.key){case"dashboard":return l?"https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard":o?`https://single-ws-dashboard.aiworkspace.pro/single-workspace/${o.id}/dashboard`:"https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard";case"ai-portfolios":return l?"https://spreadsheet.aiworkspace.pro/all-workspace/ai-portfolios":o?`https://spreadsheet.aiworkspace.pro/single-workspace/${o.id}/ai-portfolios`:"https://spreadsheet.aiworkspace.pro";case"outlines":return l?"https://outline.aiworkspace.pro/all-workspace/outlines":o?`https://outline.aiworkspace.pro/single-workspace/${o.id}/outlines`:"https://outline.aiworkspace.pro";case"canvas":return l?"https://canvas.aiworkspace.pro/all-workspace/canvas":o?`https://canvas.aiworkspace.pro/single-workspace/${o.id}/canvas`:"https://canvas.aiworkspace.pro";case"files":return l?"https://drive.aiworkspace.pro/all-workspace/files":o?`https://drive.aiworkspace.pro/single-workspace/${o.id}/files`:"https://drive.aiworkspace.pro";case"tasks":return l?"https://tasks.aiworkspace.pro/all-workspace/tasks":o?`https://tasks.aiworkspace.pro/single-workspace/${o.id}/tasks`:"https://tasks.aiworkspace.pro";case"goals":return l?"https://app.aiworkspace.pro/all-workspace/goals":o?`https://app.aiworkspace.pro/single-workspace/${o.id}/goals`:"https://app.aiworkspace.pro/all-workspace/goals";case"events":return l?"https://app.aiworkspace.pro/all-workspace/events":o?`https://app.aiworkspace.pro/single-workspace/${o.id}/events`:"https://app.aiworkspace.pro/all-workspace/events";case"contacts":return l?"https://app.aiworkspace.pro/all-workspace/contacts":o?`https://app.aiworkspace.pro/single-workspace/${o.id}/contacts`:"https://app.aiworkspace.pro/all-workspace/contacts";case"settings":return l?"https://settings.aiworkspace.pro/all-workspace/settings":o?`https://settings.aiworkspace.pro/single-workspace/${o.id}/settings`:"https://settings.aiworkspace.pro";default:return l?`https://app.aiworkspace.pro/all-workspace/${n.key}`:o?`https://app.aiworkspace.pro/single-workspace/${o.id}/${n.key}`:`https://app.aiworkspace.pro/${n.key}`}},ne=n=>{switch(n){case"profile":s.onProfileClick?s.onProfileClick():M.ElMessage.info("Profile settings coming soon");break;case"workspaces":u.value=!0;break;case"logout":Oe();break}},he=n=>{var o;(o=p.value)==null||o.setCurrentWorkspace(n),u.value=!1,r("workspaceChange",n),M.ElMessage.success(`Switched to ${n.title}`)},De=()=>{M.ElMessageBox.prompt("Enter workspace name:","Create New Workspace",{confirmButtonText:"Create",cancelButtonText:"Cancel",inputPattern:/\S/,inputErrorMessage:"Workspace name cannot be empty"}).then(({value:n})=>{var l;const o={id:Date.now(),title:n,description:"New workspace",archived:!1,created_by:"",created_at:new Date().toISOString(),latest_activity:new Date().toISOString(),hasAccess:!0,accessType:"edit"};w.value.push(o),(l=p.value)==null||l.setWorkspaces(w.value),he(o),M.ElMessage.success(`Created workspace: ${n}`)}).catch(()=>{})},Oe=()=>{M.ElMessageBox.confirm("Are you sure you want to sign out?","Sign Out",{confirmButtonText:"Sign Out",cancelButtonText:"Cancel",type:"warning"}).then(async()=>{var n;(n=p.value)==null||n.clearData(),await S(),typeof window<"u"&&window.dispatchEvent(new CustomEvent("session-logout-detected",{detail:{timestamp:new Date,source:"manual-logout"}})),r("logout"),M.ElMessage.success("Signed out successfully")}).catch(()=>{})},ue=async()=>{var n,o;if(d.value.user){const l=d.value.user;T.value={name:l.name||((n=l.email)==null?void 0:n.split("@")[0])||"User",email:l.email||"",avatar_url:l.avatar_url||null,initials:(l.name||((o=l.email)==null?void 0:o.split("@")[0])||"U").split(" ").map(g=>g[0]).join("").toUpperCase().substring(0,2)},s.showWorkspaceSelector&&await te()}};e.watch(()=>d.value.user,n=>{var o;n?ue():(T.value={name:"",email:"",avatar_url:null,initials:""},(o=p.value)==null||o.clearData())}),e.watch(h,n=>{n&&A.value&&(console.log("[AIWorkspaceHeader] Session loss detected, showing modal"),f.value=!0)}),e.watch(()=>s.currentWorkspaceId,n=>{var o;if(n&&U.value.length){const l=U.value.find(g=>g.id.toString()===n.toString());l&&((o=p.value)==null||o.setCurrentWorkspace(l))}}),e.onMounted(async()=>{A.value&&(await ue(),await D())});const Te=async n=>{console.log("Login successful:",n),C.value=!1,await ue(),r("login"),M.ElMessage.success("Welcome back!")},He=async()=>{console.log("[AIWorkspaceHeader] Retrying session..."),await i()?(f.value=!1,c(),M.ElMessage.success("Session restored successfully!")):M.ElMessage.error("Failed to restore session. Please log in again.")},Fe=()=>{console.log("[AIWorkspaceHeader] Opening login modal from session loss"),f.value=!1,C.value=!0},ze=()=>{console.log("[AIWorkspaceHeader] Refreshing page due to session loss"),window.location.reload()},Ke=()=>{b.value=0,v(),M.ElMessage.success("Manual Pinia retry initiated.")};return(n,o)=>{const l=e.resolveComponent("el-icon"),g=e.resolveComponent("el-button"),P=e.resolveComponent("el-tag"),z=e.resolveComponent("el-dropdown-item"),J=e.resolveComponent("el-dropdown-menu"),de=e.resolveComponent("el-dropdown"),qe=e.resolveComponent("el-dialog");return e.openBlock(),e.createElementBlock("header",Uo,[!N.value&&b.value<ae||e.unref(I)?(e.openBlock(),e.createElementBlock("div",Po,[o[10]||(o[10]=e.createStaticVNode('<div class="header-left" data-v-2d5d4116><div class="logo-section" data-v-2d5d4116><a href="/" class="logo" data-v-2d5d4116><div class="text-logo" data-v-2d5d4116><span class="logo-text" data-v-2d5d4116>AI Workspace</span></div></a></div></div>',1)),e.createElementVNode("div",Do,[e.createElementVNode("span",Oo,[e.unref(I)?(e.openBlock(),e.createElementBlock("span",To,"Syncing authentication...")):(e.openBlock(),e.createElementBlock("span",Ho,"Initializing..."))])])])):!N.value&&b.value>=ae?(e.openBlock(),e.createElementBlock("div",Fo,[o[12]||(o[12]=e.createStaticVNode('<div class="header-left" data-v-2d5d4116><div class="logo-section" data-v-2d5d4116><a href="/" class="logo" data-v-2d5d4116><div class="text-logo" data-v-2d5d4116><span class="logo-text" data-v-2d5d4116>AI Workspace</span></div></a></div></div>',1)),e.createElementVNode("div",{class:"header-center"},[o[11]||(o[11]=e.createElementVNode("span",{class:"fallback-text"},"Header Ready (Fallback Mode)",-1)),e.createElementVNode("button",{onClick:Ke,class:"retry-button"},"Retry Pinia")]),o[13]||(o[13]=e.createStaticVNode('<div class="header-right" data-v-2d5d4116><div class="user-profile" data-v-2d5d4116><div class="user-info" data-v-2d5d4116><span class="user-name" data-v-2d5d4116>User</span></div><div class="user-avatar" data-v-2d5d4116><span class="avatar-placeholder" data-v-2d5d4116>U</span></div></div></div>',1))])):A.value&&!e.unref(V)?(e.openBlock(),e.createElementBlock("div",zo,[o[16]||(o[16]=e.createStaticVNode('<div class="header-left" data-v-2d5d4116><div class="logo-section" data-v-2d5d4116><a href="/" class="logo" data-v-2d5d4116><div class="text-logo" data-v-2d5d4116><span class="logo-text" data-v-2d5d4116>AI Workspace</span></div></a></div></div>',1)),e.createElementVNode("div",Ko,[e.createElementVNode("span",qo,[e.createVNode(l,null,{default:e.withCtx(()=>[e.createVNode(e.unref(Se))]),_:1}),o[14]||(o[14]=e.createTextVNode(" Session expired - Please log in again ",-1))])]),e.createElementVNode("div",Go,[e.createVNode(g,{type:"primary",onClick:o[0]||(o[0]=E=>C.value=!0)},{default:e.withCtx(()=>[e.createVNode(l,null,{default:e.withCtx(()=>[e.createVNode(e.unref(pe))]),_:1}),o[15]||(o[15]=e.createTextVNode(" Log In ",-1))]),_:1})])])):A.value&&e.unref(V)?(e.openBlock(),e.createElementBlock("div",Yo,[e.createElementVNode("div",jo,[e.createElementVNode("div",Jo,[e.createElementVNode("a",Xo,[n.customLogo?(e.openBlock(),e.createElementBlock("img",{key:0,src:n.customLogo,alt:"AIWorkspace",class:"logo-image"},null,8,Qo)):(e.openBlock(),e.createElementBlock("div",Zo,[...o[17]||(o[17]=[e.createElementVNode("span",{class:"logo-text"},"AI Workspace",-1)])]))])])]),n.showSecondaryNavigation?(e.openBlock(),e.createElementBlock("div",es,[e.createElementVNode("nav",os,[n.showWorkspaceSelector?(e.openBlock(),e.createBlock(de,{key:0,onCommand:ee,trigger:"hover"},{dropdown:e.withCtx(()=>[e.createVNode(J,{class:"workspace-tree-dropdown"},{default:e.withCtx(()=>[e.createVNode(z,{command:"all-workspace",class:e.normalizeClass({active:F.value})},{default:e.withCtx(()=>[e.createElementVNode("a",ts,[e.createElementVNode("div",as,[o[19]||(o[19]=e.createElementVNode("span",{class:"workspace-icon"},"ðŸŒ",-1)),o[20]||(o[20]=e.createElementVNode("span",null,"All workspace",-1)),F.value?(e.openBlock(),e.createBlock(P,{key:0,size:"small",type:"success"},{default:e.withCtx(()=>[...o[18]||(o[18]=[e.createTextVNode("Current",-1)])]),_:1})):e.createCommentVNode("",!0)])])]),_:1},8,["class"]),U.value.length>0?(e.openBlock(),e.createBlock(z,{key:0,divided:"",disabled:""})):e.createCommentVNode("",!0),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(U.value,E=>(e.openBlock(),e.createBlock(z,{key:E.id,command:`workspace-${E.id}`},{default:e.withCtx(()=>{var oe;return[e.createElementVNode("a",{href:`https://single-ws-dashboard.aiworkspace.pro/single-workspace/${E.id}/dashboard`,class:"nav-link"},[e.createElementVNode("div",{class:"workspace-dropdown-item",style:e.normalizeStyle({paddingLeft:(E.level||0)*16+"px"})},[e.createElementVNode("span",ns,e.toDisplayString(E.children&&E.children.length?"ðŸ“":"ðŸ“„"),1),e.createElementVNode("span",null,e.toDisplayString(E.title),1),E.id===((oe=$.value)==null?void 0:oe.id)?(e.openBlock(),e.createBlock(P,{key:0,size:"small",type:"success"},{default:e.withCtx(()=>[...o[21]||(o[21]=[e.createTextVNode("Current",-1)])]),_:1})):e.createCommentVNode("",!0)],4)],8,rs)]}),_:2},1032,["command"]))),128)),U.value.length===0?(e.openBlock(),e.createBlock(z,{key:1,disabled:""},{default:e.withCtx(()=>[...o[22]||(o[22]=[e.createTextVNode(" No workspaces ",-1)])]),_:1})):e.createCommentVNode("",!0)]),_:1})]),default:e.withCtx(()=>{var E;return[e.createElementVNode("span",ss,[e.createTextVNode(e.toDisplayString(F.value?"All workspace":((E=$.value)==null?void 0:E.title)||"Select Workspace")+" ",1),e.createVNode(l,{class:"nav-arrow"},{default:e.withCtx(()=>[e.createVNode(e.unref(ve))]),_:1})])]}),_:1})):e.createCommentVNode("",!0),n.showWorkspaceSelector?(e.openBlock(),e.createElementBlock("span",is,"/")):e.createCommentVNode("",!0),n.showSecondaryNavigation?(e.openBlock(),e.createBlock(de,{key:2,trigger:"hover"},{dropdown:e.withCtx(()=>[e.createVNode(J,null,{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(L.value,E=>(e.openBlock(),e.createBlock(z,{key:E.label,class:e.normalizeClass({active:E.active})},{default:e.withCtx(()=>[e.createElementVNode("a",{href:Pe(E),class:"nav-link",onClick:e.withModifiers(oe=>Ue(E),["prevent"])},e.toDisplayString(E.label),9,cs)]),_:2},1032,["class"]))),128))]),_:1})]),default:e.withCtx(()=>[e.createElementVNode("span",ls,[e.createTextVNode(e.toDisplayString(B.value)+" ",1),e.createVNode(l,{class:"nav-arrow"},{default:e.withCtx(()=>[e.createVNode(e.unref(ve))]),_:1})])]),_:1})):e.createCommentVNode("",!0)])])):e.createCommentVNode("",!0),e.createElementVNode("div",us,[e.createVNode(de,{onCommand:ne,trigger:"click",placement:"bottom-end"},{dropdown:e.withCtx(()=>[e.createVNode(J,null,{default:e.withCtx(()=>[e.createVNode(z,null,{default:e.withCtx(()=>[e.createElementVNode("a",{href:"/profile",class:"nav-link",onClick:o[1]||(o[1]=e.withModifiers(E=>ne("profile"),["prevent"]))},"Profile Settings")]),_:1}),n.showWorkspaceSelector?(e.openBlock(),e.createBlock(z,{key:0},{default:e.withCtx(()=>[e.createElementVNode("a",{href:"#switch-workspace",class:"nav-link",onClick:o[2]||(o[2]=e.withModifiers(E=>ne("workspaces"),["prevent"]))},"Switch Workspace")]),_:1})):e.createCommentVNode("",!0),e.createVNode(z,{divided:""},{default:e.withCtx(()=>[e.createElementVNode("a",{href:"#signout",class:"nav-link",onClick:o[3]||(o[3]=e.withModifiers(E=>ne("logout"),["prevent"]))},"Sign Out")]),_:1})]),_:1})]),default:e.withCtx(()=>[e.createElementVNode("div",ds,[e.createElementVNode("div",ps,[e.createElementVNode("span",fs,e.toDisplayString(T.value.name),1)]),e.createElementVNode("div",gs,[T.value.avatar_url?(e.openBlock(),e.createElementBlock("img",{key:0,src:T.value.avatar_url,alt:T.value.name},null,8,ms)):(e.openBlock(),e.createElementBlock("span",hs,e.toDisplayString(T.value.initials),1))])])]),_:1})])])):(e.openBlock(),e.createElementBlock("div",ws,[e.createElementVNode("div",vs,[e.createElementVNode("div",ks,[e.createElementVNode("a",_s,[n.customLogo?(e.openBlock(),e.createElementBlock("img",{key:0,src:n.customLogo,alt:"AIWorkspace",class:"logo-image"},null,8,Ss)):(e.openBlock(),e.createElementBlock("div",ys,[...o[23]||(o[23]=[e.createElementVNode("span",{class:"logo-text"},"AI Workspace",-1)])]))])])]),o[25]||(o[25]=e.createElementVNode("div",{class:"header-center"},[e.createElementVNode("span",{class:"welcome-text"},"Welcome to AI Workspace")],-1)),e.createElementVNode("div",Es,[e.createVNode(g,{type:"primary",size:"large",class:"login-button",onClick:o[4]||(o[4]=E=>C.value=!0)},{default:e.withCtx(()=>[e.createVNode(l,null,{default:e.withCtx(()=>[e.createVNode(e.unref(pe))]),_:1}),o[24]||(o[24]=e.createTextVNode(" Login / Signup ",-1))]),_:1})])])),A.value&&n.showWorkspaceSelector?(e.openBlock(),e.createBlock(qe,{key:5,modelValue:u.value,"onUpdate:modelValue":o[6]||(o[6]=E=>u.value=E),title:"Switch Workspace",width:"500px",onClose:o[7]||(o[7]=E=>u.value=!1)},{footer:e.withCtx(()=>[e.createVNode(g,{onClick:o[5]||(o[5]=E=>u.value=!1)},{default:e.withCtx(()=>[...o[26]||(o[26]=[e.createTextVNode("Cancel",-1)])]),_:1}),e.createVNode(g,{type:"primary",onClick:De},{default:e.withCtx(()=>[...o[27]||(o[27]=[e.createTextVNode("Create New Workspace",-1)])]),_:1})]),default:e.withCtx(()=>[e.createElementVNode("div",Cs,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(w.value,E=>{var oe,we;return e.openBlock(),e.createElementBlock("div",{key:E.id,class:e.normalizeClass(["workspace-item",{active:E.id===((oe=$.value)==null?void 0:oe.id)}]),onClick:Ws=>he(E)},[e.createElementVNode("div",Ns,e.toDisplayString(E.children&&E.children.length?"ðŸ“":"ðŸ“„"),1),e.createElementVNode("div",bs,[e.createElementVNode("h3",null,e.toDisplayString(E.title),1),e.createElementVNode("p",null,e.toDisplayString(E.description),1),e.createElementVNode("span",As,e.toDisplayString(E.hasAccess?"Active":"Inactive"),1)]),E.id===((we=$.value)==null?void 0:we.id)?(e.openBlock(),e.createElementBlock("div",Is,[e.createVNode(l,null,{default:e.withCtx(()=>[e.createVNode(e.unref(Ze))]),_:1})])):e.createCommentVNode("",!0)],10,Vs)}),128))])]),_:1},8,["modelValue"])):e.createCommentVNode("",!0),e.createVNode(xe,{modelValue:C.value,"onUpdate:modelValue":o[8]||(o[8]=E=>C.value=E),onLoginSuccess:Te},null,8,["modelValue"]),e.createVNode(Me,{modelValue:f.value,"onUpdate:modelValue":o[9]||(o[9]=E=>f.value=E),"session-loss-event":e.unref(W),"can-retry-session":e.unref(m)||!1,onRetry:He,onLogin:Fe,onRefresh:ze},null,8,["modelValue","session-loss-event","can-retry-session"])])}}});const Be=le(Ls,[["__scopeId","data-v-2d5d4116"]]),xs={class:"auth-callback"},Ms=e.defineComponent({__name:"AuthCallback",setup(a){e.onMounted(async()=>{console.log("[AuthCallback] Component mounted, starting callback processing..."),console.log("[AuthCallback] Current URL:",window.location.href),console.log("[AuthCallback] Current hash:",window.location.hash);try{await new Promise(d=>setTimeout(d,500));const{data:s,error:r}=await R.supabase.auth.getSession();if(r){console.error("Error processing callback:",r),t();return}if(s!=null&&s.session){const d=s.session.user;console.log("OAuth login successful:",d.email),s.session.access_token&&_.setSessionCookie(_.ACCESS_COOKIE,s.session.access_token),s.session.refresh_token&&_.setSessionCookie(_.REFRESH_COOKIE,s.session.refresh_token),_.syncCookiesToLocalStorage();const S=_.getPostLoginBase();console.log("[callback] Post-login redirect URL:",S),console.log("[callback] Session storage redirect:",sessionStorage.getItem("post-login-redirect")),console.log("[callback] Local storage redirect:",localStorage.getItem("post-login-redirect"));const I=S||"/";if(console.log("[callback] Final redirect URL:",I),I.startsWith("/")){const V=window.location.origin,W=`${V}${I}`;console.log("[callback] redirecting to:",W,{hostname:window.location.hostname,origin:V}),sessionStorage.removeItem("post-login-redirect"),localStorage.removeItem("post-login-redirect"),setTimeout(()=>{window.location.href=W},100)}else console.log("[callback] redirecting to absolute URL:",I),sessionStorage.removeItem("post-login-redirect"),localStorage.removeItem("post-login-redirect"),setTimeout(()=>{window.location.href=I},100)}else t()}catch(s){console.error("Error processing callback:",s),t()}});const t=()=>{const r=window.location.href.replace("/auth/callback","");window.location.href=r};return(s,r)=>(e.openBlock(),e.createElementBlock("div",xs,[...r[0]||(r[0]=[e.createElementVNode("div",{class:"callback-container"},[e.createElementVNode("div",{class:"loading-spinner"},[e.createElementVNode("div",{class:"spinner"})]),e.createElementVNode("h2",null,"Processing login..."),e.createElementVNode("p",null,"Please wait while we complete your authentication.")],-1)])]))}});const Bs=le(Ms,[["__scopeId","data-v-acdf6325"]]),Q=class Q{constructor(){se(this,"validationCache",new Map);se(this,"CACHE_DURATION",me().validationCacheDuration)}getCookieValue(t){var d;if(typeof document>"u")return null;const r=`; ${document.cookie}`.split(`; ${t}=`);return r.length===2&&((d=r.pop())==null?void 0:d.split(";").shift())||null}static getInstance(){return Q.instance||(Q.instance=new Q),Q.instance}async validateSession(t=!1){const s="session_validation";if(!t){const r=this.validationCache.get(s);if(r&&Date.now()-r.timestamp<this.CACHE_DURATION)return console.log("[SessionValidator] Using cached validation result"),r.result}console.log("[SessionValidator] Validating session...");try{const r=this.getCookieValue("sb-access-token"),d=this.getCookieValue("sb-refresh-token");if(!r||!d){const i={isValid:!1,needsLogin:!0,error:"No authentication tokens found",canRetry:!1};return this.cacheResult(s,i),i}const S=await R.getSupabase(),{data:{session:I},error:V}=await S.auth.getSession();if(V){console.warn("[SessionValidator] Error getting session:",V);const i={isValid:!1,needsLogin:!0,error:`Session error: ${V.message}`,canRetry:!0};return this.cacheResult(s,i),i}if(!I||!I.user){const i={isValid:!1,needsLogin:!0,error:"No valid session found",canRetry:!0};return this.cacheResult(s,i),i}const W=new Date,h=new Date(I.expires_at*1e3);if(W>=h){const i={isValid:!1,needsLogin:!0,error:"Session has expired",canRetry:!0};return this.cacheResult(s,i),i}const m={isValid:!0,needsLogin:!1,canRetry:!1};return this.cacheResult(s,m),m}catch(r){console.error("[SessionValidator] Error validating session:",r);const d={isValid:!1,needsLogin:!0,error:`Validation error: ${r}`,canRetry:!0};return this.cacheResult(s,d),d}}async restoreSession(){console.log("[SessionValidator] Attempting to restore session...");try{const t=this.getCookieValue("sb-access-token"),s=this.getCookieValue("sb-refresh-token");if(!t||!s)return{isValid:!1,needsLogin:!0,error:"No tokens available for restoration",canRetry:!1};const r=await R.getSupabase(),{data:d,error:S}=await r.auth.setSession({access_token:t,refresh_token:s});return S?(console.warn("[SessionValidator] Error restoring session:",S),{isValid:!1,needsLogin:!0,error:`Restoration error: ${S.message}`,canRetry:!0}):d.session&&d.session.user?(console.log("[SessionValidator] Session restored successfully"),this.clearCache(),{isValid:!0,needsLogin:!1,canRetry:!1}):{isValid:!1,needsLogin:!0,error:"Session restoration failed",canRetry:!0}}catch(t){return console.error("[SessionValidator] Error restoring session:",t),{isValid:!1,needsLogin:!0,error:`Restoration error: ${t}`,canRetry:!0}}}clearCache(){this.validationCache.clear(),console.log("[SessionValidator] Cache cleared")}cacheResult(t,s){this.validationCache.set(t,{result:s,timestamp:Date.now()})}getCachedResult(){const t=this.validationCache.get("session_validation");return t&&Date.now()-t.timestamp<this.CACHE_DURATION?t.result:null}};se(Q,"instance");let ie=Q;const ce=ie.getInstance(),Re=(a=!1)=>ce.validateSession(a),$e=()=>ce.restoreSession(),We=()=>ce.clearCache();async function Rs(){console.log("[SessionValidator] Initializing session validation...");let a=await Re();return!a.isValid&&a.canRetry&&(console.log("[SessionValidator] Attempting session restoration..."),a=await $e()),a}function $s(){if(typeof window>"u")return()=>{};const a=()=>{console.log("[SessionValidator] Network restored, clearing cache for revalidation"),We()},t=()=>{console.log("[SessionValidator] Network lost, session validation may fail")};return window.addEventListener("online",a),window.addEventListener("offline",t),()=>{window.removeEventListener("online",a),window.removeEventListener("offline",t)}}exports.configureSupabase=R.configureSupabase;exports.initializeCrossSubdomainAuth=R.initializeCrossSubdomainAuth;exports.restoreCrossSubdomainSession=R.restoreCrossSubdomainSession;exports.restoreSessionWithRetry=R.restoreSessionWithRetry;exports.setupAuthStateListener=R.setupAuthStateListener;Object.defineProperty(exports,"supabase",{enumerable:!0,get:()=>R.supabase});exports.ACCESS_COOKIE=_.ACCESS_COOKIE;exports.LS_ACCESS_KEY=_.LS_ACCESS_KEY;exports.LS_REFRESH_KEY=_.LS_REFRESH_KEY;exports.REFRESH_COOKIE=_.REFRESH_COOKIE;exports.buildOAuthRedirectUrl=_.buildOAuthRedirectUrl;exports.clearLocalStorageTokens=_.clearLocalStorageTokens;exports.clearSessionCookie=_.clearSessionCookie;exports.ensureCrossSubdomainCookies=_.ensureCrossSubdomainCookies;exports.getCookie=_.getCookie;exports.getPostLoginBase=_.getPostLoginBase;exports.setSessionCookie=_.setSessionCookie;exports.syncCookiesToLocalStorage=_.syncCookiesToLocalStorage;exports.setupUniversalCallback=Je.setupUniversalCallback;exports.AIWorkspaceHeader=Be;exports.AuthCallback=Bs;exports.LoginModal=xe;exports.PackageError=re;exports.SessionLossModal=Me;exports.SessionValidator=ie;exports.clearSessionCache=We;exports.conservativeConfig=Ne;exports.createSessionConfig=mo;exports.default=Be;exports.defaultSessionConfig=X;exports.detectionScenarios=vo;exports.developmentConfig=fe;exports.fastDetectionConfig=Ve;exports.getConfigByPreset=ho;exports.getSessionConfig=me;exports.handleBundlingError=ye;exports.initializeSessionValidation=Rs;exports.productionConfig=ge;exports.restoreSession=$e;exports.safeExecute=no;exports.safeExecuteAsync=io;exports.safeGetCookie=co;exports.safeGetLocalStorage=po;exports.safeImport=lo;exports.safeSetCookie=uo;exports.safeSetLocalStorage=fo;exports.safeWindowOperation=go;exports.sessionConfigPresets=be;exports.sessionValidator=ce;exports.setupGlobalErrorHandler=Ee;exports.setupNetworkAwareValidation=$s;exports.timingInfo=wo;exports.useAuth=Le;exports.useEnhancedAuth=Ce;exports.useSessionMonitor=Ae;exports.useWorkspaceStore=Ie;exports.validateSession=Re;
