"use strict";var Ao=Object.create;var ve=Object.defineProperty;var Io=Object.getOwnPropertyDescriptor;var xo=Object.getOwnPropertyNames;var Ro=Object.getPrototypeOf,Lo=Object.prototype.hasOwnProperty;var To=(t,s,a)=>s in t?ve(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a;var Mo=(t,s,a,i)=>{if(s&&typeof s=="object"||typeof s=="function")for(let u of xo(s))!Lo.call(t,u)&&u!==a&&ve(t,u,{get:()=>s[u],enumerable:!(i=Io(s,u))||i.enumerable});return t};var Bo=(t,s,a)=>(a=t!=null?Ao(Ro(t)):{},Mo(s||!t||!t.__esModule?ve(a,"default",{value:t,enumerable:!0}):a,t));var re=(t,s,a)=>(To(t,typeof s!="symbol"?s+"":s,a),a);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),M=require("element-plus"),R=require("./supabase-602ce100.js"),f=require("./utils/authRedirect.js"),Ho=require("pinia"),Do=require("./utils/universalCallback.js");/*! Element Plus Icons Vue v2.3.2 */var Uo=e.defineComponent({name:"ArrowDown",__name:"arrow-down",setup(t){return(s,a)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M831.872 340.864 512 652.672 192.128 340.864a30.59 30.59 0 0 0-42.752 0 29.12 29.12 0 0 0 0 41.6L489.664 714.24a32 32 0 0 0 44.672 0l340.288-331.712a29.12 29.12 0 0 0 0-41.728 30.59 30.59 0 0 0-42.752 0z"})]))}}),Pe=Uo,$o=e.defineComponent({name:"Check",__name:"check",setup(t){return(s,a)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M406.656 706.944 195.84 496.256a32 32 0 1 0-45.248 45.248l256 256 512-512a32 32 0 0 0-45.248-45.248L406.592 706.944z"})]))}}),Oo=$o,Po=e.defineComponent({name:"Lock",__name:"lock",setup(t){return(s,a)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M224 448a32 32 0 0 0-32 32v384a32 32 0 0 0 32 32h576a32 32 0 0 0 32-32V480a32 32 0 0 0-32-32zm0-64h576a96 96 0 0 1 96 96v384a96 96 0 0 1-96 96H224a96 96 0 0 1-96-96V480a96 96 0 0 1 96-96"}),e.createElementVNode("path",{fill:"currentColor",d:"M512 544a32 32 0 0 1 32 32v192a32 32 0 1 1-64 0V576a32 32 0 0 1 32-32m192-160v-64a192 192 0 1 0-384 0v64zM512 64a256 256 0 0 1 256 256v128H256V320A256 256 0 0 1 512 64"})]))}}),We=Po,Wo=e.defineComponent({name:"Message",__name:"message",setup(t){return(s,a)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M128 224v512a64 64 0 0 0 64 64h640a64 64 0 0 0 64-64V224zm0-64h768a64 64 0 0 1 64 64v512a128 128 0 0 1-128 128H192A128 128 0 0 1 64 736V224a64 64 0 0 1 64-64"}),e.createElementVNode("path",{fill:"currentColor",d:"M904 224 656.512 506.88a192 192 0 0 1-289.024 0L120 224zm-698.944 0 210.56 240.704a128 128 0 0 0 192.704 0L818.944 224z"})]))}}),Go=Wo,Fo=e.defineComponent({name:"Refresh",__name:"refresh",setup(t){return(s,a)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M771.776 794.88A384 384 0 0 1 128 512h64a320 320 0 0 0 555.712 216.448H654.72a32 32 0 1 1 0-64h149.056a32 32 0 0 1 32 32v148.928a32 32 0 1 1-64 0v-50.56zM276.288 295.616h92.992a32 32 0 0 1 0 64H220.16a32 32 0 0 1-32-32V178.56a32 32 0 0 1 64 0v50.56A384 384 0 0 1 896.128 512h-64a320 320 0 0 0-555.776-216.384z"})]))}}),_e=Fo,Ko=e.defineComponent({name:"User",__name:"user",setup(t){return(s,a)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M512 512a192 192 0 1 0 0-384 192 192 0 0 0 0 384m0 64a256 256 0 1 1 0-512 256 256 0 0 1 0 512m320 320v-96a96 96 0 0 0-96-96H288a96 96 0 0 0-96 96v96a32 32 0 1 1-64 0v-96a160 160 0 0 1 160-160h448a160 160 0 0 1 160 160v96a32 32 0 1 1-64 0"})]))}}),Se=Ko,zo=e.defineComponent({name:"Warning",__name:"warning",setup(t){return(s,a)=>(e.openBlock(),e.createElementBlock("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},[e.createElementVNode("path",{fill:"currentColor",d:"M512 64a448 448 0 1 1 0 896 448 448 0 0 1 0-896m0 832a384 384 0 0 0 0-768 384 384 0 0 0 0 768m48-176a48 48 0 1 1-96 0 48 48 0 0 1 96 0m-48-464a32 32 0 0 1 32 32v288a32 32 0 0 1-64 0V288a32 32 0 0 1 32-32"})]))}}),Ge=zo;class ue extends Error{constructor(a,i={},u){super(a);re(this,"context");re(this,"originalError");this.name="PackageError",this.context=i,this.originalError=u}}function jo(t,s={},a){try{const i=t();return i instanceof Promise?i.catch(u=>{if(console.warn("[ErrorHandler] Async operation failed:",{context:s,error:u.message,stack:u.stack}),a!==void 0)return a;throw new ue(`Async operation failed: ${u.message}`,s,u)}):i}catch(i){if(console.warn("[ErrorHandler] Operation failed:",{context:s,error:i instanceof Error?i.message:String(i),stack:i instanceof Error?i.stack:void 0}),a!==void 0)return a;throw new ue(`Operation failed: ${i instanceof Error?i.message:String(i)}`,s,i instanceof Error?i:void 0)}}async function Yo(t,s={},a){try{return await t()}catch(i){if(console.warn("[ErrorHandler] Async operation failed:",{context:s,error:i instanceof Error?i.message:String(i),stack:i instanceof Error?i.stack:void 0}),a!==void 0)return a;throw new ue(`Async operation failed: ${i instanceof Error?i.message:String(i)}`,s,i instanceof Error?i:void 0)}}function Fe(t,s={}){const a=t.message.toLowerCase();if(a.includes("is not a function")||a.includes("cannot read property")||a.includes("undefined is not a function")){console.warn("[ErrorHandler] Bundling error detected:",{context:s,error:t.message,suggestion:"This may be due to minification or import issues. The package will continue with fallback behavior."});return}throw new ue(`Unexpected error: ${t.message}`,s,t)}async function qo(t,s={},a){try{return await t()}catch(i){return console.warn("[ErrorHandler] Import failed:",{context:s,error:i instanceof Error?i.message:String(i)}),a!==void 0?a:void 0}}function Jo(t){var s;try{if(typeof document>"u")return null;const i=`; ${document.cookie}`.split(`; ${t}=`);return i.length===2&&((s=i.pop())==null?void 0:s.split(";").shift())||null}catch(a){return console.warn("[ErrorHandler] Cookie access failed:",{cookieName:t,error:a instanceof Error?a.message:String(a)}),null}}function Xo(t,s,a={}){try{if(typeof document>"u")return!1;let i=`${t}=${s}`;return a.domain&&(i+=`; domain=${a.domain}`),a.path&&(i+=`; path=${a.path}`),a.secure&&(i+="; secure"),a.sameSite&&(i+=`; samesite=${a.sameSite}`),a.maxAge&&(i+=`; max-age=${a.maxAge}`),document.cookie=i,!0}catch(i){return console.warn("[ErrorHandler] Cookie setting failed:",{cookieName:t,error:i instanceof Error?i.message:String(i)}),!1}}function Qo(t){try{return typeof localStorage>"u"?null:localStorage.getItem(t)}catch(s){return console.warn("[ErrorHandler] localStorage get failed:",{key:t,error:s instanceof Error?s.message:String(s)}),null}}function Zo(t,s){try{return typeof localStorage>"u"?!1:(localStorage.setItem(t,s),!0)}catch(a){return console.warn("[ErrorHandler] localStorage set failed:",{key:t,error:a instanceof Error?a.message:String(a)}),!1}}function et(t,s){try{return typeof window>"u"?s:t(window)}catch(a){return console.warn("[ErrorHandler] Window operation failed:",{error:a instanceof Error?a.message:String(a)}),s}}function Ke(){typeof window>"u"||(window.addEventListener("unhandledrejection",t=>{const s=t.reason;if(s instanceof Error){const a=s.message.toLowerCase();if(a.includes("is not a function")||a.includes("cannot read property")||a.includes("undefined is not a function")){console.warn("[ErrorHandler] Unhandled promise rejection (bundling error):",{error:s.message,stack:s.stack}),t.preventDefault();return}}console.error("[ErrorHandler] Unhandled promise rejection:",t.reason)}),window.addEventListener("error",t=>{const s=t.error;if(s instanceof Error){const a=s.message.toLowerCase();if(a.includes("is not a function")||a.includes("cannot read property")||a.includes("undefined is not a function")){console.warn("[ErrorHandler] Uncaught error (bundling error):",{error:s.message,stack:s.stack}),t.preventDefault();return}}console.error("[ErrorHandler] Uncaught error:",t.error)}))}typeof window<"u"&&Ke();function ze(){const t=e.ref({user:null,isAuthenticated:!1,isLoading:!0,error:null}),s=e.ref(null),a=e.computed(()=>t.value.isAuthenticated),i=e.computed(()=>t.value.user),u=e.computed(()=>t.value.isLoading),m=async()=>{var p,c,d,L,v,h,I,A,E,k,V;try{console.log("[auth][enhanced] Starting loadUserInfo..."),console.log("[auth][enhanced] Ensuring cross-subdomain cookie synchronization..."),(S=>{try{const U=location.hostname;if(U==="localhost"||/^\d+\.\d+\.\d+\.\d+$/.test(U)){console.log("[auth][enhanced] Skipping cookie sync for localhost");return}const $="aiworkspace.pro";if(!U.endsWith(`.${$}`)&&U!==$){console.log("[auth][enhanced] Skipping cookie sync - not under apex domain");return}console.log("[auth][enhanced] Performing cookie synchronization"),S.forEach(q=>{const b=document.cookie.split(";").find(T=>T.trim().startsWith(q+"="));if(b){console.log(`[auth][enhanced] Found cookie: ${q}`);const T=b.split("=")[1];T&&(document.cookie=`${q}=${T}; domain=.${$}; path=/; secure; samesite=lax`)}})}catch(U){console.warn("[auth][enhanced] Error in cookie sync:",U)}})(["sb-access-token","sb-refresh-token"]);let O=null;try{const U=await(await R.getSupabase()).auth.getSession();O=(p=U==null?void 0:U.data)==null?void 0:p.session}catch(S){console.warn("[auth][enhanced] Error getting Supabase session:",S)}if(O&&O.user){console.log("[auth][enhanced] Active Supabase session found");const S=O.user,U={id:S.id,name:((c=S.user_metadata)==null?void 0:c.name)||((d=S.user_metadata)==null?void 0:d.user_name)||((L=S.user_metadata)==null?void 0:L.full_name)||((v=S.email)==null?void 0:v.split("@")[0])||"User",email:S.email,avatar_url:((h=S.user_metadata)==null?void 0:h.avatar_url)||null,user_metadata:S.user_metadata};return t.value={user:U,isAuthenticated:!0,isLoading:!1,error:null},s.value={user:U,access_token:O.access_token,refresh_token:O.refresh_token},{user:U,session:s.value,error:null}}console.log("[auth][enhanced] No active session, attempting to restore from cookies...");const D=await R.restoreSessionWithRetry(5,200);if(D.success&&D.session){console.log("[auth][enhanced] Session restored successfully from cookies");const S=D.session.user,U={id:S.id,name:((I=S.user_metadata)==null?void 0:I.name)||((A=S.user_metadata)==null?void 0:A.user_name)||((E=S.user_metadata)==null?void 0:E.full_name)||((k=S.email)==null?void 0:k.split("@")[0])||"User",email:S.email,avatar_url:((V=S.user_metadata)==null?void 0:V.avatar_url)||null,user_metadata:S.user_metadata};return t.value={user:U,isAuthenticated:!0,isLoading:!1,error:null},s.value=D.session,{user:U,session:s.value,error:null}}else console.log("[auth][enhanced] Failed to restore session:",D.error)}catch(w){console.error("Error getting Supabase session:",w),w instanceof Error&&Fe(w,{component:"useEnhancedAuth",function:"loadUserInfo",operation:"session_validation"})}return console.log("[auth][enhanced] No valid authentication found"),t.value={user:null,isAuthenticated:!1,isLoading:!1,error:"No valid session found"},s.value=null,{user:null,session:null,error:"No valid session found"}},y=async()=>{try{f.broadcastAuthState({type:"SIGNED_OUT",timestamp:Date.now()}),await(await R.getSupabase()).auth.signOut(),f.clearSessionCookie(f.ACCESS_COOKIE),f.clearSessionCookie(f.REFRESH_COOKIE),f.clearLocalStorageTokens(),t.value={user:null,isAuthenticated:!1,isLoading:!1,error:null},s.value=null,console.log("[auth][enhanced] User logged out successfully")}catch(p){console.error("Error during logout:",p),t.value={user:null,isAuthenticated:!1,isLoading:!1,error:null},s.value=null}},N=async(p,c)=>{var d,L,v,h,I;try{t.value.isLoading=!0;const A=await R.getSupabase(),{data:E,error:k}=await A.auth.signInWithPassword({email:p,password:c});if(k)throw k;if(E.session){const V=E.session.user,w={id:V.id,name:((d=V.user_metadata)==null?void 0:d.name)||((L=V.user_metadata)==null?void 0:L.user_name)||((v=V.user_metadata)==null?void 0:v.full_name)||((h=V.email)==null?void 0:h.split("@")[0])||"User",email:V.email,avatar_url:((I=V.user_metadata)==null?void 0:I.avatar_url)||null,user_metadata:V.user_metadata};return t.value={user:w,isAuthenticated:!0,isLoading:!1,error:null},s.value={user:w,access_token:E.session.access_token,refresh_token:E.session.refresh_token},{user:w,session:s.value,error:null}}return{user:null,session:null,error:"No session returned"}}catch(A){return console.error("Sign in error:",A),t.value.isLoading=!1,{user:null,session:null,error:String(A)}}},H=async(p,c,d)=>{var L,v,h,I,A;try{t.value.isLoading=!0;const E=await R.getSupabase(),{data:k,error:V}=await E.auth.signUp({email:p,password:c,options:{data:d}});if(V)throw V;if(k.session){const w=k.session.user,_={id:w.id,name:((L=w.user_metadata)==null?void 0:L.name)||((v=w.user_metadata)==null?void 0:v.user_name)||((h=w.user_metadata)==null?void 0:h.full_name)||((I=w.email)==null?void 0:I.split("@")[0])||"User",email:w.email,avatar_url:((A=w.user_metadata)==null?void 0:A.avatar_url)||null,user_metadata:w.user_metadata};return t.value={user:_,isAuthenticated:!0,isLoading:!1,error:null},s.value={user:_,access_token:k.session.access_token,refresh_token:k.session.refresh_token},{user:_,session:s.value,error:null}}return{user:null,session:null,error:"No session returned"}}catch(E){return console.error("Sign up error:",E),t.value.isLoading=!1,{user:null,session:null,error:String(E)}}},g=async()=>{await m()};return e.onMounted(async()=>{await R.initializeCrossSubdomainAuth(),await g()}),{authState:t,currentSession:s,isAuthenticated:a,currentUser:i,isLoading:u,loadUserInfo:m,logout:y,signIn:N,signUp:H,checkAuth:g}}const ee={normalCheckInterval:45e3,fastCheckInterval:8e3,fastMonitoringDuration:18e4,maxRetryAttempts:3,retryDelay:2e3,validationCacheDuration:1e4,enableImmediateDetection:!0,enableFastMonitoring:!0,enableNetworkAwareness:!0},je={...ee,normalCheckInterval:1e4,fastCheckInterval:2e3,fastMonitoringDuration:6e4,maxRetryAttempts:2,retryDelay:1e3},Ye={...ee,normalCheckInterval:6e4,fastCheckInterval:1e4,fastMonitoringDuration:3e5,maxRetryAttempts:5,retryDelay:3e3,enableFastMonitoring:!1},Ee={...ee,normalCheckInterval:1e4,fastCheckInterval:2e3,fastMonitoringDuration:3e4,validationCacheDuration:1e3},be={...ee,normalCheckInterval:45e3,fastCheckInterval:3e3,fastMonitoringDuration:9e4,validationCacheDuration:1e4};function Ce(){switch("production"){case"production":return be;case"development":return Ee;default:return ee}}function ot(t){return{...ee,...t}}const qe={default:ee,fast:je,conservative:Ye,development:Ee,production:be};function tt(t){return qe[t]}const st={immediate:"Immediate (0-2 seconds) - When logout is detected via auth events",fast:"Fast (2-5 seconds) - When fast monitoring is active",normal:"Normal (up to 30 seconds) - Regular monitoring interval",conservative:"Conservative (up to 60 seconds) - Less frequent monitoring"},at={manualLogout:{timing:"Immediate (0-2 seconds)",description:"User clicks logout button",method:"Auth state change event + fast monitoring"},sessionExpiry:{timing:"Fast (2-5 seconds)",description:"Session token expires naturally",method:"Fast monitoring detects invalid session"},tokenInvalidation:{timing:"Normal (up to 30 seconds)",description:"Token is invalidated server-side",method:"Regular monitoring detects validation failure"},networkIssues:{timing:"Immediate (0-1 second)",description:"Network connection lost",method:"Network event listener"},crossTabLogout:{timing:"Fast (2-5 seconds)",description:"User logs out in another tab",method:"Storage event listener + fast monitoring"}};function Je(t){const s=e.ref(!0),a=e.ref(null),i=e.ref(!1),u=e.ref(!1),m=e.ref(null),y=e.ref(null),N=e.ref(null),H={...Ce(),...t},g=H.normalCheckInterval,p=H.fastCheckInterval,c=H.fastMonitoringDuration,d=H.maxRetryAttempts,L=H.retryDelay,v=e.computed(()=>!s.value&&a.value!==null),h=e.computed(()=>{var b,T;return((b=a.value)==null?void 0:b.canRetry)&&((T=a.value)==null?void 0:T.type)!=="manual_check_failed"}),I=b=>{var P;if(typeof document>"u")return null;const B=`; ${document.cookie}`.split(`; ${b}=`);return B.length===2&&((P=B.pop())==null?void 0:P.split(";").shift())||null},A=async()=>{var b,T;try{console.log("[SessionMonitor] Validating session..."),f.ensureCrossSubdomainCookies([f.ACCESS_COOKIE,f.REFRESH_COOKIE]);const B=I("sb-access-token"),P=I("sb-refresh-token");if(!B||!P)return console.log("[SessionMonitor] No tokens found in cookies"),!1;const z=await R.getSupabase();let Q=null,J=null;for(let Z=1;Z<=2;Z++)try{const se=await z.auth.getSession();Q=se.data.session,J=se.error;break}catch(se){if(console.warn(`[SessionMonitor] Network error on attempt ${Z}:`,se),Z===2)return console.log("[SessionMonitor] Network issues detected, maintaining current session state"),s.value;await new Promise(me=>setTimeout(me,1e3))}if(J)return console.warn("[SessionMonitor] Error getting session:",J),(b=J.message)!=null&&b.includes("Invalid JWT")||(T=J.message)!=null&&T.includes("JWT expired")?(console.log("[SessionMonitor] JWT may be expired, attempting refresh..."),await E(z)?(console.log("[SessionMonitor] Token refresh successful after JWT error"),m.value=new Date,!0):!1):s.value;if(!Q||!Q.user)return console.log("[SessionMonitor] No valid session found"),!1;const G=new Date,F=new Date(Q.expires_at*1e3),X=5*60*1e3;return G>=new Date(F.getTime()-X)?(console.log("[SessionMonitor] Session is close to expiry or expired, attempting refresh..."),await E(z)?(console.log("[SessionMonitor] Token refresh successful"),m.value=new Date,!0):(console.log("[SessionMonitor] Token refresh failed, session is expired"),!1)):(console.log("[SessionMonitor] Session is valid"),m.value=new Date,!0)}catch(B){return console.error("[SessionMonitor] Error validating session:",B),s.value}},E=async b=>{try{console.log("[SessionMonitor] Attempting token refresh...");const{data:T,error:B}=await b.auth.refreshSession();return B?(console.warn("[SessionMonitor] Token refresh failed:",B),!1):T.session?(console.log("[SessionMonitor] Token refresh successful, updating cookies..."),f.setSessionCookie(f.ACCESS_COOKIE,T.session.access_token,60*60*24*365),f.setSessionCookie(f.REFRESH_COOKIE,T.session.refresh_token,60*60*24*365),f.syncCookiesToLocalStorage(),!0):!1}catch(T){return console.error("[SessionMonitor] Error during token refresh:",T),!1}},k=async()=>{try{console.log("[SessionMonitor] Attempting to restore session...");const b=I("sb-access-token"),T=I("sb-refresh-token");if(!b||!T)return console.log("[SessionMonitor] No tokens available for restoration"),!1;const B=await R.getSupabase(),{data:P,error:z}=await B.auth.setSession({access_token:b,refresh_token:T});return z?(console.warn("[SessionMonitor] Error restoring session:",z),!1):P.session&&P.session.user?(console.log("[SessionMonitor] Session restored successfully"),m.value=new Date,!0):!1}catch(b){return console.error("[SessionMonitor] Error restoring session:",b),!1}},V=(b,T,B=!0)=>{console.warn("[SessionMonitor] Session loss detected:",{type:b,message:T}),s.value=!1,a.value={type:b,message:T,timestamp:new Date,canRetry:B}},w=async()=>{console.log("[SessionMonitor] Retrying session validation...");for(let b=1;b<=d;b++){if(console.log(`[SessionMonitor] Retry attempt ${b}/${d}`),b>1&&await new Promise(P=>setTimeout(P,L)),await k()&&await A())return console.log("[SessionMonitor] Session restored and validated successfully"),s.value=!0,a.value=null,!0;if(await A())return console.log("[SessionMonitor] Session validated successfully on retry"),s.value=!0,a.value=null,!0}return console.log("[SessionMonitor] All retry attempts failed"),!1},_=()=>{console.log("[SessionMonitor] Clearing session loss state"),s.value=!0,a.value=null},K=()=>{if(i.value){console.log("[SessionMonitor] Already monitoring, skipping start");return}console.log("[SessionMonitor] Starting session monitoring..."),i.value=!0,setTimeout(async()=>{console.log("[SessionMonitor] Performing initial session validation..."),await A()?console.log("[SessionMonitor] Initial validation successful"):(console.log("[SessionMonitor] Initial validation failed, but waiting for confirmation..."),setTimeout(async()=>{await A()||V("session_expired","Your session has expired. Please log in again.",!0)},3e3))},2e3),y.value=setInterval(async()=>{console.log("[SessionMonitor] Periodic session check...");const b=await A();!b&&s.value?(console.log("[SessionMonitor] Session validation failed, performing confirmation check..."),setTimeout(async()=>{await A()||V("session_expired","Your session has expired. Please log in again.",!0)},2e3)):b&&!s.value&&(console.log("[SessionMonitor] Session recovered"),_())},g)},O=()=>{if(u.value){console.log("[SessionMonitor] Fast monitoring already active");return}console.log("[SessionMonitor] Starting fast monitoring (5s intervals)..."),u.value=!0,N.value&&clearInterval(N.value),N.value=setInterval(async()=>{console.log("[SessionMonitor] Fast session check...");const b=await A();!b&&s.value?(console.log("[SessionMonitor] Fast monitoring detected potential session loss, confirming..."),setTimeout(async()=>{await A()||(V("session_expired","Your session has expired. Please log in again.",!0),D())},1e3)):b&&!s.value&&(console.log("[SessionMonitor] Session recovered"),_(),D())},p),setTimeout(()=>{u.value&&(console.log(`[SessionMonitor] Auto-stopping fast monitoring after ${c/1e3} seconds`),D())},c)},D=()=>{u.value&&(console.log("[SessionMonitor] Stopping fast monitoring..."),u.value=!1,N.value&&(clearInterval(N.value),N.value=null))},S=()=>{i.value&&(console.log("[SessionMonitor] Stopping session monitoring..."),i.value=!1,y.value&&(clearInterval(y.value),y.value=null),D())},U=async()=>{console.log("[SessionMonitor] Manual session check requested");const b=await A();return!b&&!await k()?(V("manual_check_failed","Session validation failed. Please log in again.",!1),!1):b},$=()=>{console.log("[SessionMonitor] Network error detected, but not triggering immediate session loss"),s.value||V("network_error","Network connection lost. Please check your internet connection and try again.",!0)},q=()=>{if(typeof window>"u")return;const b=[],T=()=>{var G;console.log("[SessionMonitor] Network connection restored"),v.value&&((G=a.value)==null?void 0:G.type)==="network_error"&&setTimeout(()=>w(),1e3)},B=()=>{console.log("[SessionMonitor] Network connection lost"),$()},P=G=>{console.log("[SessionMonitor] Logout detected, starting fast monitoring for immediate detection"),O()},z=async()=>{document.visibilityState==="visible"&&(console.log("[SessionMonitor] Page became visible, validating session..."),f.ensureCrossSubdomainCookies([f.ACCESS_COOKIE,f.REFRESH_COOKIE]),await new Promise(F=>setTimeout(F,500)),await A()?(console.log("[SessionMonitor] Session is still valid after visibility change"),v.value&&_()):(console.log("[SessionMonitor] Session validation failed after visibility change, will retry..."),await A()&&(console.log("[SessionMonitor] Session recovered on retry after visibility change"),v.value&&_())))},Q=async G=>{switch(console.log("[SessionMonitor] Received auth broadcast:",G.type),G.type){case"SIGNED_IN":case"SESSION_RESTORED":case"TOKEN_REFRESHED":G.accessToken&&G.refreshToken&&(console.log("[SessionMonitor] Updating local session from broadcast"),f.setSessionCookie(f.ACCESS_COOKIE,G.accessToken,60*60*24*365),f.setSessionCookie(f.REFRESH_COOKIE,G.refreshToken,60*60*24*365),f.syncCookiesToLocalStorage()),await A()&&(console.log("[SessionMonitor] Session validated after auth broadcast"),s.value=!0,v.value&&_());break;case"SIGNED_OUT":console.log("[SessionMonitor] Sign-out detected from broadcast"),V("session_expired","You have been signed out in another window.",!1);break}};window.addEventListener("online",T),window.addEventListener("offline",B),window.addEventListener("session-logout-detected",P),document.addEventListener("visibilitychange",z),b.push(()=>{window.removeEventListener("online",T),window.removeEventListener("offline",B),window.removeEventListener("session-logout-detected",P),document.removeEventListener("visibilitychange",z)});const J=f.listenForAuthBroadcasts(Q);return b.push(J),()=>{b.forEach(G=>G())}};return e.onMounted(()=>{console.log("[SessionMonitor] Mounted, setting up monitoring"),K(),q()}),e.onUnmounted(()=>{console.log("[SessionMonitor] Unmounted, cleaning up"),S()}),{isSessionValid:s,sessionLossEvent:a,isMonitoring:i,isFastMonitoring:u,lastValidSession:m,hasSessionLoss:v,canRetrySession:h,validateSession:A,restoreSession:k,retrySession:w,clearSessionLoss:_,startMonitoring:K,stopMonitoring:S,startFastMonitoring:O,stopFastMonitoring:D,checkSession:U,handleNetworkError:$}}const Xe=Ho.defineStore("workspace",()=>{const t=e.ref(null),s=e.ref([]),a=e.ref(null),i=g=>{t.value=g,localStorage.setItem("current_workspace",JSON.stringify(g))},u=g=>{s.value=g,localStorage.setItem("available_workspaces",JSON.stringify(g))};return{currentWorkspace:t,workspaces:s,user:a,setCurrentWorkspace:i,setWorkspaces:u,setUser:g=>{a.value=g,localStorage.setItem("user_info",JSON.stringify(g))},loadPersistedData:()=>{const g=localStorage.getItem("current_workspace");if(g)try{t.value=JSON.parse(g)}catch(d){console.error("Error loading persisted workspace:",d)}const p=localStorage.getItem("available_workspaces");if(p)try{s.value=JSON.parse(p)}catch(d){console.error("Error loading persisted workspaces:",d)}const c=localStorage.getItem("user_info");if(c)try{a.value=JSON.parse(c)}catch(d){console.error("Error loading persisted user:",d)}},clearData:()=>{t.value=null,s.value=[],a.value=null,localStorage.removeItem("current_workspace"),localStorage.removeItem("available_workspaces"),localStorage.removeItem("user_info")},loadWorkspaces:async(g=!1)=>{try{const{data:{user:p}}=await R.supabase.auth.getUser();if(!p)return[];let c=R.supabase.from("workspaces").select(`
          id, title, description, parent_workspace_id, created_by, archived, created_at, git_repo, 
          workspace_access!inner ( access_type, shared_with_user_id ),
          workspace_activities!left ( updated_at )
        `).eq("workspace_access.shared_with_user_id",p.id);g||(c=c.eq("archived",!1));const{data:d,error:L}=await c;if(L)throw L;const v=new Map;(d||[]).forEach(k=>{(k.workspace_access||[]).forEach(V=>{V.shared_with_user_id===p.id&&v.set(k.id,V)})});const h=[...new Set((d||[]).filter(k=>k.parent_workspace_id).map(k=>k.parent_workspace_id).filter(k=>!v.has(k)))];let I=[];if(h.length){let k=R.supabase.from("workspaces").select("id, title, description, parent_workspace_id, created_by, archived, created_at").in("id",h);g||(k=k.eq("archived",!1));const{data:V,error:w}=await k;if(w)throw w;I=V||[]}const E=[...d||[],...I].map(k=>{var V,w,_;return{id:k.id,title:k.title,description:k.description||"No description",parent_workspace_id:k.parent_workspace_id,created_by:k.created_by,archived:k.archived,created_at:k.created_at,latest_activity:((w=(V=k.workspace_activities)==null?void 0:V[0])==null?void 0:w.updated_at)||k.created_at,hasAccess:v.has(k.id),accessType:((_=v.get(k.id))==null?void 0:_.access_type)||null}});return E.sort((k,V)=>new Date(V.latest_activity)-new Date(k.latest_activity)),u(E),E}catch(p){return console.error("loadWorkspaces error",p),[]}}}});let ne=null;const ye=t=>!(!t||typeof t!="string"||t.trim().length===0||t.trim().length<20),rt=async()=>{try{const{createClient:t}=await import("@supabase/supabase-js"),s={VITE_SUPABASE_URL:void 0,VITE_SUPABASE_ANON_KEY:void 0,BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}.VITE_SUPABASE_SERVICE_ROLE_KEY||{VITE_SUPABASE_URL:void 0,VITE_SUPABASE_ANON_KEY:void 0,BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}.VITE_SUPABASE_SERVICE_KEY||window.__SUPABASE_SERVICE_KEY__;return s?(console.log("[GitHub Config] Using service role key for settings access"),t("https://sb.aiworkspace.pro",s)):(console.log("[GitHub Config] No service key found, using regular client"),await R.getSupabase())}catch(t){return console.warn("[GitHub Config] Failed to create admin client, using regular client:",t),await R.getSupabase()}},nt=async()=>{var t;try{console.log("[GitHub Config] Attempting to fetch GitHub token from database...");const s=await rt();console.log("[GitHub Config] Testing table access methods...");const{data:a,error:i}=await s.from("settings").select("key_name, key_value");let u=a,m=i;if(i&&i.code==="PGRST301"){console.log("[GitHub Config] Direct access blocked by RLS, trying alternative method...");const{data:p,error:c}=await s.from("settings").select("key_name, key_value").eq("key_name","github_token");u=p,m=c}if(console.log("[GitHub Config] All settings rows:",u),console.log("[GitHub Config] Query error (if any):",m),u){console.log("[GitHub Config] Looking for github_token in rows...");const p=u.filter(c=>c.key_name&&(c.key_name.toLowerCase()==="github_token"||c.key_name==="github_token"||c.key_name.includes("github")));if(console.log("[GitHub Config] GitHub-related rows found:",p),p.length>0){const c=(t=p[0].key_value)==null?void 0:t.trim();if(c&&ye(c))return console.log("ðŸ”§ GitHub token found in general query!"),console.log("Token preview:",c.substring(0,8)+"..."+c.substring(c.length-4)),console.log("Token length:",c.length),console.log("Token starts with:",c.substring(0,4)),c}}const{data:y,error:N,count:H}=await s.from("settings").select("key_value",{count:"exact"}).eq("key_name","github_token");if(console.log("[GitHub Config] Specific query result:",{data:y,error:N,count:H}),N)return console.warn("[GitHub Config] Database error details:",{code:N.code,message:N.message,details:N.details,hint:N.hint}),N.code==="PGRST116"?console.info("[GitHub Config] No GitHub token configured in database (PGRST116)"):console.warn("[GitHub Config] Error fetching token from database:",N.message),null;const g=Array.isArray(y)?y[0]:y;if(g!=null&&g.key_value){const p=g.key_value.trim();return ye(p)?(console.log("ðŸ”§ GitHub token fetched from database successfully"),console.log("Token preview:",p.substring(0,8)+"..."+p.substring(p.length-4)),console.log("Token length:",p.length),console.log("Token starts with:",p.substring(0,4)),p):(console.warn("[GitHub Config] Invalid GitHub token format in database"),null)}return console.warn("[GitHub Config] No GitHub token found in database - data was:",g),null}catch(s){return console.error("[GitHub Config] Failed to fetch token from database:",s),null}},it=t=>{if(!(t!=null&&t.token)||!ye(t.token))throw console.error("[GitHub Config] Invalid GitHub token provided"),new Error("Invalid GitHub token provided");ne=t.token.trim(),console.log("ðŸ”§ GitHub token configured manually")},fe=async()=>{if(ne)return ne;try{const t=await nt();if(t)return ne=t,t}catch(t){console.error("[GitHub Config] Failed to fetch token:",t)}return null},lt=async()=>{if(ne!==null)return!0;try{return await fe()!==null}catch(t){return console.error("[GitHub Config] Error checking configuration:",t),!1}},Qe=()=>{ne=null,console.log("ðŸ”§ GitHub token cache cleared")},ct=async()=>(Qe(),await fe()),ut=async()=>{try{console.log("[GitHub Config Debug] Testing database connection...");const t=await R.getSupabase(),{data:s,error:a}=await t.from("settings").select("*").limit(10);console.log("[GitHub Config Debug] Settings table sample (first 10 rows):",s),console.log("[GitHub Config Debug] Query error:",a),s&&(console.log("[GitHub Config Debug] Column structure of first row:",Object.keys(s[0]||{})),console.log("[GitHub Config Debug] All key_name values:",s.map(g=>g.key_name)));const{data:i,error:u}=await t.from("settings").select("*").eq("key_name","github_token");console.log("[GitHub Config Debug] Exact github_token match:",i),console.log("[GitHub Config Debug] Exact match error:",u);const{data:m,error:y}=await t.from("settings").select("*").ilike("key_name","%github%");console.log("[GitHub Config Debug] Case-insensitive GitHub search:",m),console.log("[GitHub Config Debug] Case-insensitive error:",y);const{data:N,error:H}=await t.rpc("get_table_columns",{table_name:"settings"}).limit(1);console.log("[GitHub Config Debug] Table structure info:",N),console.log("[GitHub Config Debug] Table structure error:",H)}catch(t){console.error("[GitHub Config Debug] Database connection test failed:",t)}};function Ze(){const t=e.ref({user:null,isAuthenticated:!1,isLoading:!0,error:null}),s=e.ref(window.location.href),a=async()=>{var g,p,c,d,L,v,h,I;try{t.value.isLoading=!0;const A=await R.getSupabase(),{data:{session:E},error:k}=await A.auth.getSession();if(k){console.error("Error checking auth status:",k),t.value={user:null,isAuthenticated:!1,isLoading:!1,error:k.message};return}E!=null&&E.user?(t.value={user:{id:E.user.id,email:E.user.email||"",name:((g=E.user.user_metadata)==null?void 0:g.full_name)||((p=E.user.user_metadata)==null?void 0:p.name)||((c=E.user.email)==null?void 0:c.split("@")[0])||"User",avatar_url:((d=E.user.user_metadata)==null?void 0:d.avatar_url)||((L=E.user.user_metadata)==null?void 0:L.picture)||null,initials:(((v=E.user.user_metadata)==null?void 0:v.full_name)||((h=E.user.user_metadata)==null?void 0:h.name)||((I=E.user.email)==null?void 0:I.split("@")[0])||"U").split(" ").map(V=>V[0]).join("").toUpperCase().substring(0,2)},isAuthenticated:!0,isLoading:!1,error:null},E.access_token&&f.setSessionCookie(f.ACCESS_COOKIE,E.access_token),E.refresh_token&&f.setSessionCookie(f.REFRESH_COOKIE,E.refresh_token),f.syncCookiesToLocalStorage()):t.value={user:null,isAuthenticated:!1,isLoading:!1,error:null}}catch(A){console.error("Auth check failed:",A),t.value={user:null,isAuthenticated:!1,isLoading:!1,error:A.message||"Authentication check failed"}}},i=async(g,p)=>{try{const c=await R.getSupabase(),{error:d}=await c.auth.signInWithPassword({email:g,password:p});return d?{success:!1,error:d.message}:(await a(),sessionStorage.setItem("post-login-redirect",s.value),{success:!0})}catch(c){return console.error("Login error:",c),{success:!1,error:c.message||"Login failed"}}},u=async(g,p)=>{var c;try{const d=await R.getSupabase(),{data:L,error:v}=await d.auth.signUp({email:g,password:p});return v?{success:!1,error:v.message}:L.user&&!L.user.email_confirmed_at?{success:!0,needsConfirmation:!0}:(c=L.session)!=null&&c.user?(await a(),sessionStorage.setItem("post-login-redirect",s.value),{success:!0}):{success:!1,error:"No session created"}}catch(d){return console.error("Signup error:",d),{success:!1,error:d.message||"Signup failed"}}},m=async g=>{try{const p=`${window.location.origin}/auth/callback`;console.log("[OAuth] Starting login with provider:",g),console.log("[OAuth] Redirect URL:",p),console.log("[OAuth] Current URL:",s.value),console.log("[OAuth] Current origin:",window.location.origin);const c=await R.getSupabase(),{error:d}=await c.auth.signInWithOAuth({provider:g,options:{redirectTo:p,queryParams:{redirect_origin:s.value}}});if(d)return console.error("[OAuth] Error:",d),{success:!1,error:d.message};const L=s.value||window.location.href;return sessionStorage.setItem("post-login-redirect",L),localStorage.setItem("post-login-redirect",L),console.log("[OAuth] Stored redirect URL:",L),console.log("[OAuth] Current URL value:",s.value),console.log("[OAuth] Window location href:",window.location.href),{success:!0}}catch(p){return console.error("OAuth login error:",p),{success:!1,error:p.message||"OAuth login failed"}}},y=async()=>{try{const g=await R.getSupabase(),{error:p}=await g.auth.signOut();p&&console.error("Logout error:",p),t.value={user:null,isAuthenticated:!1,isLoading:!1,error:null},f.clearSessionCookie(f.ACCESS_COOKIE),f.clearSessionCookie(f.REFRESH_COOKIE),f.clearLocalStorageTokens()}catch(g){console.error("Logout error:",g)}},N=async g=>{try{const p=await R.getSupabase(),{error:c}=await p.auth.resetPasswordForEmail(g,{redirectTo:`${window.location.origin}/auth/reset-password`});return c?{success:!1,error:c.message}:{success:!0}}catch(p){return console.error("Password reset error:",p),{success:!1,error:p.message||"Password reset failed"}}},H=async()=>{try{(await R.getSupabase()).auth.onAuthStateChange((p,c)=>{var d;switch(console.log("Auth state changed:",p,(d=c==null?void 0:c.user)==null?void 0:d.email),p){case"SIGNED_IN":c!=null&&c.user&&a();break;case"SIGNED_OUT":t.value={user:null,isAuthenticated:!1,isLoading:!1,error:null},f.clearSessionCookie(f.ACCESS_COOKIE),f.clearSessionCookie(f.REFRESH_COOKIE),f.clearLocalStorageTokens();break;case"TOKEN_REFRESHED":c!=null&&c.access_token&&f.setSessionCookie(f.ACCESS_COOKIE,c.access_token),c!=null&&c.refresh_token&&f.setSessionCookie(f.REFRESH_COOKIE,c.refresh_token),f.syncCookiesToLocalStorage();break;case"USER_UPDATED":c!=null&&c.user&&a();break}})}catch(g){console.warn("Failed to setup auth listener:",g)}};return e.onMounted(async()=>{H(),await a()}),e.watch(()=>window.location.href,g=>{s.value=g}),{authState:e.computed(()=>t.value),isAuthenticated:e.computed(()=>t.value.isAuthenticated),user:e.computed(()=>t.value.user),isLoading:e.computed(()=>t.value.isLoading),checkAuthStatus:a,loginWithEmail:i,signupWithEmail:u,loginWithProvider:m,logout:y,resetPassword:N,currentUrl:e.computed(()=>s.value)}}const dt={class:"login-container"},pt={class:"logo-section"},ft={class:"login-buttons"},gt={key:0,class:"forgot-password"},ht={class:"signup-link"},mt=e.defineComponent({__name:"LoginModal",props:{modelValue:{type:Boolean}},emits:["update:modelValue","login-success"],setup(t,{emit:s}){const a=t,i=s,u=e.computed({get:()=>a.modelValue,set:w=>i("update:modelValue",w)}),m=e.ref(!1),y=e.ref(!1),N=e.ref(),{loginWithEmail:H,signupWithEmail:g,loginWithProvider:p,resetPassword:c}=Ze(),d=e.reactive({email:"",password:"",confirmPassword:""}),L=e.computed(()=>({email:[{required:!0,message:"Please enter your email",trigger:"blur"},{type:"email",message:"Please enter a valid email",trigger:"blur"}],password:[{required:!0,message:"Please enter your password",trigger:"blur"},{min:6,message:"Password must be at least 6 characters",trigger:"blur"}],...m.value?{confirmPassword:[{required:!0,message:"Please confirm your password",trigger:"blur"},{validator:(w,_,K)=>{_!==d.password?K(new Error("Passwords do not match")):K()},trigger:"blur"}]}:{}})),v=()=>{var w;m.value=!m.value,d.email="",d.password="",d.confirmPassword="",(w=N.value)==null||w.clearValidate()},h=()=>{var w;u.value=!1,d.email="",d.password="",d.confirmPassword="",m.value=!1,(w=N.value)==null||w.clearValidate()},I=async()=>{if(N.value)try{await N.value.validate(),y.value=!0,m.value?await E():await A()}catch(w){console.error("Form validation failed:",w)}finally{y.value=!1}},A=async()=>{const w=await H(d.email,d.password);w.success?(M.ElMessage.success("Login successful"),i("login-success",{email:d.email}),h()):M.ElMessage.error("Login failed: "+w.error)},E=async()=>{const w=await g(d.email,d.password);w.success?w.needsConfirmation?M.ElMessage.success("Please check your email to confirm your account"):(M.ElMessage.success("Account created successfully"),i("login-success",{email:d.email}),h()):M.ElMessage.error("Signup failed: "+w.error)},k=async w=>{const _=await p(w);_.success?M.ElMessage.success("Redirecting to login provider..."):M.ElMessage.error("Login failed: "+_.error)},V=async()=>{if(!d.email){M.ElMessage.warning("Please enter your email address first");return}const w=await c(d.email);w.success?M.ElMessage.success("Password reset email sent! Please check your inbox."):M.ElMessage.error("Failed to send reset email: "+w.error)};return(w,_)=>{const K=e.resolveComponent("el-icon"),O=e.resolveComponent("el-input"),D=e.resolveComponent("el-form-item"),S=e.resolveComponent("el-button"),U=e.resolveComponent("el-dialog");return e.openBlock(),e.createBlock(U,{modelValue:u.value,"onUpdate:modelValue":_[6]||(_[6]=$=>u.value=$),title:"",width:"500px","close-on-click-modal":!1,"close-on-press-escape":!0,"show-close":!0,class:"login-modal",onClose:h},{default:e.withCtx(()=>[e.createElementVNode("div",dt,[e.createElementVNode("div",pt,[e.createElementVNode("h2",null,e.toDisplayString(m.value?"Create Account":"Welcome Back"),1),e.createElementVNode("p",null,e.toDisplayString(m.value?"Sign up to get started with your account":"Sign in to continue to your account"),1)]),e.createVNode(e.unref(M.ElForm),{model:d,rules:L.value,ref_key:"formRef",ref:N,class:"login-form",onSubmit:e.withModifiers(I,["prevent"])},{default:e.withCtx(()=>[e.createVNode(D,{prop:"email"},{default:e.withCtx(()=>[e.createVNode(O,{modelValue:d.email,"onUpdate:modelValue":_[0]||(_[0]=$=>d.email=$),placeholder:"Email",type:"email",size:"large",class:"form-input"},{prefix:e.withCtx(()=>[e.createVNode(K,null,{default:e.withCtx(()=>[e.createVNode(e.unref(Go))]),_:1})]),_:1},8,["modelValue"])]),_:1}),e.createVNode(D,{prop:"password"},{default:e.withCtx(()=>[e.createVNode(O,{modelValue:d.password,"onUpdate:modelValue":_[1]||(_[1]=$=>d.password=$),placeholder:"Password",type:"password",size:"large","show-password":"",class:"form-input"},{prefix:e.withCtx(()=>[e.createVNode(K,null,{default:e.withCtx(()=>[e.createVNode(e.unref(We))]),_:1})]),_:1},8,["modelValue"])]),_:1}),m.value?(e.openBlock(),e.createBlock(D,{key:0,prop:"confirmPassword"},{default:e.withCtx(()=>[e.createVNode(O,{modelValue:d.confirmPassword,"onUpdate:modelValue":_[2]||(_[2]=$=>d.confirmPassword=$),placeholder:"Confirm Password",type:"password",size:"large","show-password":"",class:"form-input"},{prefix:e.withCtx(()=>[e.createVNode(K,null,{default:e.withCtx(()=>[e.createVNode(e.unref(We))]),_:1})]),_:1},8,["modelValue"])]),_:1})):e.createCommentVNode("",!0),e.createVNode(D,null,{default:e.withCtx(()=>[e.createVNode(S,{type:"primary",class:"submit-button",loading:y.value,onClick:I,size:"large"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(m.value?"Sign Up":"Sign In"),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model","rules"]),_[10]||(_[10]=e.createElementVNode("div",{class:"divider"},[e.createElementVNode("span",null,"Or continue with")],-1)),e.createElementVNode("div",ft,[e.createVNode(S,{class:"login-button google",onClick:_[3]||(_[3]=$=>k("google")),size:"large"},{default:e.withCtx(()=>[..._[7]||(_[7]=[e.createElementVNode("span",{class:"social-icon"},"G",-1),e.createTextVNode(" Google ",-1)])]),_:1}),e.createVNode(S,{class:"login-button github",onClick:_[4]||(_[4]=$=>k("github")),size:"large"},{default:e.withCtx(()=>[..._[8]||(_[8]=[e.createElementVNode("span",{class:"social-icon"},"âš¡",-1),e.createTextVNode(" GitHub ",-1)])]),_:1}),e.createVNode(S,{class:"login-button twitter",onClick:_[5]||(_[5]=$=>k("twitter")),size:"large"},{default:e.withCtx(()=>[..._[9]||(_[9]=[e.createElementVNode("span",{class:"social-icon"},"X",-1),e.createTextVNode(" X (Twitter) ",-1)])]),_:1})]),_[11]||(_[11]=e.createElementVNode("div",{class:"terms"}," By continuing, you agree to AI Workspace's Terms of Service and Privacy Policy ",-1)),m.value?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("div",gt,[e.createElementVNode("a",{href:"#",onClick:e.withModifiers(V,["prevent"])},"Forgot Password?")])),e.createElementVNode("div",ht,[e.createTextVNode(e.toDisplayString(m.value?"Already have an account?":"Don't have an account?")+" ",1),e.createElementVNode("a",{href:"#",onClick:e.withModifiers(v,["prevent"])},e.toDisplayString(m.value?"Sign in":"Sign up"),1)])])]),_:1},8,["modelValue"])}}});const ge=(t,s)=>{const a=t.__vccOpts||t;for(const[i,u]of s)a[i]=u;return a},eo=ge(mt,[["__scopeId","data-v-684a3f28"]]),kt={class:"session-loss-content"},wt={class:"session-loss-icon"},vt={class:"session-loss-message"},_t={key:0,class:"session-loss-details"},St={class:"detail-item"},yt={class:"detail-value"},Et={class:"detail-item"},bt={class:"detail-value"},Ct={class:"session-loss-actions"},Vt={key:0,class:"retry-status"},Nt={class:"retry-message"},At=e.defineComponent({__name:"SessionLossModal",props:{modelValue:{type:Boolean},sessionLossEvent:{},canRetrySession:{type:Boolean}},emits:["update:modelValue","retry","login","refresh"],setup(t,{emit:s}){const a=t,i=s,u=e.ref(!1),m=e.ref(0),y=e.ref(void 0),N=e.ref(""),H=e.computed({get:()=>a.modelValue,set:v=>i("update:modelValue",v)}),g=v=>{switch(v){case"session_expired":return"Authentication session has expired";case"token_invalid":return"Authentication token is invalid or corrupted";case"network_error":return"Network connection issue detected";case"manual_check_failed":return"Session validation failed";default:return"Unknown authentication issue"}},p=v=>v.toLocaleString(),c=async()=>{if(u.value)return;u.value=!0,m.value=0,y.value=void 0,N.value="Attempting to restore session...";const v=setInterval(()=>{m.value<90&&(m.value+=Math.random()*20)},200);try{i("retry"),await new Promise(h=>setTimeout(h,2e3)),m.value=100,y.value="success",N.value="Session restored successfully!",setTimeout(()=>{H.value=!1},1e3)}catch{m.value=100,y.value="exception",N.value="Failed to restore session. Please log in again.",M.ElMessage.error("Session restoration failed")}finally{clearInterval(v),setTimeout(()=>{u.value=!1,m.value=0,y.value=void 0,N.value=""},3e3)}},d=()=>{i("login"),H.value=!1},L=()=>{i("refresh"),window.location.reload()};return e.watch(()=>a.sessionLossEvent,v=>{v&&(u.value=!1,m.value=0,y.value=void 0,N.value="")}),(v,h)=>(e.openBlock(),e.createBlock(e.unref(M.ElDialog),{modelValue:H.value,"onUpdate:modelValue":h[0]||(h[0]=I=>H.value=I),title:"Session Expired",width:"500px","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1,class:"session-loss-modal",center:""},{default:e.withCtx(()=>{var I;return[e.createElementVNode("div",kt,[e.createElementVNode("div",wt,[e.createVNode(e.unref(M.ElIcon),{size:"48",color:"#f56c6c"},{default:e.withCtx(()=>[e.createVNode(e.unref(Ge))]),_:1})]),e.createElementVNode("div",vt,[h[3]||(h[3]=e.createElementVNode("h3",null,"Your session has expired",-1)),e.createElementVNode("p",null,e.toDisplayString(((I=t.sessionLossEvent)==null?void 0:I.message)||"Please log in again to continue using the application."),1),t.sessionLossEvent?(e.openBlock(),e.createElementBlock("div",_t,[e.createElementVNode("div",St,[h[1]||(h[1]=e.createElementVNode("span",{class:"detail-label"},"Issue:",-1)),e.createElementVNode("span",yt,e.toDisplayString(g(t.sessionLossEvent.type)),1)]),e.createElementVNode("div",Et,[h[2]||(h[2]=e.createElementVNode("span",{class:"detail-label"},"Time:",-1)),e.createElementVNode("span",bt,e.toDisplayString(p(t.sessionLossEvent.timestamp)),1)])])):e.createCommentVNode("",!0)]),e.createElementVNode("div",Ct,[t.canRetrySession&&!u.value?(e.openBlock(),e.createBlock(e.unref(M.ElButton),{key:0,type:"primary",onClick:c,loading:u.value},{default:e.withCtx(()=>[e.createVNode(e.unref(M.ElIcon),null,{default:e.withCtx(()=>[e.createVNode(e.unref(_e))]),_:1}),h[4]||(h[4]=e.createTextVNode(" Try Again ",-1))]),_:1},8,["loading"])):e.createCommentVNode("",!0),e.createVNode(e.unref(M.ElButton),{type:"primary",onClick:d,disabled:u.value},{default:e.withCtx(()=>[e.createVNode(e.unref(M.ElIcon),null,{default:e.withCtx(()=>[e.createVNode(e.unref(Se))]),_:1}),h[5]||(h[5]=e.createTextVNode(" Log In ",-1))]),_:1},8,["disabled"]),t.canRetrySession?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(e.unref(M.ElButton),{key:1,type:"info",onClick:L,disabled:u.value},{default:e.withCtx(()=>[e.createVNode(e.unref(M.ElIcon),null,{default:e.withCtx(()=>[e.createVNode(e.unref(_e))]),_:1}),h[6]||(h[6]=e.createTextVNode(" Refresh Page ",-1))]),_:1},8,["disabled"]))]),u.value?(e.openBlock(),e.createElementBlock("div",Vt,[e.createVNode(e.unref(M.ElProgress),{percentage:m.value,status:y.value,"stroke-width":6},null,8,["percentage","status"]),e.createElementVNode("p",Nt,e.toDisplayString(N.value),1)])):e.createCommentVNode("",!0)])]}),_:1},8,["modelValue"]))}});const oo=ge(At,[["__scopeId","data-v-0dd27f7f"]]),It={class:"aiworkspace-header"},xt={key:0,class:"header-content header-loading"},Rt={class:"header-center"},Lt={class:"loading-text"},Tt={key:0},Mt={key:1},Bt={key:1,class:"header-content header-fallback"},Ht={key:2,class:"header-content header-restricted"},Dt={class:"header-center"},Ut={class:"restricted-text"},$t={class:"header-right"},Ot={key:3,class:"header-content"},Pt={class:"header-left"},Wt={class:"logo-section"},Gt={href:"/",class:"logo"},Ft=["src"],Kt={key:1,class:"text-logo"},zt={key:0,class:"header-center"},jt={class:"main-navigation"},Yt={class:"nav-item"},qt={href:"https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard",class:"nav-link"},Jt={class:"workspace-dropdown-item"},Xt=["href"],Qt={class:"workspace-icon"},Zt={key:1,class:"nav-divider"},es={class:"nav-item"},os=["href","onClick"],ts={key:0,class:"header-placeholder"},ss={key:1,class:"header-placeholder"},as={class:"header-right"},rs={class:"user-profile"},ns={class:"user-info"},is={class:"user-name"},ls={class:"user-avatar"},cs=["src","alt"],us={key:1,class:"avatar-placeholder"},ds={class:"version-info"},ps={class:"version-hash"},fs={key:4,class:"header-content header-unauthenticated"},gs={class:"header-left"},hs={class:"logo-section"},ms={href:"/",class:"logo"},ks=["src"],ws={key:1,class:"text-logo"},vs={key:0,class:"header-right"},_s={class:"workspace-list"},Ss=["onClick"],ys={class:"workspace-icon"},Es={class:"workspace-details"},bs={class:"workspace-members"},Cs={key:0,class:"current-indicator"},Vs={class:"update-content"},Ns={class:"update-actions"},ce=50,As=6e4,Is=30,xs=e.defineComponent({__name:"AIWorkspaceHeader",props:{customLogo:{default:""},customLinks:{default:()=>[]},showUserMenu:{type:Boolean,default:!0},showWorkspaceSelector:{type:Boolean,default:!0},showSecondaryNavigation:{type:Boolean,default:!0},currentWorkspaceId:{},onProfileClick:{},onSettingsClick:{},onWorkspaceChange:{},onLogout:{},onLogin:{}},emits:["workspaceChange","logout","login","profileClick","settingsClick"],setup(t,{emit:s}){const a=t,i=s,{authState:u,logout:m,isLoading:y}=ze(),{isSessionValid:N,sessionLossEvent:H,hasSessionLoss:g,canRetrySession:p,retrySession:c,clearSessionLoss:d}=Je(),L=()=>{try{return Xe()}catch{return console.warn("[AIWorkspaceHeader] Pinia not initialized yet, using fallback state"),null}},v=()=>{try{return typeof window<"u"?!!window.__PINIA__||!!window.Pinia:!1}catch{return!1}},h=e.ref(L()),I=e.computed(()=>!!h.value),A=e.ref(0),E=()=>{if(!h.value&&A.value<ce){if(v()){const r=L();if(r){h.value=r,console.log("[AIWorkspaceHeader] Pinia store initialized successfully");return}}A.value++,setTimeout(E,100)}else A.value>=ce&&console.warn("[AIWorkspaceHeader] Pinia initialization failed after maximum retries, using fallback mode")};e.onMounted(()=>{h.value||E()});const k=e.ref(!1),V=e.ref(!1),w=e.ref(!1),_=e.ref([]),K=e.ref([]),O=e.ref({name:"",email:"",avatar_url:null,initials:""}),D=e.ref("unknown"),S=e.ref("unknown"),U=e.ref(!1),$=e.ref(null),q=e.ref(null),b=e.ref(!1),T=e.ref([]),B=e.ref([]),P=e.ref(!1);e.watch(B,async r=>{r.length>0&&I.value&&F.value&&await G()},{immediate:!1}),e.watch(()=>window.location.pathname+window.location.search+window.location.hash,async()=>{I.value&&F.value&&await G()},{immediate:!1});const z=e.ref(window.location.pathname);e.watch(()=>window.location.pathname,r=>{z.value=r},{immediate:!0}),e.watch(I,r=>{!r&&A.value<ce&&E()});const Q=()=>{try{const r=window.location.pathname.match(/\/single-workspace\/(\d+)/);if(r)return r[1];const n=new URLSearchParams(window.location.search).get("workspace_id");if(n)return n;const l=window.location.hash.match(/workspace_id=(\d+)/);return l?l[1]:null}catch(r){return console.warn("[AIWorkspaceHeader] Error parsing URL for workspace_id:",r),null}},J=()=>{try{return window.location.pathname.includes("/all-workspace/")}catch(r){return console.warn("[AIWorkspaceHeader] Error checking all-workspace mode:",r),!1}},G=async()=>{if(!h.value||!I.value)return;const r=J();if(P.value=r,r){h.value.currentWorkspace=null,localStorage.removeItem("current_workspace"),console.log("[AIWorkspaceHeader] Auto-selected all-workspace mode from URL");return}const o=Q();if(o)try{B.value.length===0&&await Ie();const n=B.value.find(l=>l.id.toString()===o);n?(h.value.setCurrentWorkspace(n),console.log(`[AIWorkspaceHeader] Auto-selected workspace from URL: ${n.title} (ID: ${n.id})`),i("workspaceChange",n)):console.warn(`[AIWorkspaceHeader] Workspace with ID ${o} not found in available workspaces`)}catch(n){console.error("[AIWorkspaceHeader] Error auto-selecting workspace from URL:",n)}},F=e.computed(()=>u.value.isAuthenticated),X=e.computed(()=>h.value?h.value.currentWorkspace:null),Z=e.computed(()=>{try{return window.location.pathname.includes("shared-folder")}catch(r){return console.warn("[AIWorkspaceHeader] Error checking shared-folder URL:",r),!1}}),se=e.ref([{label:"Dashboard",key:"dashboard",url:"/dashboard"},{label:"Goals",key:"goals",url:"/goals"},{label:"Tasks",key:"tasks",url:"/tasks"},{label:"Events",key:"events",url:"/events"},{label:"Drive",key:"files",url:"/files"},{label:"Outlines",key:"outlines",url:"/outlines"},{label:"Communications",key:"communications",url:"/communications"},{label:"Canvas",key:"canvas",url:"/canvas"},{label:"AI Phone",key:"phone",url:"/phone"},{label:"AI Intake",key:"ai_intake",url:"/ai_intake"},{label:"AI Fax",key:"ai_fax",url:"/ai_fax"},{label:"Portfolio Analysis",key:"ai-portfolios",url:"/ai-portfolios"},{label:"AI Fund Analyst",key:"ai_fund_analyst",url:"/ai_fund_analyst"},{label:"Contacts",key:"contacts",url:"/contacts"},{label:"Settings",key:"settings",url:"/settings"}]),me=e.ref([{label:"Dashboard",key:"dashboard",url:"/dashboard"},{label:"All Tasks",key:"tasks",url:"/tasks"},{label:"All Goals",key:"goals",url:"/goals"},{label:"All Events",key:"events",url:"/events"},{label:"All Drive",key:"files",url:"/files"},{label:"All Contacts",key:"contacts",url:"/contacts"},{label:"All Settings",key:"settings",url:"/settings"}]),Ve=e.computed(()=>P.value?me.value:se.value),no=e.computed(()=>{try{const r=z.value;let o="";const n=r.match(/\/all-workspace\/([^\/]+)/);if(n)o=n[1];else{const l=r.match(/\/single-workspace\/\d+\/([^\/]+)/);if(l)o=l[1];else{const x=r.match(/\/([^\/]+)$/);x&&(o=x[1])}}if(o){const l=Ve.value.find(x=>x.key===o||x.url.includes(`/${o}`)||x.url===`/${o}`);if(l)return l.label}return"Dashboard"}catch(r){return console.warn("[AIWorkspaceHeader] Error determining current section:",r),"Dashboard"}}),de=e.computed(()=>{try{return window.location.hostname==="worklog.aiworkspace.pro"}catch(r){return console.warn("[AIWorkspaceHeader] Error checking worklog domain:",r),!1}}),Ne=e.computed(()=>{try{return window.location.hostname==="drms.aiworkspace.pro"||window.location.hostname==="localhost"&&window.location.pathname.startsWith("/dashboard")}catch(r){return console.warn("[AIWorkspaceHeader] Error checking DRMS domain:",r),!1}}),ie=e.computed(()=>a.showWorkspaceSelector&&!de.value&&!Ne.value),io=r=>{const o=new Map;r.forEach(x=>{o.set(x.id,{...x,children:[]})});const n=[];o.forEach(x=>{x.parent_workspace_id&&o.has(x.parent_workspace_id)?o.get(x.parent_workspace_id).children.push(x):n.push(x)});const l=x=>{x.sort((W,Y)=>W.title.localeCompare(Y.title)),x.forEach(W=>{W.children&&l(W.children)})};return l(n),n},Ae=(r,o=0,n=[])=>(r.forEach(l=>{n.push({...l,level:o}),l.children&&l.children.length&&Ae(l.children,o+1,n)}),n),Ie=async()=>{var r,o,n;try{const l=await((r=h.value)==null?void 0:r.loadWorkspaces());if(T.value=io(l||[]),B.value=Ae(T.value),K.value=B.value,_.value=B.value,a.currentWorkspaceId){const x=B.value.find(W=>{var Y;return W.id.toString()===((Y=a.currentWorkspaceId)==null?void 0:Y.toString())});x&&((o=h.value)==null||o.setCurrentWorkspace(x))}else!X.value&&B.value.length&&((n=h.value)==null||n.setCurrentWorkspace(B.value[0]))}catch(l){console.error("loadWorkspaces (header) error",l)}},lo=r=>{if(console.log("Navigation command:",r),r==="all-workspace"){window.location.href="https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard";return}else{const o=parseInt(r.replace("workspace-",""));window.location.href=`https://single-ws-dashboard.aiworkspace.pro/single-workspace/${o}/dashboard`;return}},co=r=>{const o=X.value,n=P.value;switch(r.key){case"dashboard":n?window.location.href="https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard":o?window.location.href=`https://single-ws-dashboard.aiworkspace.pro/single-workspace/${o.id}/dashboard`:window.location.href="https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard";break;case"outlines":if(n)window.location.href="https://outline.aiworkspace.pro/all-workspace/outlines";else if(o){const l=`https://outline.aiworkspace.pro/single-workspace/${o.id}/outlines`;window.location.href=l}else window.location.href="https://outline.aiworkspace.pro";break;case"canvas":if(n)window.location.href="https://canvas.aiworkspace.pro/all-workspace/canvas";else if(o){const l=`https://canvas.aiworkspace.pro/single-workspace/${o.id}/canvas`;window.location.href=l}else window.location.href="https://canvas.aiworkspace.pro";break;case"files":if(n)window.location.href="https://drive.aiworkspace.pro/all-workspace/files";else if(o){const l=`https://drive.aiworkspace.pro/single-workspace/${o.id}/files`;window.location.href=l}else window.location.href="https://drive.aiworkspace.pro";break;case"tasks":if(n)window.location.href="https://tasks.aiworkspace.pro/all-workspace/tasks";else if(o){const l=`https://tasks.aiworkspace.pro/single-workspace/${o.id}/tasks`;window.location.href=l}else window.location.href="https://tasks.aiworkspace.pro";break;case"phone":if(n)window.location.href="https://phone.aiworkspace.pro/all-workspace/phone";else if(o){const l=`https://phone.aiworkspace.pro/single-workspace/${o.id}/phone`;window.location.href=l}else window.location.href="https://phone.aiworkspace.pro";break;case"ai_fax":if(n)window.location.href="https://fax.aiworkspace.pro/all-workspace/ai_fax";else if(o){const l=`https://fax.aiworkspace.pro/single-workspace/${o.id}/ai_fax`;window.location.href=l}else window.location.href="https://fax.aiworkspace.pro";break;case"goals":if(n)window.location.href="https://app.aiworkspace.pro/all-workspace/goals";else if(o){const l=`https://app.aiworkspace.pro/single-workspace/${o.id}/goals`;window.location.href=l}else window.location.href="https://app.aiworkspace.pro/all-workspace/goals";break;case"events":if(n)window.location.href="https://app.aiworkspace.pro/all-workspace/events";else if(o){const l=`https://app.aiworkspace.pro/single-workspace/${o.id}/events`;window.location.href=l}else window.location.href="https://app.aiworkspace.pro/all-workspace/events";break;case"contacts":if(n)window.location.href="https://app.aiworkspace.pro/all-workspace/contacts";else if(o){const l=`https://app.aiworkspace.pro/single-workspace/${o.id}/contacts`;window.location.href=l}else window.location.href="https://app.aiworkspace.pro/all-workspace/contacts";break;case"ai-portfolios":if(n)window.location.href="https://spreadsheet.aiworkspace.pro/all-workspace/ai-portfolios";else if(o){const l=`https://spreadsheet.aiworkspace.pro/single-workspace/${o.id}/ai-portfolios`;window.location.href=l}else window.location.href="https://spreadsheet.aiworkspace.pro";break;case"settings":if(n)window.location.href="https://settings.aiworkspace.pro/all-workspace/settings";else if(o){const l=`https://settings.aiworkspace.pro/single-workspace/${o.id}/settings`;window.location.href=l}else window.location.href="https://settings.aiworkspace.pro";break;default:if(n){const l=`https://app.aiworkspace.pro/all-workspace/${r.key}`;window.location.href=l}else if(o){const l=`https://app.aiworkspace.pro/single-workspace/${o.id}/${r.key}`;window.location.href=l}else{const l=`https://app.aiworkspace.pro/${r.key}`;window.location.href=l}break}},uo=r=>{const o=X.value,n=P.value;switch(r.key){case"dashboard":return n?"https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard":o?`https://single-ws-dashboard.aiworkspace.pro/single-workspace/${o.id}/dashboard`:"https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard";case"ai-portfolios":return n?"https://spreadsheet.aiworkspace.pro/all-workspace/ai-portfolios":o?`https://spreadsheet.aiworkspace.pro/single-workspace/${o.id}/ai-portfolios`:"https://spreadsheet.aiworkspace.pro";case"outlines":return n?"https://outline.aiworkspace.pro/all-workspace/outlines":o?`https://outline.aiworkspace.pro/single-workspace/${o.id}/outlines`:"https://outline.aiworkspace.pro";case"canvas":return n?"https://canvas.aiworkspace.pro/all-workspace/canvas":o?`https://canvas.aiworkspace.pro/single-workspace/${o.id}/canvas`:"https://canvas.aiworkspace.pro";case"files":return n?"https://drive.aiworkspace.pro/all-workspace/files":o?`https://drive.aiworkspace.pro/single-workspace/${o.id}/files`:"https://drive.aiworkspace.pro";case"tasks":return n?"https://tasks.aiworkspace.pro/all-workspace/tasks":o?`https://tasks.aiworkspace.pro/single-workspace/${o.id}/tasks`:"https://tasks.aiworkspace.pro";case"phone":return n?"https://phone.aiworkspace.pro/all-workspace/phone":o?`https://phone.aiworkspace.pro/single-workspace/${o.id}/phone`:"https://phone.aiworkspace.pro";case"ai_fax":return n?"https://fax.aiworkspace.pro/all-workspace/ai_fax":o?`https://fax.aiworkspace.pro/single-workspace/${o.id}/ai_fax`:"https://fax.aiworkspace.pro";case"goals":return n?"https://app.aiworkspace.pro/all-workspace/goals":o?`https://app.aiworkspace.pro/single-workspace/${o.id}/goals`:"https://app.aiworkspace.pro/all-workspace/goals";case"events":return n?"https://app.aiworkspace.pro/all-workspace/events":o?`https://app.aiworkspace.pro/single-workspace/${o.id}/events`:"https://app.aiworkspace.pro/all-workspace/events";case"contacts":return n?"https://app.aiworkspace.pro/all-workspace/contacts":o?`https://app.aiworkspace.pro/single-workspace/${o.id}/contacts`:"https://app.aiworkspace.pro/all-workspace/contacts";case"settings":return n?"https://settings.aiworkspace.pro/all-workspace/settings":o?`https://settings.aiworkspace.pro/single-workspace/${o.id}/settings`:"https://settings.aiworkspace.pro";default:return n?`https://app.aiworkspace.pro/all-workspace/${r.key}`:o?`https://app.aiworkspace.pro/single-workspace/${o.id}/${r.key}`:`https://app.aiworkspace.pro/${r.key}`}},oe=r=>{switch(r){case"profile":a.onProfileClick?a.onProfileClick():M.ElMessage.info("Profile settings coming soon");break;case"workspaces":k.value=!0;break;case"allworkspaces":window.location.href="https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard";break;case"worklogs":window.location.href="https://worklog.aiworkspace.pro/worklogs";break;case"drms":window.location.href="https://drms.aiworkspace.pro/dashboard";break;case"logout":fo();break}},xe=r=>{var o;(o=h.value)==null||o.setCurrentWorkspace(r),k.value=!1,i("workspaceChange",r),M.ElMessage.success(`Switched to ${r.title}`)},po=()=>{M.ElMessageBox.prompt("Enter workspace name:","Create New Workspace",{confirmButtonText:"Create",cancelButtonText:"Cancel",inputPattern:/\S/,inputErrorMessage:"Workspace name cannot be empty"}).then(({value:r})=>{var n;const o={id:Date.now(),title:r,description:"New workspace",archived:!1,created_by:"",created_at:new Date().toISOString(),latest_activity:new Date().toISOString(),hasAccess:!0,accessType:"edit"};_.value.push(o),(n=h.value)==null||n.setWorkspaces(_.value),xe(o),M.ElMessage.success(`Created workspace: ${r}`)}).catch(()=>{})},fo=()=>{M.ElMessageBox.confirm("Are you sure you want to sign out?","Sign Out",{confirmButtonText:"Sign Out",cancelButtonText:"Cancel",type:"warning"}).then(async()=>{var r;(r=h.value)==null||r.clearData(),await m(),typeof window<"u"&&window.dispatchEvent(new CustomEvent("session-logout-detected",{detail:{timestamp:new Date,source:"manual-logout"}})),i("logout"),M.ElMessage.success("Signed out successfully")}).catch(()=>{})},ke=async()=>{var r,o;if(u.value.user){const n=u.value.user;O.value={name:n.name||((r=n.email)==null?void 0:r.split("@")[0])||"User",email:n.email||"",avatar_url:n.avatar_url||null,initials:(n.name||((o=n.email)==null?void 0:o.split("@")[0])||"U").split(" ").map(l=>l[0]).join("").toUpperCase().substring(0,2)},a.showWorkspaceSelector&&await Ie()}};e.watch(()=>u.value.user,r=>{var o;r?ke():(O.value={name:"",email:"",avatar_url:null,initials:""},(o=h.value)==null||o.clearData())}),e.watch(g,r=>{r&&F.value&&(console.log("[AIWorkspaceHeader] Session loss detected, showing modal"),w.value=!0)}),e.watch(()=>a.currentWorkspaceId,r=>{var o;if(r&&B.value.length){const n=B.value.find(l=>l.id.toString()===r.toString());n&&((o=h.value)==null||o.setCurrentWorkspace(n))}}),e.onMounted(async()=>{F.value&&(await ke(),await G()),await vo(),Ue(),Co()});const go=async r=>{console.log("Login successful:",r),V.value=!1,await ke(),i("login"),M.ElMessage.success("Welcome back!")},ho=async()=>{console.log("[AIWorkspaceHeader] Retrying session..."),await c()?(w.value=!1,d(),M.ElMessage.success("Session restored successfully!")):M.ElMessage.error("Failed to restore session. Please log in again.")},mo=()=>{console.log("[AIWorkspaceHeader] Opening login modal from session loss"),w.value=!1,V.value=!0},ko=()=>{console.log("[AIWorkspaceHeader] Refreshing page due to session loss"),window.location.reload()},wo=()=>{A.value=0,E(),M.ElMessage.success("Manual Pinia retry initiated.")},vo=async()=>{try{const r=await fetch("/version.json");if(r.ok){const o=r.headers.get("content-type");if(o&&o.includes("application/json"))try{const n=await r.json();console.log("Version data received:",n),D.value=n.shortCommitHash||"unknown",S.value=n.fullCommitHash||"unknown",console.log("âœ… Loaded commit hash from version.json:",D.value);return}catch{console.log("Failed to parse version.json, trying fallback methods...")}}console.log("ðŸ”„ version.json not available, trying automatic detection..."),await Le()}catch(r){console.log("Error loading version.json, trying automatic detection...",r),await Le()}},Re=async()=>{try{let r=await Me();if(r||(r=Te()),r){const o=await De(r);o&&o!==S.value&&(console.log("ðŸ”„ New commit detected:",S.value,"â†’",o),S.value!=="unknown"&&!U.value&&(U.value=!0,$.value=o))}}catch(r){console.log("Error checking for new commits:",r)}},Le=async()=>{try{let r=await Me();if(r||(r=Te()),r){const x=await De(r);if(x){D.value=x.substring(0,7),S.value=x,console.log("âœ… Loaded commit hash from GitHub API:",D.value);return}}const o=await yo();if(o&&o.version){D.value=o.version,S.value=o.version,console.log("âœ… Loaded version from package.json:",D.value);return}const n=await Eo();if(n){D.value=n,S.value=n,console.log("âœ… Loaded version from build info:",D.value);return}const l=Date.now().toString(36);D.value=l.substring(0,7),S.value=l,console.log("âœ… Using timestamp-based version:",D.value)}catch(r){console.warn("âŒ All automatic detection methods failed:",r),D.value="unknown",S.value="unknown"}},Te=()=>{try{const r=window.location.hostname;if(r.includes("github.io")){const o=r.split(".");if(o.length>=3){const n=o[0],l=window.location.pathname.split("/")[1]||"unknown";return console.log("âœ… Detected GitHub Pages repo:",n,l),{owner:n,repo:l}}}return console.log("Could not detect repository from domain:",r),null}catch(r){return console.log("Error detecting repo from domain:",r),null}},Me=async()=>{try{const r=await fetch("/package.json");if(!r.ok)return console.log("package.json not found or not accessible"),null;const o=r.headers.get("content-type");if(!o||!o.includes("application/json"))return console.log("package.json returned non-JSON content (likely HTML), skipping GitHub API"),null;const n=await r.json();if(n.repository&&n.repository.url){const x=n.repository.url.match(/github\.com\/([^\/]+)\/([^\/]+)/);if(x)return console.log("âœ… Found GitHub repo info:",x[1],x[2].replace(".git","")),{owner:x[1],repo:x[2].replace(".git","")}}return console.log("No valid GitHub repository found in package.json"),null}catch(r){return console.log("Could not get repo info from package.json:",r),null}},Be=e.ref(0),we=e.ref(0),He=e.ref(Date.now()),_o=()=>{const r=Date.now();r-He.value>60*60*1e3&&(we.value=0,He.value=r,console.log("ðŸ”„ GitHub API call counter reset"))},So=async()=>{try{const o=await fe();if(o)return console.log("âœ… Using GitHub token from database"),o}catch(o){console.warn("Failed to get token from database:",o)}if({VITE_SUPABASE_URL:void 0,VITE_SUPABASE_ANON_KEY:void 0,BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}.VITE_GITHUB_TOKEN)return console.log("âœ… Using GitHub token from environment"),{}.VITE_GITHUB_TOKEN;const r=localStorage.getItem("github_token");return r?(console.log("âœ… Using GitHub token from localStorage"),r):(console.warn("âŒ No GitHub token found in any source"),null)},De=async r=>{var o;try{const n=Date.now();if(_o(),n-Be.value<As)return console.log("â³ GitHub API rate limit: waiting before next call"),null;if(we.value>=Is)return console.log("ðŸš« GitHub API hourly limit reached, skipping call"),null;const l=await So(),x={Accept:"application/vnd.github.v3+json","User-Agent":"AIWorkspace-Header/1.0"};l?(x.Authorization=`Bearer ${l}`,console.log("ðŸ”‘ Using GitHub token for authentication"),console.log("Token preview:",l.substring(0,8)+"..."+l.substring(l.length-4)),console.log("Token length:",l.length),console.log("Authorization header:",`Bearer ${l.substring(0,8)}...`)):console.log("âš ï¸ No GitHub token found, trying unauthenticated request");const W=["main","master"];for(const Y of W)try{const j=await fetch(`https://api.github.com/repos/${r.owner}/${r.repo}/commits/${Y}`,{headers:x});if(Be.value=n,we.value++,j.ok){const le=await j.json();return console.log("âœ… GitHub API call successful:",le.sha.substring(0,7)),le.sha}else if(j.status===403){if((o=(await j.json()).message)!=null&&o.includes("rate limit"))return console.log("ðŸš« GitHub API rate limit exceeded, will retry later"),null}else{if(j.status===404)return console.log("ðŸš« Repository not found or private (404). Consider adding a GitHub token."),null;if(j.status===401)return console.log("ðŸš« Unauthorized (401). GitHub token may be invalid or expired."),null}}catch(j){console.log(`Failed to get commit from ${Y} branch:`,j)}}catch(n){console.log("Could not get commit from GitHub API:",n)}return null},yo=async()=>{try{const r=await fetch("/package.json");if(!r.ok)return console.log("package.json not found or not accessible"),null;const o=r.headers.get("content-type");return!o||!o.includes("application/json")?(console.log("package.json returned non-JSON content (likely HTML), skipping"),null):await r.json()}catch(r){console.log("Could not get package.json:",r)}return null},Eo=async()=>{try{const r=["/build-manifest.json","/build-info.json","/.next/build-manifest.json"];for(const o of r)try{const n=await fetch(o);if(n.ok){const l=await n.json();if(l.version||l.commitHash||l.buildId)return l.version||l.commitHash||l.buildId}}catch{}}catch(r){console.log("Could not get build info:",r)}return null},bo=async()=>{try{if(S.value==="unknown"){M.ElMessage.warning("Version information not available");return}await navigator.clipboard.writeText(S.value),M.ElMessage.success("Version information copied to clipboard!")}catch(r){console.error("Failed to copy version info:",r),M.ElMessage.error("Failed to copy version info")}},Ue=async()=>{if(!b.value){b.value=!0;try{const r=Date.now(),o=await fetch(`/version.json?t=${r}`);if(!o.ok)throw new Error("Failed to fetch version info");const n=o.headers.get("content-type");if(!n||!n.includes("application/json")){console.warn("Version check skipped: version.json not properly configured");return}const l=await o.json();$.value=l.fullCommitHash,S.value!==$.value&&(U.value||(U.value=!0,console.log("Version mismatch detected:",{currentVersion:S.value,latestVersion:$.value,serverBuildTime:l.buildTime})))}catch(r){console.error("Error checking for updates:",r)}finally{b.value=!1}}},Co=()=>{q.value=setInterval(()=>{Ue(),Re()},5*60*1e3)},Vo=()=>{console.log("User reloaded for update:",{currentVersion:S.value,latestVersion:$.value}),window.location.reload()},$e=()=>{U.value=!1,console.log("Update alert dismissed:",{currentVersion:S.value,latestVersion:$.value})};return e.onUnmounted(()=>{q.value&&clearInterval(q.value)}),(r,o)=>{const n=e.resolveComponent("el-icon"),l=e.resolveComponent("el-button"),x=e.resolveComponent("el-tag"),W=e.resolveComponent("el-dropdown-item"),Y=e.resolveComponent("el-dropdown-menu"),j=e.resolveComponent("el-dropdown"),le=e.resolveComponent("el-dialog"),No=e.resolveComponent("el-alert");return e.openBlock(),e.createElementBlock(e.Fragment,null,[e.createElementVNode("header",It,[!I.value&&A.value<ce||e.unref(y)?(e.openBlock(),e.createElementBlock("div",xt,[o[13]||(o[13]=e.createStaticVNode('<div class="header-left" data-v-d2716831><div class="logo-section" data-v-d2716831><a href="/" class="logo" data-v-d2716831><div class="text-logo" data-v-d2716831><span class="logo-text" data-v-d2716831>AI Workspace</span></div></a></div></div>',1)),e.createElementVNode("div",Rt,[e.createElementVNode("span",Lt,[e.unref(y)?(e.openBlock(),e.createElementBlock("span",Tt,"Syncing authentication...")):(e.openBlock(),e.createElementBlock("span",Mt,"Initializing..."))])])])):!I.value&&A.value>=ce?(e.openBlock(),e.createElementBlock("div",Bt,[o[15]||(o[15]=e.createStaticVNode('<div class="header-left" data-v-d2716831><div class="logo-section" data-v-d2716831><a href="/" class="logo" data-v-d2716831><div class="text-logo" data-v-d2716831><span class="logo-text" data-v-d2716831>AI Workspace</span></div></a></div></div>',1)),e.createElementVNode("div",{class:"header-center"},[o[14]||(o[14]=e.createElementVNode("span",{class:"fallback-text"},"Header Ready (Fallback Mode)",-1)),e.createElementVNode("button",{onClick:wo,class:"retry-button"},"Retry Pinia")]),o[16]||(o[16]=e.createStaticVNode('<div class="header-right" data-v-d2716831><div class="user-profile" data-v-d2716831><div class="user-info" data-v-d2716831><span class="user-name" data-v-d2716831>User</span></div><div class="user-avatar" data-v-d2716831><span class="avatar-placeholder" data-v-d2716831>U</span></div></div></div>',1))])):F.value&&!e.unref(N)?(e.openBlock(),e.createElementBlock("div",Ht,[o[19]||(o[19]=e.createStaticVNode('<div class="header-left" data-v-d2716831><div class="logo-section" data-v-d2716831><a href="/" class="logo" data-v-d2716831><div class="text-logo" data-v-d2716831><span class="logo-text" data-v-d2716831>AI Workspace</span></div></a></div></div>',1)),e.createElementVNode("div",Dt,[e.createElementVNode("span",Ut,[e.createVNode(n,null,{default:e.withCtx(()=>[e.createVNode(e.unref(Ge))]),_:1}),o[17]||(o[17]=e.createTextVNode(" Session expired - Please log in again ",-1))])]),e.createElementVNode("div",$t,[e.createVNode(l,{type:"primary",onClick:o[0]||(o[0]=C=>V.value=!0)},{default:e.withCtx(()=>[e.createVNode(n,null,{default:e.withCtx(()=>[e.createVNode(e.unref(Se))]),_:1}),o[18]||(o[18]=e.createTextVNode(" Log In ",-1))]),_:1})])])):F.value&&e.unref(N)?(e.openBlock(),e.createElementBlock("div",Ot,[e.createElementVNode("div",Pt,[e.createElementVNode("div",Wt,[e.createElementVNode("a",Gt,[t.customLogo?(e.openBlock(),e.createElementBlock("img",{key:0,src:t.customLogo,alt:"AIWorkspace",class:"logo-image"},null,8,Ft)):(e.openBlock(),e.createElementBlock("div",Kt,[...o[20]||(o[20]=[e.createElementVNode("span",{class:"logo-text"},"AI Workspace",-1)])]))])])]),t.showSecondaryNavigation?(e.openBlock(),e.createElementBlock("div",zt,[e.createElementVNode("nav",jt,[ie.value?(e.openBlock(),e.createBlock(j,{key:0,onCommand:lo,trigger:"hover"},{dropdown:e.withCtx(()=>[e.createVNode(Y,{class:"workspace-tree-dropdown"},{default:e.withCtx(()=>[e.createVNode(W,{command:"all-workspace",class:e.normalizeClass({active:P.value})},{default:e.withCtx(()=>[e.createElementVNode("a",qt,[e.createElementVNode("div",Jt,[o[22]||(o[22]=e.createElementVNode("span",{class:"workspace-icon"},"ðŸŒ",-1)),o[23]||(o[23]=e.createElementVNode("span",null,"All workspace",-1)),P.value?(e.openBlock(),e.createBlock(x,{key:0,size:"small",type:"success"},{default:e.withCtx(()=>[...o[21]||(o[21]=[e.createTextVNode("Current",-1)])]),_:1})):e.createCommentVNode("",!0)])])]),_:1},8,["class"]),B.value.length>0?(e.openBlock(),e.createBlock(W,{key:0,divided:"",disabled:""})):e.createCommentVNode("",!0),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(B.value,C=>(e.openBlock(),e.createBlock(W,{key:C.id,command:`workspace-${C.id}`},{default:e.withCtx(()=>{var ae;return[e.createElementVNode("a",{href:`https://single-ws-dashboard.aiworkspace.pro/single-workspace/${C.id}/dashboard`,class:"nav-link"},[e.createElementVNode("div",{class:"workspace-dropdown-item",style:e.normalizeStyle({paddingLeft:(C.level||0)*16+"px"})},[e.createElementVNode("span",Qt,e.toDisplayString(C.children&&C.children.length?"ðŸ“":"ðŸ“„"),1),e.createElementVNode("span",null,e.toDisplayString(C.title),1),C.id===((ae=X.value)==null?void 0:ae.id)?(e.openBlock(),e.createBlock(x,{key:0,size:"small",type:"success"},{default:e.withCtx(()=>[...o[24]||(o[24]=[e.createTextVNode("Current",-1)])]),_:1})):e.createCommentVNode("",!0)],4)],8,Xt)]}),_:2},1032,["command"]))),128)),B.value.length===0?(e.openBlock(),e.createBlock(W,{key:1,disabled:""},{default:e.withCtx(()=>[...o[25]||(o[25]=[e.createTextVNode(" No workspaces ",-1)])]),_:1})):e.createCommentVNode("",!0)]),_:1})]),default:e.withCtx(()=>{var C;return[e.createElementVNode("span",Yt,[e.createTextVNode(e.toDisplayString(P.value?"All workspace":((C=X.value)==null?void 0:C.title)||"Select Workspace")+" ",1),e.createVNode(n,{class:"nav-arrow"},{default:e.withCtx(()=>[e.createVNode(e.unref(Pe))]),_:1})])]}),_:1})):e.createCommentVNode("",!0),ie.value?(e.openBlock(),e.createElementBlock("span",Zt,"/")):e.createCommentVNode("",!0),ie.value?(e.openBlock(),e.createBlock(j,{key:2,trigger:"hover"},{dropdown:e.withCtx(()=>[e.createVNode(Y,null,{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(Ve.value,C=>(e.openBlock(),e.createBlock(W,{key:C.label,class:e.normalizeClass({active:C.active})},{default:e.withCtx(()=>[e.createElementVNode("a",{href:uo(C),class:"nav-link",onClick:e.withModifiers(ae=>co(C),["prevent"])},e.toDisplayString(C.label),9,os)]),_:2},1032,["class"]))),128))]),_:1})]),default:e.withCtx(()=>[e.createElementVNode("span",es,[e.createTextVNode(e.toDisplayString(no.value)+" ",1),e.createVNode(n,{class:"nav-arrow"},{default:e.withCtx(()=>[e.createVNode(e.unref(Pe))]),_:1})])]),_:1})):e.createCommentVNode("",!0)]),!ie.value&&de.value?(e.openBlock(),e.createElementBlock("div",ts,[...o[26]||(o[26]=[e.createElementVNode("h1",null,"Team Worklogs",-1),e.createElementVNode("p",null,"View all team member work entries and progress updates",-1)])])):e.createCommentVNode("",!0),!ie.value&&Ne.value?(e.openBlock(),e.createElementBlock("div",ss,[...o[27]||(o[27]=[e.createElementVNode("h1",null,"Direct Reportee Management System",-1),e.createElementVNode("p",null,"Manage your direct reportees tasks and progress",-1)])])):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0),e.createElementVNode("div",as,[e.createVNode(j,{onCommand:oe,trigger:"click",placement:"bottom-end"},{dropdown:e.withCtx(()=>[e.createVNode(Y,null,{default:e.withCtx(()=>[e.createVNode(W,null,{default:e.withCtx(()=>[e.createElementVNode("a",{href:"/profile",class:"nav-link",onClick:o[1]||(o[1]=e.withModifiers(C=>oe("profile"),["prevent"]))},"Profile Settings")]),_:1}),t.showWorkspaceSelector?(e.openBlock(),e.createBlock(W,{key:0},{default:e.withCtx(()=>[e.createElementVNode("a",{href:"#switch-workspace",class:"nav-link",onClick:o[2]||(o[2]=e.withModifiers(C=>oe("workspaces"),["prevent"]))},"Switch Workspace")]),_:1})):e.createCommentVNode("",!0),de.value?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(W,{key:1},{default:e.withCtx(()=>[e.createElementVNode("a",{href:"https://worklog.aiworkspace.pro/worklogs",class:"nav-link",onClick:o[3]||(o[3]=e.withModifiers(C=>oe("worklogs"),["prevent"]))},"Worklogs")]),_:1})),e.createVNode(W,null,{default:e.withCtx(()=>[e.createElementVNode("a",{href:"https://drms.aiworkspace.pro/dashboard",class:"nav-link",onClick:o[4]||(o[4]=e.withModifiers(C=>oe("drms"),["prevent"]))},"Direct Reportee")]),_:1}),de.value?(e.openBlock(),e.createBlock(W,{key:2},{default:e.withCtx(()=>[e.createElementVNode("a",{href:"https://all-ws-dashboard.aiworkspace.pro/all-workspace/dashboard",class:"nav-link",onClick:o[5]||(o[5]=e.withModifiers(C=>oe("allworkspaces"),["prevent"]))},"All workspaces")]),_:1})):e.createCommentVNode("",!0),e.createVNode(W,{onClick:bo,class:"version-item"},{default:e.withCtx(()=>[e.createElementVNode("div",ds,[o[28]||(o[28]=e.createElementVNode("span",{class:"version-label"},"Version:",-1)),e.createElementVNode("span",ps,e.toDisplayString(D.value),1),e.createVNode(l,{size:"small",type:"text",onClick:e.withModifiers(Re,["stop"]),class:"refresh-button",loading:b.value},{default:e.withCtx(()=>[e.createVNode(n,null,{default:e.withCtx(()=>[e.createVNode(e.unref(_e))]),_:1})]),_:1},8,["loading"])])]),_:1}),e.createVNode(W,{divided:""},{default:e.withCtx(()=>[e.createElementVNode("a",{href:"#signout",class:"nav-link",onClick:o[6]||(o[6]=e.withModifiers(C=>oe("logout"),["prevent"]))},"Sign Out")]),_:1})]),_:1})]),default:e.withCtx(()=>[e.createElementVNode("div",rs,[e.createElementVNode("div",ns,[e.createElementVNode("span",is,e.toDisplayString(O.value.name),1)]),e.createElementVNode("div",ls,[O.value.avatar_url?(e.openBlock(),e.createElementBlock("img",{key:0,src:O.value.avatar_url,alt:O.value.name},null,8,cs)):(e.openBlock(),e.createElementBlock("span",us,e.toDisplayString(O.value.initials),1))])])]),_:1})])])):(e.openBlock(),e.createElementBlock("div",fs,[e.createElementVNode("div",gs,[e.createElementVNode("div",hs,[e.createElementVNode("a",ms,[t.customLogo?(e.openBlock(),e.createElementBlock("img",{key:0,src:t.customLogo,alt:"AIWorkspace",class:"logo-image"},null,8,ks)):(e.openBlock(),e.createElementBlock("div",ws,[...o[29]||(o[29]=[e.createElementVNode("span",{class:"logo-text"},"AI Workspace",-1)])]))])])]),o[31]||(o[31]=e.createElementVNode("div",{class:"header-center"},[e.createElementVNode("span",{class:"welcome-text"},"Welcome to AI Workspace")],-1)),Z.value?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("div",vs,[e.createVNode(l,{type:"primary",size:"large",class:"login-button",onClick:o[7]||(o[7]=C=>V.value=!0)},{default:e.withCtx(()=>[e.createVNode(n,null,{default:e.withCtx(()=>[e.createVNode(e.unref(Se))]),_:1}),o[30]||(o[30]=e.createTextVNode(" Login / Signup ",-1))]),_:1})]))])),F.value&&t.showWorkspaceSelector?(e.openBlock(),e.createBlock(le,{key:5,modelValue:k.value,"onUpdate:modelValue":o[9]||(o[9]=C=>k.value=C),title:"Switch Workspace",width:"500px",onClose:o[10]||(o[10]=C=>k.value=!1)},{footer:e.withCtx(()=>[e.createVNode(l,{onClick:o[8]||(o[8]=C=>k.value=!1)},{default:e.withCtx(()=>[...o[32]||(o[32]=[e.createTextVNode("Cancel",-1)])]),_:1}),e.createVNode(l,{type:"primary",onClick:po},{default:e.withCtx(()=>[...o[33]||(o[33]=[e.createTextVNode("Create New Workspace",-1)])]),_:1})]),default:e.withCtx(()=>[e.createElementVNode("div",_s,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(_.value,C=>{var ae,Oe;return e.openBlock(),e.createElementBlock("div",{key:C.id,class:e.normalizeClass(["workspace-item",{active:C.id===((ae=X.value)==null?void 0:ae.id)}]),onClick:Hs=>xe(C)},[e.createElementVNode("div",ys,e.toDisplayString(C.children&&C.children.length?"ðŸ“":"ðŸ“„"),1),e.createElementVNode("div",Es,[e.createElementVNode("h3",null,e.toDisplayString(C.title),1),e.createElementVNode("p",null,e.toDisplayString(C.description),1),e.createElementVNode("span",bs,e.toDisplayString(C.hasAccess?"Active":"Inactive"),1)]),C.id===((Oe=X.value)==null?void 0:Oe.id)?(e.openBlock(),e.createElementBlock("div",Cs,[e.createVNode(n,null,{default:e.withCtx(()=>[e.createVNode(e.unref(Oo))]),_:1})])):e.createCommentVNode("",!0)],10,Ss)}),128))])]),_:1},8,["modelValue"])):e.createCommentVNode("",!0),e.createVNode(eo,{modelValue:V.value,"onUpdate:modelValue":o[11]||(o[11]=C=>V.value=C),onLoginSuccess:go},null,8,["modelValue"]),e.createVNode(oo,{modelValue:w.value,"onUpdate:modelValue":o[12]||(o[12]=C=>w.value=C),"session-loss-event":e.unref(H),"can-retry-session":e.unref(p)||!1,onRetry:ho,onLogin:mo,onRefresh:ko},null,8,["modelValue","session-loss-event","can-retry-session"])]),U.value?(e.openBlock(),e.createBlock(No,{key:0,title:"New Version Available!",type:"warning",closable:!0,onClose:$e,"show-icon":"",class:"update-alert"},{default:e.withCtx(()=>[e.createElementVNode("div",Vs,[o[36]||(o[36]=e.createElementVNode("p",null,"A new version of the application is available. Please reload to get the latest updates and features.",-1)),e.createElementVNode("div",Ns,[e.createVNode(l,{type:"primary",size:"small",onClick:Vo},{default:e.withCtx(()=>[...o[34]||(o[34]=[e.createTextVNode(" Reload Now ",-1)])]),_:1}),e.createVNode(l,{size:"small",onClick:$e},{default:e.withCtx(()=>[...o[35]||(o[35]=[e.createTextVNode(" Dismiss ",-1)])]),_:1})])])]),_:1})):e.createCommentVNode("",!0)],64)}}});const to=ge(xs,[["__scopeId","data-v-d2716831"]]),Rs={class:"auth-callback"},Ls=e.defineComponent({__name:"AuthCallback",setup(t){e.onMounted(async()=>{console.log("[AuthCallback] Component mounted, starting callback processing..."),console.log("[AuthCallback] Current URL:",window.location.href),console.log("[AuthCallback] Current hash:",window.location.hash);try{await new Promise(u=>setTimeout(u,500));const{data:a,error:i}=await R.supabase.auth.getSession();if(i){console.error("Error processing callback:",i),s();return}if(a!=null&&a.session){const u=a.session.user;console.log("OAuth login successful:",u.email),a.session.access_token&&f.setSessionCookie(f.ACCESS_COOKIE,a.session.access_token),a.session.refresh_token&&f.setSessionCookie(f.REFRESH_COOKIE,a.session.refresh_token),f.syncCookiesToLocalStorage();const m=f.getPostLoginBase();console.log("[callback] Post-login redirect URL:",m),console.log("[callback] Session storage redirect:",sessionStorage.getItem("post-login-redirect")),console.log("[callback] Local storage redirect:",localStorage.getItem("post-login-redirect"));let y=m||"/";(y==="/auth/callback"||y.includes("/auth/callback"))&&(console.log("[callback] Avoiding redirect to /auth/callback, using /"),y="/"),console.log("[callback] Final redirect URL:",y),sessionStorage.removeItem("post-login-redirect"),localStorage.removeItem("post-login-redirect"),setTimeout(()=>{if(y.startsWith("/")){const H=window.location.origin,g=`${H}${y}`;console.log("[callback] redirecting to:",g,{hostname:window.location.hostname,origin:H}),window.location.href=g,setTimeout(()=>{window.location.pathname==="/auth/callback"&&(console.log("[callback] Redirect did not work, trying replace..."),window.location.replace(g))},500)}else console.log("[callback] redirecting to absolute URL:",y),window.location.href=y,setTimeout(()=>{window.location.pathname==="/auth/callback"&&(console.log("[callback] Redirect did not work, trying replace..."),window.location.replace(y))},500)},100)}else s()}catch(a){console.error("Error processing callback:",a),s()}});const s=()=>{const i=window.location.href.replace("/auth/callback","");window.location.href=i};return(a,i)=>(e.openBlock(),e.createElementBlock("div",Rs,[...i[0]||(i[0]=[e.createElementVNode("div",{class:"callback-container"},[e.createElementVNode("div",{class:"loading-spinner"},[e.createElementVNode("div",{class:"spinner"})]),e.createElementVNode("h2",null,"Processing login..."),e.createElementVNode("p",null,"Please wait while we complete your authentication.")],-1)])]))}});const Ts=ge(Ls,[["__scopeId","data-v-4857b2b4"]]),te=class te{constructor(){re(this,"validationCache",new Map);re(this,"CACHE_DURATION",Ce().validationCacheDuration)}getCookieValue(s){var u;if(typeof document>"u")return null;const i=`; ${document.cookie}`.split(`; ${s}=`);return i.length===2&&((u=i.pop())==null?void 0:u.split(";").shift())||null}static getInstance(){return te.instance||(te.instance=new te),te.instance}async validateSession(s=!1){var i,u;const a="session_validation";if(!s){const m=this.validationCache.get(a);if(m&&Date.now()-m.timestamp<this.CACHE_DURATION)return console.log("[SessionValidator] Using cached validation result"),m.result}console.log("[SessionValidator] Validating session...");try{const m=this.getCookieValue("sb-access-token"),y=this.getCookieValue("sb-refresh-token");if(!m||!y){const v={isValid:!1,needsLogin:!0,error:"No authentication tokens found",canRetry:!1};return this.cacheResult(a,v),v}const N=await R.getSupabase();let H=null,g=null;for(let v=1;v<=2;v++)try{const h=await N.auth.getSession();H=h.data.session,g=h.error;break}catch(h){if(console.warn(`[SessionValidator] Network error on attempt ${v}:`,h),v===2){const I={isValid:!1,needsLogin:!1,error:"Network error during validation",canRetry:!0};return this.cacheResult(a,I),I}await new Promise(I=>setTimeout(I,1e3))}if(g){console.warn("[SessionValidator] Error getting session:",g);const h={isValid:!1,needsLogin:((i=g.message)==null?void 0:i.includes("Invalid JWT"))||((u=g.message)==null?void 0:u.includes("JWT expired")),error:`Session error: ${g.message}`,canRetry:!0};return this.cacheResult(a,h),h}if(!H||!H.user){const v={isValid:!1,needsLogin:!0,error:"No valid session found",canRetry:!0};return this.cacheResult(a,v),v}const p=new Date,c=new Date(H.expires_at*1e3),d=5*60*1e3;if(p>=new Date(c.getTime()-d)){const v={isValid:!1,needsLogin:!0,error:"Session is close to expiry or expired",canRetry:!0};return this.cacheResult(a,v),v}const L={isValid:!0,needsLogin:!1,canRetry:!1};return this.cacheResult(a,L),L}catch(m){console.error("[SessionValidator] Error validating session:",m);const y={isValid:!1,needsLogin:!1,error:`Validation error: ${m}`,canRetry:!0};return this.cacheResult(a,y),y}}async restoreSession(){console.log("[SessionValidator] Attempting to restore session...");try{const s=this.getCookieValue("sb-access-token"),a=this.getCookieValue("sb-refresh-token");if(!s||!a)return{isValid:!1,needsLogin:!0,error:"No tokens available for restoration",canRetry:!1};const i=await R.getSupabase(),{data:u,error:m}=await i.auth.setSession({access_token:s,refresh_token:a});return m?(console.warn("[SessionValidator] Error restoring session:",m),{isValid:!1,needsLogin:!0,error:`Restoration error: ${m.message}`,canRetry:!0}):u.session&&u.session.user?(console.log("[SessionValidator] Session restored successfully"),this.clearCache(),{isValid:!0,needsLogin:!1,canRetry:!1}):{isValid:!1,needsLogin:!0,error:"Session restoration failed",canRetry:!0}}catch(s){return console.error("[SessionValidator] Error restoring session:",s),{isValid:!1,needsLogin:!0,error:`Restoration error: ${s}`,canRetry:!0}}}clearCache(){this.validationCache.clear(),console.log("[SessionValidator] Cache cleared")}cacheResult(s,a){this.validationCache.set(s,{result:a,timestamp:Date.now()})}getCachedResult(){const s=this.validationCache.get("session_validation");return s&&Date.now()-s.timestamp<this.CACHE_DURATION?s.result:null}};re(te,"instance");let pe=te;const he=pe.getInstance(),so=(t=!1)=>he.validateSession(t),ao=()=>he.restoreSession(),ro=()=>he.clearCache();async function Ms(){console.log("[SessionValidator] Initializing session validation...");let t=await so();return!t.isValid&&t.canRetry&&(console.log("[SessionValidator] Attempting session restoration..."),t=await ao()),t}function Bs(){if(typeof window>"u")return()=>{};const t=()=>{console.log("[SessionValidator] Network restored, clearing cache for revalidation"),ro()},s=()=>{console.log("[SessionValidator] Network lost, session validation may fail")};return window.addEventListener("online",t),window.addEventListener("offline",s),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",s)}}exports.configureSupabase=R.configureSupabase;exports.getAuthReadyResult=R.getAuthReadyResult;exports.getSupabase=R.getSupabase;exports.handleDomainChangeAuth=R.handleDomainChangeAuth;exports.initializeCrossSubdomainAuth=R.initializeCrossSubdomainAuth;exports.isAuthReadySync=R.isAuthReadySync;exports.restoreCrossSubdomainSession=R.restoreCrossSubdomainSession;exports.restoreSessionWithRetry=R.restoreSessionWithRetry;exports.setupAuthStateListener=R.setupAuthStateListener;exports.setupImmediateCrossSubdomainAuth=R.setupImmediateCrossSubdomainAuth;Object.defineProperty(exports,"supabase",{enumerable:!0,get:()=>R.supabase});exports.waitForAuthReady=R.waitForAuthReady;exports.ACCESS_COOKIE=f.ACCESS_COOKIE;exports.AUTH_BROADCAST_CHANNEL=f.AUTH_BROADCAST_CHANNEL;exports.AUTH_BROADCAST_KEY=f.AUTH_BROADCAST_KEY;exports.LS_ACCESS_KEY=f.LS_ACCESS_KEY;exports.LS_REFRESH_KEY=f.LS_REFRESH_KEY;exports.REFRESH_COOKIE=f.REFRESH_COOKIE;exports.broadcastAuthState=f.broadcastAuthState;exports.buildOAuthRedirectUrl=f.buildOAuthRedirectUrl;exports.clearLocalStorageTokens=f.clearLocalStorageTokens;exports.clearSessionCookie=f.clearSessionCookie;exports.ensureCrossSubdomainCookies=f.ensureCrossSubdomainCookies;exports.getCookie=f.getCookie;exports.getPostLoginBase=f.getPostLoginBase;exports.listenForAuthBroadcasts=f.listenForAuthBroadcasts;exports.setSessionCookie=f.setSessionCookie;exports.syncCookiesAndBroadcast=f.syncCookiesAndBroadcast;exports.syncCookiesToLocalStorage=f.syncCookiesToLocalStorage;exports.setupUniversalCallback=Do.setupUniversalCallback;exports.AIWorkspaceHeader=to;exports.AuthCallback=Ts;exports.LoginModal=eo;exports.PackageError=ue;exports.SessionLossModal=oo;exports.SessionValidator=pe;exports.clearGitHubTokenCache=Qe;exports.clearSessionCache=ro;exports.configureGitHub=it;exports.conservativeConfig=Ye;exports.createSessionConfig=ot;exports.debugDatabaseConnection=ut;exports.default=to;exports.defaultSessionConfig=ee;exports.detectionScenarios=at;exports.developmentConfig=Ee;exports.fastDetectionConfig=je;exports.getConfigByPreset=tt;exports.getGitHubToken=fe;exports.getSessionConfig=Ce;exports.handleBundlingError=Fe;exports.initializeSessionValidation=Ms;exports.isGitHubConfigured=lt;exports.productionConfig=be;exports.refreshGitHubToken=ct;exports.restoreSession=ao;exports.safeExecute=jo;exports.safeExecuteAsync=Yo;exports.safeGetCookie=Jo;exports.safeGetLocalStorage=Qo;exports.safeImport=qo;exports.safeSetCookie=Xo;exports.safeSetLocalStorage=Zo;exports.safeWindowOperation=et;exports.sessionConfigPresets=qe;exports.sessionValidator=he;exports.setupGlobalErrorHandler=Ke;exports.setupNetworkAwareValidation=Bs;exports.timingInfo=st;exports.useAuth=Ze;exports.useEnhancedAuth=ze;exports.useSessionMonitor=Je;exports.useWorkspaceStore=Xe;exports.validateSession=so;
