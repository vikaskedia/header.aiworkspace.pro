"use strict";var A=Object.create;var d=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var k=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var y=(e,o,n,t)=>{if(o&&typeof o=="object"||typeof o=="function")for(let a of _(o))!m.call(e,a)&&a!==n&&d(e,a,{get:()=>o[a],enumerable:!(t=O(o,a))||t.enumerable});return e};var w=(e,o,n)=>(n=e!=null?A(k(e)):{},y(o||!e||!e.__esModule?d(n,"default",{value:e,enumerable:!0}):n,e));const s=require("./utils/authRedirect.js");async function R(){try{console.log("[auth][init] Starting cross-subdomain authentication initialization..."),s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE]),C();const e=await b(2,100);return e.success?(console.log("[auth][init] Cross-subdomain authentication initialized successfully"),{success:!0,session:e.session}):(console.log("[auth][init] Cross-subdomain authentication initialization completed (no active session)"),{success:!1,error:e.error})}catch(e){return console.error("[auth][init] Error during cross-subdomain authentication initialization:",e),{success:!1,error:e}}}async function N(){try{s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE]);const e=s.getCookie(s.ACCESS_COOKIE),o=s.getCookie(s.REFRESH_COOKIE);if(e&&o){const n=await u(),{data:{session:t}}=await n.auth.getSession();if(!t){const{data:a,error:c}=await n.auth.setSession({access_token:e,refresh_token:o});c?console.log("[auth][restore] error",c):console.log("[auth][restore] done",!!a.session)}}else console.log("[auth][restore] no cookies present");s.syncCookiesToLocalStorage()}catch(e){console.log("[auth][restore] exception",e)}}let g=!1;async function C(){if(g){console.log("[auth][listener] Auth state listener already set up, skipping...");return}console.log("[auth][listener] Setting up auth state listener...");try{(await u()).auth.onAuthStateChange(async(o,n)=>{switch(console.log("[auth][listener] Auth state changed:",o,!!n),o){case"TOKEN_REFRESHED":console.log("[auth][listener] Token refreshed successfully"),n&&(s.setSessionCookie(s.ACCESS_COOKIE,n.access_token,60*60*24*365),s.setSessionCookie(s.REFRESH_COOKIE,n.refresh_token,60*60*24*365),s.syncCookiesToLocalStorage());break;case"SIGNED_IN":console.log("[auth][listener] User signed in"),n&&(s.setSessionCookie(s.ACCESS_COOKIE,n.access_token,60*60*24*365),s.setSessionCookie(s.REFRESH_COOKIE,n.refresh_token,60*60*24*365),s.syncCookiesToLocalStorage());break;case"SIGNED_OUT":console.log("[auth][listener] User signed out");break;case"USER_UPDATED":console.log("[auth][listener] User updated");break;default:console.log("[auth][listener] Unhandled auth event:",o)}}),g=!0,console.log("[auth][listener] Auth state listener set up successfully")}catch(e){console.warn("[auth][listener] Failed to setup auth state listener:",e)}}async function b(e=3,o=200){var n;for(let t=1;t<=e;t++)try{console.log(`[auth][restore] Attempt ${t}/${e}`);let a=null;try{const i=await(await u()).auth.getSession();a=(n=i==null?void 0:i.data)==null?void 0:n.session}catch(r){console.warn("[auth][restore] Error getting Supabase session:",r)}if(a&&a.user)return console.log("[auth][restore] Active session found"),{success:!0,session:a};t>1&&(console.log("[auth][restore] Re-syncing cross-subdomain cookies..."),s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE]),await new Promise(r=>setTimeout(r,o*t)));const c=s.getCookie(s.ACCESS_COOKIE),p=s.getCookie(s.REFRESH_COOKIE);if(console.log(`[auth][restore] Cookie check - Access: ${!!c}, Refresh: ${!!p}`),c&&p){console.log("[auth][restore] Attempting to restore session from cookies...");try{const r=await u(),{data:i,error:E}=await r.auth.setSession({access_token:c,refresh_token:p});if(E){if(console.log(`[auth][restore] Attempt ${t} failed:`,E.message),t===e)return{success:!1,error:E};continue}if(i.session)return console.log("[auth][restore] Session restored successfully"),s.setSessionCookie(s.ACCESS_COOKIE,i.session.access_token,60*60*24*365),s.setSessionCookie(s.REFRESH_COOKIE,i.session.refresh_token,60*60*24*365),s.syncCookiesToLocalStorage(),{success:!0,session:i.session}}catch(r){if(console.warn(`[auth][restore] setSession error on attempt ${t}:`,r),t===e)return{success:!1,error:r};continue}}else if(console.log(`[auth][restore] Attempt ${t} - No cookies found`),t===e)return{success:!1,error:"No valid session or cookies"};t<e&&await new Promise(r=>setTimeout(r,o*t))}catch(a){if(console.log(`[auth][restore] Attempt ${t} exception:`,a),t===e)return{success:!1,error:a}}return console.log("[auth][restore] All attempts failed"),{success:!1,error:"All restoration attempts failed"}}async function f(){var e;try{const{createClient:o}=await import("@supabase/supabase-js");return o}catch(o){return console.warn("[Supabase] Failed to import @supabase/supabase-js:",o),typeof window<"u"&&((e=window.supabase)!=null&&e.createClient)?window.supabase.createClient:(console.error("[Supabase] No Supabase client available, using mock"),()=>({auth:{getSession:()=>Promise.resolve({data:{session:null},error:null}),setSession:()=>Promise.resolve({data:{session:null},error:null}),signOut:()=>Promise.resolve({error:null}),onAuthStateChange:()=>({data:{subscription:{unsubscribe:()=>{}}}})}}))}}const S="https://oqdnbpmmgntqtigstaow.supabase.co",h="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xZG5icG1tZ250cXRpZ3N0YW93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ0NTk2NDYsImV4cCI6MjA1MDAzNTY0Nn0.rn0nRY9xLgLt-ajiSPeG0PcdS9V-549C1yeqhcxxG40";exports.supabase=null;let l=null;async function I(){return l||(l=(async()=>{try{const e=await f();return S&&h&&(exports.supabase=e(S,h,{db:{schema:"public"},auth:{storageKey:"sb-auth-token-shared",storage:typeof window<"u"?localStorage:void 0,autoRefreshToken:!0,persistSession:!0}}),console.log("[Supabase] Client initialized successfully")),exports.supabase}catch(e){console.error("[Supabase] Failed to initialize client:",e);const o=await f();return exports.supabase=o("https://placeholder.supabase.co","placeholder-key"),exports.supabase}})(),l)}I();const u=async()=>(exports.supabase||await I(),exports.supabase);typeof window<"u"&&(s.ensureCrossSubdomainCookies([s.ACCESS_COOKIE,s.REFRESH_COOKIE]),C().catch(e=>{console.warn("[Supabase] Error setting up auth state listener:",e)}));console.log("Supabase Configuration:",{url:S,hasKey:!!h,autoRefreshToken:!0,persistSession:!0});console.log("URL:",S.replace(/https:\/\/(.+)\.supabase\.co/,"https://*****.supabase.co"));console.log("Key configured:",!h.includes("your-anon-key"));console.log("Environment mode:","production");exports.getSupabase=u;exports.initializeCrossSubdomainAuth=R;exports.restoreCrossSubdomainSession=N;exports.restoreSessionWithRetry=b;exports.setupAuthStateListener=C;
